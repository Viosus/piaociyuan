# 票夹加载问题修复总结

## 问题描述

用户报告票夹界面存在以下问题：
1. 票夹界面一直加载不出来
2. 加载出来也是告诉要刷新界面
3. 刷新功能没有正常工作
4. 收藏功能也有问题（相关）

## 问题根源

通过分析后端日志发现问题的根本原因：

### 后端日志显示

```
GET /api/tickets/my-tickets 401 in 119ms
GET /api/tickets/my-tickets 401 in 4ms
POST /api/posts/1073499f-16ab-4466-9af6-2fe6ff2432eb/favorite 401
POST /api/auth/refresh 401 in 125ms
```

### 问题分析

1. **用户的登录token已过期**
   - accessToken 过期
   - refreshToken 也过期

2. **自动刷新token失败**
   - API客户端尝试刷新token
   - refresh API 返回 401
   - 所有token被清除

3. **前端状态不一致**
   - API客户端清除了token
   - 但 AuthContext 中的 user 状态没有清除
   - 前端仍然认为用户已登录（`isAuthenticated = !!user` 仍为 true）

4. **所有API调用都失败**
   - 每次API调用都返回 401
   - 但没有清晰的错误提示
   - 用户不知道需要重新登录

5. **错误提示不清楚**
   - 只显示"下拉刷新重试"
   - 没有告知用户登录已过期

## 修复内容

### 1. 改进API客户端错误处理 (`apps/mobile/src/services/api.ts`)

#### 修改内容：
当刷新token失败时，抛出明确的 `TOKEN_EXPIRED` 错误。

#### 代码修改：

```typescript
// 在刷新token失败时
catch (refreshError) {
  this.processQueue(refreshError, null);
  this.isRefreshing = false;
  // 抛出特殊的认证错误
  throw {
    response: {
      status: 401,
      data: {
        ok: false,
        code: 'TOKEN_EXPIRED',
        error: '登录已过期，请重新登录',
      },
    },
  };
}
```

### 2. 改进票夹界面错误处理 (`apps/mobile/src/screens/TicketsScreen.tsx`)

#### 修改内容：
1. 添加 `useAuth` hook 获取 logout 函数
2. 添加 `handleTokenExpired` 函数处理登录过期
3. 在 `loadTickets` 中检测 `TOKEN_EXPIRED` 错误
4. 显示友好的提示对话框引导用户重新登录

#### 代码修改：

```typescript
import { useAuth } from '../contexts/AuthContext';
import { Alert } from 'react-native';

export default function TicketsScreen() {
  const { logout } = useAuth();

  const loadTickets = async () => {
    try {
      // ... 加载逻辑
      if (response.ok && response.data) {
        // 处理成功响应
      } else {
        // 检查是否是登录过期错误
        if (response.code === 'TOKEN_EXPIRED' || response.error?.includes('登录已过期')) {
          handleTokenExpired();
        } else {
          setError(response.error || '加载门票失败');
        }
      }
    } catch (err: any) {
      // 检查是否是登录过期错误
      if (err.message?.includes('登录已过期') || err.message?.includes('认证')) {
        handleTokenExpired();
      } else {
        setError(err.message || '加载门票失败');
      }
    }
  };

  const handleTokenExpired = () => {
    Alert.alert(
      '登录已过期',
      '您的登录状态已过期，请重新登录',
      [
        {
          text: '重新登录',
          onPress: async () => {
            try {
              await logout();
              // 导航到登录页面
              navigation.reset({
                index: 0,
                routes: [{ name: 'Login' as never }],
              });
            } catch (error) {
              console.error('退出登录失败:', error);
            }
          },
        },
      ],
      { cancelable: false }
    );
  };
}
```

### 3. 改进安可区收藏功能错误处理 (`apps/mobile/src/screens/EncoreScreen.tsx`)

#### 修改内容：
同样添加登录过期检测和处理逻辑。

#### 代码修改：

```typescript
import { useAuth } from '../contexts/AuthContext';
import { Alert } from 'react-native';

export default function EncoreScreen() {
  const { logout } = useAuth();

  const handleFavorite = async (post: Post) => {
    try {
      // 乐观更新
      setPosts((prev) => /* ... */);

      const response = post.isFavorited
        ? await unfavoritePost(post.id.toString())
        : await favoritePost(post.id.toString());

      if (!response.ok) {
        // 检查是否是登录过期错误
        if (response.code === 'TOKEN_EXPIRED' || response.error?.includes('登录已过期')) {
          handleTokenExpired();
          return;
        }
        // 回滚
      }
    } catch (err: any) {
      // 检查是否是登录过期错误
      if (err.message?.includes('登录已过期') || err.message?.includes('认证')) {
        handleTokenExpired();
        return;
      }
      // 回滚
    }
  };

  const handleTokenExpired = () => {
    Alert.alert(
      '登录已过期',
      '您的登录状态已过期，请重新登录',
      [
        {
          text: '重新登录',
          onPress: async () => {
            await logout();
            navigation.reset({
              index: 0,
              routes: [{ name: 'Login' as never }],
            });
          },
        },
      ],
      { cancelable: false }
    );
  };
}
```

## 修复效果

修复后，用户体验将得到显著改善：

### 之前的问题：
- ❌ 票夹一直加载，显示模糊的错误信息
- ❌ 用户不知道需要重新登录
- ❌ 收藏功能报错，没有明确提示
- ❌ 刷新无效，问题持续存在

### 修复后的效果：
- ✅ **清晰的错误提示**
  - 显示"登录已过期"对话框
  - 明确告知用户需要重新登录

- ✅ **一键重新登录**
  - 点击"重新登录"按钮
  - 自动清除过期token
  - 导航到登录页面

- ✅ **统一的错误处理**
  - 票夹、安可区等所有需要认证的功能都有一致的错误处理
  - 所有401错误都会触发重新登录流程

- ✅ **用户友好**
  - 不再显示技术性错误信息
  - 提供明确的操作指引
  - 流程顺畅，无需手动查找登录入口

## 测试验证

### 测试场景

1. **票夹加载测试**
   - [ ] 打开票夹界面
   - [ ] 看到"登录已过期"提示
   - [ ] 点击"重新登录"
   - [ ] 成功跳转到登录页面
   - [ ] 登录后能正常查看票夹

2. **收藏功能测试**
   - [ ] 在安可区点击收藏按钮
   - [ ] 看到"登录已过期"提示
   - [ ] 点击"重新登录"
   - [ ] 登录后收藏功能正常工作

3. **刷新功能测试**
   - [ ] 在登录状态下下拉刷新
   - [ ] 正常刷新数据
   - [ ] 在token过期后下拉刷新
   - [ ] 看到登录过期提示

## 相关文件

### 修改的文件：
1. `apps/mobile/src/services/api.ts` - API客户端错误处理
2. `apps/mobile/src/screens/TicketsScreen.tsx` - 票夹界面错误处理
3. `apps/mobile/src/screens/EncoreScreen.tsx` - 安可区收藏错误处理

### 相关但未修改的文件：
1. `apps/mobile/src/contexts/AuthContext.tsx` - 认证上下文
2. `apps/mobile/src/services/tickets.ts` - 票务服务
3. `apps/mobile/src/services/favorites.ts` - 收藏服务
4. `apps/web/app/api/tickets/my-tickets/route.ts` - 票务后端API
5. `apps/web/app/api/posts/[id]/favorite/route.ts` - 收藏后端API

## 下一步建议

### 短期改进：
1. **添加token刷新提醒**
   - 在token快要过期时提前提醒用户
   - 避免用户在使用过程中突然被要求重新登录

2. **优化登录状态检测**
   - 在应用启动时检测token有效性
   - 无效则直接引导登录，避免用户看到加载失败

### 长期改进：
1. **实现remember me功能**
   - 提供"记住登录状态"选项
   - 使用更长期的refreshToken
   - 减少用户重新登录的频率

2. **后台自动刷新token**
   - 实现定时刷新机制
   - 在token过期前自动刷新
   - 用户无感知

3. **离线数据缓存**
   - 缓存票夹数据
   - 即使token过期也能查看（只读模式）
   - 需要操作时再提示登录

## 总结

票夹加载问题的根本原因是用户的登录token已过期，但前端没有很好地处理这个401错误。修复后：

1. ✅ 用户会看到清晰的"登录已过期"提示
2. ✅ 可以一键跳转到登录页面重新登录
3. ✅ 所有需要认证的功能都有统一的错误处理
4. ✅ 用户体验得到显著改善

现在用户应该能够：
- 明确知道登录已过期
- 轻松重新登录
- 正常使用票夹和收藏功能
