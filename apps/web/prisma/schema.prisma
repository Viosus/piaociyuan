// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ✅ 活动表
model Event {
  id        Int      @id @default(autoincrement())
  name      String
  city      String
  venue     String
  date      String
  time      String
  cover     String
  artist    String
  desc      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tiers     Tier[]
  nfts      NFT[]   // 该活动相关的NFT
  posts     Post[]
  followers EventFollow[]
  notifications Notification[]

  @@map("events")
}

// ✅ 票档表
model Tier {
  id        Int      @id @default(autoincrement())
  eventId   Int
  name      String
  price     Int
  capacity  Int
  remaining Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("tiers")
  @@index([eventId])
}

// ✅ 锁票表
model Hold {
  id        String   @id
  eventId   String
  tierId    String
  qty       Int
  expireAt  BigInt
  createdAt BigInt

  @@map("holds")
  @@index([eventId, tierId])
  @@index([expireAt])
}

// ✅ 订单表
model Order {
  id        String   @id
  userId    String
  eventId   String
  tierId    String
  qty       Int
  holdId    String
  status    String
  createdAt BigInt
  paidAt    BigInt?

  user      User     @relation(fields: [userId], references: [id], onDelete: Restrict)
  tickets   Ticket[]

  @@map("orders")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ✅ 票表（增加NFT绑定）
model Ticket {
  id          String   @id @default(uuid())
  ticketCode  String   @unique
  seatNumber  String?
  eventId     Int
  tierId      Int
  holdId      String?
  orderId     String?
  userId      String?
  status      String
  price       Int

  purchasedAt DateTime?
  usedAt      DateTime?
  refundedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // ============ NFT绑定（新增）============
  nftId               String?  // 绑定的NFT ID（如3D票根NFT）
  nftMintStatus       String?  // 该票的NFT铸造状态 pending/minted/failed
  nftUserNftId        String?  // 对应的UserNFT记录ID

  // 关联
  order       Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  nft         NFT?     @relation(fields: [nftId], references: [id], onDelete: SetNull)

  @@map("tickets")
  @@index([eventId])
  @@index([tierId])
  @@index([holdId])
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([ticketCode])
  @@index([eventId, tierId, status, seatNumber])
  @@index([nftId])
  @@index([nftMintStatus])
}

// ✅ 用户表（扩展个人信息和钱包）
model User {
  id            String   @id @default(uuid())
  email         String?  @unique
  phone         String?  @unique
  password      String?
  nickname      String?
  avatar        String?

  // 第三方登录
  wechatOpenId  String?  @unique
  qqOpenId      String?  @unique
  authProvider  String   @default("local")

  // 用户角色
  role          String   @default("user")

  // ============ 个人信息扩展（新增）============
  bio                 String?  @db.Text // 个人简介
  coverImage          String?  // 个人主页封面图
  website             String?  // 个人网站
  location            String?  // 所在地

  // ============ 认证系统（新增）============
  isVerified          Boolean  @default(false)
  verifiedType        String?  // celebrity, artist, organizer, official
  verifiedAt          DateTime?
  verificationBadge   String?  // 认证徽章图标URL

  // ============ 钱包信息（修改）============
  walletAddress       String?  @unique
  walletProvider      String?  // metamask, imtoken, tokenpocket, bitkeep, etc.
  walletConnectedAt   DateTime?

  // ============ 统计字段（新增）============
  nftCount            Int      @default(0)
  followerCount       Int      @default(0)
  followingCount      Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // 关联
  orders        Order[]
  tickets       Ticket[]
  userNFTs      UserNFT[]   // 改为 userNFTs
  loginLogs     LoginLog[]
  sessions      UserSession[]

  // 社交
  posts         Post[]
  likes         PostLike[]
  comments      Comment[]
  sentMessages  Message[]      @relation("SentMessages")
  receivedMessages Message[]   @relation("ReceivedMessages")
  conversations ConversationParticipant[]

  // 关注
  followedEvents EventFollow[]
  notifications  Notification[]

  // 用户关注关系
  followers      UserFollow[]   @relation("UserFollowers")  // 关注我的人
  following      UserFollow[]   @relation("UserFollowing")  // 我关注的人

  // NFT
  nftMintQueue   NFTMintQueue[]

  @@map("users")
  @@index([email])
  @@index([phone])
  @@index([wechatOpenId])
  @@index([qqOpenId])
  @@index([walletAddress])
}

// ✅ 登录日志表
model LoginLog {
  id         String   @id @default(uuid())
  userId     String
  ipAddress  String?
  userAgent  String?
  location   String?
  success    Boolean  @default(true)
  failReason String?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_logs")
  @@index([userId])
  @@index([createdAt])
  @@index([success])
}

// ✅ 用户会话表
model UserSession {
  id            String   @id @default(uuid())
  userId        String
  refreshToken  String   @unique
  deviceInfo    String?
  ipAddress     String?
  expiresAt     DateTime
  revoked       Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
  @@index([userId])
  @@index([expiresAt])
  @@index([refreshToken])
}

// ✅ 验证码表
model VerificationCode {
  id        String   @id @default(uuid())
  email     String
  code      String
  type      String   @default("register")
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("verification_codes")
  @@index([email, type])
  @@index([expiresAt])
}

// ✅ NFT表（原Badge表重构）
model NFT {
  id                  String   @id @default(uuid())
  name                String
  description         String   @db.Text
  imageUrl            String

  // ============ NFT分类 ============
  sourceType          String   // ticket_reward, standalone, airdrop
  category            String   // badge, ticket_stub, poster, certificate, art

  // ============ 关联信息 ============
  eventId             Int?
  tierId              Int?

  // ============ 经济模型 ============
  rarity              String   @default("common")
  price               Int?     // 独立售卖价格
  totalSupply         Int      // 总供应量
  mintedCount         Int      @default(0)

  // ============ 3D/AR 功能 ============
  has3DModel          Boolean  @default(false)
  model3DUrl          String?
  modelFormat         String?
  hasAR               Boolean  @default(false)
  arUrl               String?
  hasAnimation        Boolean  @default(false)
  animationUrl        String?
  modelConfig         String?  @db.Text

  // ============ 区块链信息 ============
  contractAddress     String?
  tokenIdStart        Int?
  metadataUriTemplate String?  @db.Text

  // ============ 状态控制 ============
  isActive            Boolean  @default(true)
  isMintable          Boolean  @default(true)
  isMarketable        Boolean  @default(false)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // 关联
  event               Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)
  userNFTs            UserNFT[]
  ticketsWithNFT      Ticket[]

  @@map("nfts")
  @@index([eventId])
  @@index([sourceType])
  @@index([category])
  @@index([rarity])
  @@index([isActive])
  @@index([isMintable])
}

// ✅ 用户NFT表（原UserBadge表重构）
model UserNFT {
  id                  String   @id @default(uuid())
  userId              String
  nftId               String

  // ============ 获得方式 ============
  sourceType          String   // ticket_purchase, direct_purchase, airdrop, transfer
  sourceId            String?  // 来源ID（订单ID、票ID、交易哈希等）

  // ============ 区块链唯一标识 ============
  contractAddress     String   // 合约地址
  tokenId             Int      // Token ID
  metadataUri         String?  @db.Text

  // ============ 所有权信息 ============
  ownerWalletAddress  String   // 当前链上所有者
  isOnChain           Boolean  @default(false)

  // ============ 铸造信息 ============
  mintStatus          String   @default("pending")
  mintTransactionHash String?
  mintedAt            DateTime?
  mintError           String?  @db.Text

  // ============ 转移信息 ============
  isTransferred       Boolean  @default(false)
  transferredTo       String?
  transferredAt       DateTime?

  // ============ 额外数据 ============
  metadata            String?  @db.Text // JSON格式

  obtainedAt          DateTime @default(now())
  lastSyncedAt        DateTime?

  // 关联
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  nft                 NFT      @relation(fields: [nftId], references: [id], onDelete: Restrict)

  @@map("user_nfts")
  @@unique([contractAddress, tokenId])
  @@index([userId])
  @@index([nftId])
  @@index([ownerWalletAddress])
  @@index([mintStatus])
  @@index([obtainedAt])
  @@index([sourceType])
}

// ==================== 社交系统 ====================

model Post {
  id          String   @id @default(uuid())
  userId      String
  content     String   @db.Text
  eventId     Int?
  location    String?
  viewCount   Int      @default(0)
  likeCount   Int      @default(0)
  commentCount Int     @default(0)
  isVisible   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  event       Event?     @relation(fields: [eventId], references: [id], onDelete: SetNull)
  images      PostImage[]
  likes       PostLike[]
  comments    Comment[]
  views       PostView[]

  @@map("posts")
  @@index([userId])
  @@index([eventId])
  @@index([createdAt])
  @@index([likeCount])
  @@index([isVisible])
}

model PostImage {
  id        String   @id @default(uuid())
  postId    String
  imageUrl  String
  width     Int?
  height    Int?
  order     Int      @default(0)
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("post_images")
  @@index([postId])
  @@index([order])
}

model PostLike {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("post_likes")
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}

model PostView {
  id        String   @id @default(uuid())
  postId    String
  userId    String?
  ipAddress String?
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("post_views")
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}

model Comment {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  content   String   @db.Text
  parentId  String?
  likeCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")

  @@map("comments")
  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
}

// ==================== 私聊系统 ====================

model Conversation {
  id          String   @id @default(uuid())
  lastMessageAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
  @@index([lastMessageAt])
}

model ConversationParticipant {
  id             String   @id @default(uuid())
  conversationId String
  userId         String
  unreadCount    Int      @default(0)
  lastReadAt     DateTime @default(now())
  joinedAt       DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("conversation_participants")
  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderId       String
  receiverId     String
  content        String   @db.Text
  messageType    String   @default("text")
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver       User         @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
  @@index([conversationId])
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@index([isRead])
}

// ==================== 关注系统 ====================

model EventFollow {
  id        String   @id @default(uuid())
  userId    String
  eventId   Int
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_follows")
  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  content   String   @db.Text
  eventId   Int?
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)

  @@map("notifications")
  @@index([userId])
  @@index([eventId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
}

// ==================== NFT系统 ====================

model NFTMintQueue {
  id            String   @id @default(uuid())
  userNftId     String   // 关联UserNFT
  userId        String
  walletAddress String
  status        String   @default("pending")
  retryCount    Int      @default(0)
  errorMessage  String?  @db.Text
  createdAt     DateTime @default(now())
  processedAt   DateTime?

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("nft_mint_queue")
  @@index([userNftId])
  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

model NFTTransaction {
  id                String   @id @default(uuid())
  transactionHash   String   @unique
  fromAddress       String?
  toAddress         String?
  tokenId           Int?
  contractAddress   String?
  transactionType   String
  blockNumber       BigInt?
  gasUsed           BigInt?
  gasPrice          BigInt?
  status            String
  createdAt         DateTime @default(now())
  confirmedAt       DateTime?

  @@map("nft_transactions")
  @@index([transactionHash])
  @@index([transactionType])
  @@index([toAddress])
  @@index([status])
}

model NFTConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String?  @db.Text
  description String?  @db.Text
  updatedAt   DateTime @default(now()) @updatedAt

  @@map("nft_config")
  @@index([key])
}

// ✅ 用户关注表
model UserFollow {
  id          String   @id @default(uuid())
  followerId  String   // 关注者ID
  followingId String   // 被关注者ID
  createdAt   DateTime @default(now())

  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("user_follows")
  @@index([followerId])
  @@index([followingId])
  @@index([createdAt])
}
