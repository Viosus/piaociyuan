# 票遇洲 - 阿里云部署指南

本文档详细介绍如何将票遇洲项目部署到阿里云 ECS 服务器。

## 目录

- [前置准备](#前置准备)
- [第一步：购买阿里云 ECS](#第一步购买阿里云-ecs)
- [第二步：配置安全组](#第二步配置安全组)
- [第三步：连接服务器](#第三步连接服务器)
- [第四步：上传代码](#第四步上传代码)
- [第五步：部署应用](#第五步部署应用)
- [第六步：配置域名和 SSL](#第六步配置域名和-ssl)
- [常用运维命令](#常用运维命令)
- [故障排查](#故障排查)

---

## 前置准备

### 项目已配置的 Docker 文件

| 文件 | 说明 |
|------|------|
| `apps/web/Dockerfile` | Web 应用 Docker 镜像配置 |
| `docker-compose.yml` | 服务编排（Web、PostgreSQL、Nginx、Redis） |
| `.dockerignore` | Docker 构建忽略文件 |
| `.env.example` | 环境变量模板 |
| `nginx/nginx.conf` | Nginx 主配置 |
| `nginx/conf.d/default.conf` | Nginx 站点配置（含 WebSocket 支持） |
| `deploy.sh` | 一键部署脚本 |

### 服务器配置要求

| 配置项 | 最低要求 | 推荐配置 |
|--------|----------|----------|
| CPU | 2 核 | 4 核 |
| 内存 | 4 GB | 8 GB |
| 硬盘 | 40 GB SSD | 100 GB SSD |
| 带宽 | 3 Mbps | 5 Mbps+ |
| 系统 | Ubuntu 20.04 | Ubuntu 22.04 |

---

## 第一步：购买阿里云 ECS

1. 登录 [阿里云控制台](https://www.aliyun.com/)
2. 进入 **云服务器 ECS** > **创建实例**
3. 选择配置：
   - **地域**：选择离用户最近的区域（如华东1-杭州）
   - **实例规格**：通用型 ecs.g6.large（2核4G）或更高
   - **镜像**：Ubuntu 22.04 64位
   - **存储**：ESSD 云盘 40GB+
   - **网络**：选择或创建 VPC
   - **公网 IP**：勾选分配公网 IP
   - **带宽**：按需选择

4. 设置登录密码或 SSH 密钥
5. 完成购买

---

## 第二步：配置安全组

在 ECS 控制台 > 安全组 中添加以下入方向规则：

| 端口 | 协议 | 来源 | 说明 |
|------|------|------|------|
| 22 | TCP | 0.0.0.0/0 | SSH 远程连接 |
| 80 | TCP | 0.0.0.0/0 | HTTP |
| 443 | TCP | 0.0.0.0/0 | HTTPS |
| 3000 | TCP | 0.0.0.0/0 | Next.js（调试用，生产可关闭） |

> ⚠️ 数据库端口 5432 和 Redis 端口 6379 **不要** 对外开放，仅内网访问

---

## 第三步：连接服务器

### Windows 用户（PowerShell 或 Git Bash）

```bash
ssh root@你的服务器公网IP
```

### 首次连接后更新系统

```bash
apt update && apt upgrade -y
```

---

## 第四步：上传代码

### 方式一：Git 克隆（推荐）

```bash
# 安装 Git
apt install -y git

# 克隆代码
cd /var/www
git clone https://github.com/你的用户名/piaoyuzhou.git
cd piaoyuzhou
```

### 方式二：本地打包上传

在本地项目目录执行：

```bash
# 打包代码（排除 node_modules）
git archive -o piaoyuzhou.tar.gz HEAD

# 上传到服务器
scp piaoyuzhou.tar.gz root@你的服务器IP:/var/www/

# 在服务器上解压
ssh root@你的服务器IP
cd /var/www
mkdir piaoyuzhou && cd piaoyuzhou
tar -xzf ../piaoyuzhou.tar.gz
```

---

## 第五步：部署应用

### 5.1 初始化环境

```bash
cd /var/www/piaoyuzhou

# 赋予部署脚本执行权限
chmod +x deploy.sh

# 初始化（安装 Docker、创建 .env 文件）
./deploy.sh init
```

### 5.2 配置环境变量

```bash
nano .env
```

需要修改的关键配置：

```env
# 数据库密码（请设置强密码）
POSTGRES_PASSWORD=你的数据库密码

# 应用 URL（替换为你的域名或 IP）
NEXT_PUBLIC_APP_URL=http://你的域名或IP

# JWT_SECRET 和 ENCRYPTION_KEY 已自动生成，无需修改
```

按 `Ctrl+X`，然后 `Y`，回车保存。

### 5.3 构建并启动

```bash
# 构建 Docker 镜像（首次需要 5-10 分钟）
./deploy.sh build

# 启动所有服务
./deploy.sh start

# 运行数据库迁移
./deploy.sh migrate

# 检查服务状态
docker-compose ps
```

### 5.4 验证部署

```bash
# 健康检查
curl http://localhost/health

# 或在浏览器访问
http://你的服务器IP
```

---

## 第六步：配置域名和 SSL

### 6.1 域名解析

在你的域名服务商处添加 A 记录：

| 主机记录 | 记录类型 | 记录值 |
|----------|----------|--------|
| @ | A | 你的服务器 IP |
| www | A | 你的服务器 IP |

### 6.2 申请 SSL 证书

```bash
# 使用部署脚本一键配置
./deploy.sh ssl your-domain.com
```

### 6.3 启用 HTTPS

编辑 Nginx 配置：

```bash
nano nginx/conf.d/default.conf
```

1. 找到 HTTP 重定向部分，取消注释：
```nginx
location / {
    return 301 https://$host$request_uri;
}
```

2. 找到 HTTPS 服务器部分，取消注释并修改域名：
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    # ... 其他配置
}
```

3. 重启 Nginx：
```bash
docker-compose restart nginx
```

---

## 常用运维命令

### 部署脚本命令

```bash
./deploy.sh init      # 初始化环境
./deploy.sh build     # 构建镜像
./deploy.sh start     # 启动服务
./deploy.sh stop      # 停止服务
./deploy.sh restart   # 重启服务
./deploy.sh logs      # 查看日志
./deploy.sh migrate   # 数据库迁移
./deploy.sh health    # 健康检查
./deploy.sh backup    # 备份数据库
./deploy.sh restore backup_xxx.sql  # 恢复数据库
./deploy.sh ssl domain.com  # 配置 SSL
./deploy.sh cleanup   # 清理 Docker 资源
```

### Docker 命令

```bash
# 查看容器状态
docker-compose ps

# 查看特定服务日志
docker-compose logs -f web      # Web 应用日志
docker-compose logs -f postgres # 数据库日志
docker-compose logs -f nginx    # Nginx 日志

# 进入容器
docker-compose exec web sh
docker-compose exec postgres psql -U postgres

# 重启单个服务
docker-compose restart web
```

### 数据库操作

```bash
# 进入数据库
docker-compose exec postgres psql -U postgres -d piaociyuan

# 备份
./deploy.sh backup

# 手动备份
docker-compose exec -T postgres pg_dump -U postgres piaociyuan > backup.sql

# 恢复
./deploy.sh restore backup.sql
```

---

## 故障排查

### 问题：容器启动失败

```bash
# 查看详细日志
docker-compose logs web

# 检查资源使用
docker stats
```

### 问题：数据库连接失败

```bash
# 检查数据库容器状态
docker-compose ps postgres

# 测试数据库连接
docker-compose exec postgres pg_isready -U postgres
```

### 问题：Nginx 502 错误

```bash
# 检查 Web 应用是否正常运行
docker-compose logs web

# 检查 Nginx 配置
docker-compose exec nginx nginx -t
```

### 问题：WebSocket 连接失败

确保 Nginx 配置中的 `/socket.io/` 路径代理正确：

```nginx
location /socket.io/ {
    proxy_pass http://nextjs_upstream;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    # ...
}
```

### 问题：磁盘空间不足

```bash
# 查看磁盘使用
df -h

# 清理 Docker 资源
./deploy.sh cleanup

# 清理旧日志
docker-compose logs --tail=0 -f
```

---

## 更新部署

当有新版本代码时：

```bash
cd /var/www/piaoyuzhou

# 拉取最新代码
git pull origin main

# 重新构建并重启
./deploy.sh build
./deploy.sh restart

# 如果有数据库变更
./deploy.sh migrate
```

---

## 监控建议

1. **阿里云云监控**：开启 ECS 基础监控
2. **日志服务**：可对接阿里云 SLS 收集日志
3. **定时备份**：设置 crontab 定期备份数据库

```bash
# 每天凌晨 3 点自动备份
crontab -e
# 添加：
0 3 * * * cd /var/www/piaoyuzhou && ./deploy.sh backup
```

---

## 成本估算（参考）

| 资源 | 规格 | 月费用（约） |
|------|------|-------------|
| ECS | 2核4G | ¥100-200 |
| 带宽 | 5Mbps | ¥100-150 |
| 云盘 | 40GB ESSD | ¥20-30 |
| 域名 | .com | ¥55/年 |
| SSL | Let's Encrypt | 免费 |

**总计**：约 ¥250-400/月

> 提示：新用户可关注阿里云优惠活动，首购折扣较大
