# ç”¨æˆ·è§’è‰²æƒé™ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“Š è§’è‰²ç±»å‹

| è§’è‰² | è‹±æ–‡ | æƒé™è¯´æ˜ |
|------|------|---------|
| æ™®é€šç”¨æˆ· | user | è´­ç¥¨ã€æŸ¥çœ‹è®¢å•ã€ç®¡ç†æ”¶è—ã€ç¤¾äº¤äº’åŠ¨ |
| å·¥ä½œäººå‘˜ | staff | æ™®é€šç”¨æˆ·æƒé™ + æ‰«ç éªŒç¥¨ã€å‘æ”¾çºªå¿µå“ |
| ç®¡ç†å‘˜ | admin | å·¥ä½œäººå‘˜æƒé™ + ä¿®æ”¹ç”¨æˆ·è§’è‰²ã€ç³»ç»Ÿç®¡ç† |

---

## ğŸ¯ å®ç°æ–¹æ¡ˆï¼š**åå°ç®¡ç†åˆ†é…æƒé™**

è¿™æ˜¯å¤§å…¬å¸æœ€å¸¸ç”¨çš„æ–¹æ¡ˆï¼ˆæ·˜å®ã€ç¾å›¢ã€æ»´æ»´éƒ½æ˜¯è¿™æ ·ï¼‰ï¼š

```
æ–°ç”¨æˆ·æ³¨å†Œ â†’ é»˜è®¤role='user' â†’ ç®¡ç†å‘˜æ‰‹åŠ¨æå‡ä¸ºstaff/admin
```

**ä¼˜ç‚¹**ï¼š
- ğŸ”’ æœ€å®‰å…¨ï¼šé¿å…ä»»ä½•äººéƒ½èƒ½æ³¨å†Œå·¥ä½œäººå‘˜è´¦å·
- ğŸ“ å¯è¿½è¸ªï¼šæœ‰æ¸…æ™°çš„æƒé™å˜æ›´è®°å½•
- âœ… å¯æ§ï¼šç®¡ç†å‘˜å®Œå…¨æŒæ§æƒé™åˆ†é…

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### 1. æ™®é€šç”¨æˆ·æ³¨å†Œ

æ‰€æœ‰äººé€šè¿‡åŒä¸€ä¸ªæ³¨å†Œé¡µé¢æ³¨å†Œï¼Œé»˜è®¤è·å¾— `user` è§’è‰²ï¼š

```bash
POST /api/auth/register
{
  "phone": "13800138000",
  "password": "password123",
  "verifyCode": "123456"
}

# è¿”å›
{
  "ok": true,
  "data": {
    "token": "...",  # åŒ…å« role: 'user'
    "user": {
      "id": "uuid",
      "role": "user"  # é»˜è®¤è§’è‰²
    }
  }
}
```

### 2. ç®¡ç†å‘˜æå‡ç”¨æˆ·æƒé™

ç®¡ç†å‘˜ç™»å½•åï¼Œè°ƒç”¨APIä¿®æ”¹ç”¨æˆ·è§’è‰²ï¼š

```bash
PUT /api/admin/users/{userId}/role
Authorization: Bearer <admin_token>

{
  "role": "staff"  # æˆ– "admin"
}

# è¿”å›
{
  "ok": true,
  "message": "ç”¨æˆ·è§’è‰²å·²æ›´æ–°ï¼šuser â†’ staff",
  "data": {
    "userId": "uuid",
    "phone": "13800138000",
    "nickname": "å¼ ä¸‰",
    "oldRole": "user",
    "newRole": "staff"
  }
}
```

### 3. ç”¨æˆ·é‡æ–°ç™»å½•

**é‡è¦**ï¼šè§’è‰²ä¿®æ”¹åï¼Œç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•æ‰èƒ½è·å¾—æ–°æƒé™çš„tokenï¼

```bash
POST /api/auth/login
{
  "phone": "13800138000",
  "password": "password123"
}

# è¿”å›æ–°tokenï¼ŒåŒ…å«æ›´æ–°åçš„role
{
  "ok": true,
  "data": {
    "token": "...",  # æ–°tokenåŒ…å« role: 'staff'
  }
}
```

---

## ğŸ” æƒé™éªŒè¯ç¤ºä¾‹

### APIç«¯éªŒè¯ï¼ˆæ¨èï¼‰

åœ¨éœ€è¦æƒé™çš„APIä¸­éªŒè¯ï¼š

```typescript
// éªŒè¯å·¥ä½œäººå‘˜æƒé™
const payload = verifyToken(token);
if (!payload || !['staff', 'admin'].includes(payload.role)) {
  return NextResponse.json(
    { ok: false, message: 'ä»…å·¥ä½œäººå‘˜å¯ä»¥æ“ä½œ' },
    { status: 403 }
  );
}

// éªŒè¯ç®¡ç†å‘˜æƒé™
if (payload.role !== 'admin') {
  return NextResponse.json(
    { ok: false, message: 'ä»…ç®¡ç†å‘˜å¯ä»¥æ“ä½œ' },
    { status: 403 }
  );
}
```

### å‰ç«¯è·¯ç”±ä¿æŠ¤ï¼ˆå¯é€‰ï¼‰

```typescript
// middleware.ts æˆ–é¡µé¢ç»„ä»¶
const token = localStorage.getItem('token');
const payload = verifyToken(token);

if (pathname.startsWith('/admin') && payload?.role !== 'admin') {
  redirect('/');
}

if (pathname.startsWith('/staff') && !['staff', 'admin'].includes(payload?.role)) {
  redirect('/');
}
```

---

## ğŸ“ å½“å‰ç³»ç»ŸçŠ¶æ€

### å·²å®ç° âœ…

1. **æ•°æ®åº“å­—æ®µ**ï¼š`users.role` (é»˜è®¤'user')
2. **TokenåŒ…å«role**ï¼šç™»å½•å’Œæ³¨å†ŒAPIéƒ½å·²æ›´æ–°
3. **ç®¡ç†å‘˜API**ï¼š`PUT /api/admin/users/:id/role`
4. **ç¬¬ä¸€ä¸ªç®¡ç†å‘˜**ï¼š
   - æ‰‹æœºå·ï¼š`17701790343`
   - è§’è‰²ï¼š`admin`
   - **âš ï¸ éœ€è¦é‡æ–°ç™»å½•ä»¥è·å¾—adminæƒé™çš„token**

### å¾…å®Œå–„ ğŸ“‹

1. **ç®¡ç†å‘˜ç•Œé¢**ï¼šåˆ›å»ºWebç•Œé¢æŸ¥çœ‹å’Œç®¡ç†ç”¨æˆ·
2. **æ“ä½œæ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æƒé™å˜æ›´æ“ä½œ
3. **å·¥ä½œäººå‘˜åŠŸèƒ½**ï¼šæ‰«ç éªŒç¥¨ç³»ç»Ÿï¼ˆå·²æœ‰APIï¼Œå¾…å‰ç«¯å®ç°ï¼‰
4. **æƒé™æµ‹è¯•**ï¼šå®Œæ•´çš„æƒé™éªŒè¯æµ‹è¯•

---

## ğŸ› ï¸ å¿«é€Ÿæµ‹è¯•

### 1. é‡æ–°ç™»å½•è·å¾—ç®¡ç†å‘˜æƒé™

```bash
# ç™»å½•æµ‹è¯•è´¦å·
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "17701790343",
    "password": "ä½ çš„å¯†ç "
  }'

# ä¿å­˜è¿”å›çš„token
```

### 2. åˆ›å»ºæµ‹è¯•å·¥ä½œäººå‘˜è´¦å·

```bash
# æ³¨å†Œæ–°ç”¨æˆ·
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138001",
    "password": "staff123",
    "verifyCode": "123456"
  }'

# ä¿å­˜æ–°ç”¨æˆ·çš„userId
```

### 3. æå‡ä¸ºå·¥ä½œäººå‘˜

```bash
curl -X PUT http://localhost:3000/api/admin/users/{userId}/role \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <admin_token>" \
  -d '{"role": "staff"}'
```

### 4. æµ‹è¯•æƒé™

```bash
# å·¥ä½œäººå‘˜é‡æ–°ç™»å½•
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138001",
    "password": "staff123"
  }'

# ä½¿ç”¨æ–°tokenè°ƒç”¨éªŒç¥¨APIï¼ˆåº”è¯¥æˆåŠŸï¼‰
curl -X POST http://localhost:3000/api/tickets/use \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <staff_token>" \
  -d '{"ticketId": "..."}'
```

---

## ğŸ“ ä¸‹ä¸€æ­¥å¼€å‘å»ºè®®

### 1. ç®¡ç†åå°ç•Œé¢ï¼ˆä¼˜å…ˆï¼‰

**è·¯å¾„**ï¼š`/admin/users`

**åŠŸèƒ½**ï¼š
- ğŸ“‹ ç”¨æˆ·åˆ—è¡¨ï¼ˆæ”¯æŒæœç´¢å’Œç­›é€‰ï¼‰
- ğŸ” æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
- âš¡ ä¸€é”®ä¿®æ”¹è§’è‰²
- ğŸ“Š ç»Ÿè®¡å„è§’è‰²æ•°é‡

**é¢„è®¡å¼€å‘æ—¶é—´**ï¼š1-2å¤©

### 2. æ‰¹é‡é‚€è¯·ç³»ç»Ÿï¼ˆå¯é€‰ï¼‰

å¦‚æœå·¥ä½œäººå‘˜æ•°é‡è¾ƒå¤šï¼Œå¯ä»¥è€ƒè™‘æ·»åŠ é‚€è¯·ç ç³»ç»Ÿï¼š
- ç®¡ç†å‘˜ç”Ÿæˆé‚€è¯·ç 
- ç”¨æˆ·æ³¨å†Œæ—¶è¾“å…¥é‚€è¯·ç 
- è‡ªåŠ¨è·å¾—staffè§’è‰²

### 3. æƒé™æ—¥å¿—ï¼ˆæ¨èï¼‰

è®°å½•æ‰€æœ‰æƒé™å˜æ›´ï¼š
```sql
CREATE TABLE role_change_logs (
  id UUID PRIMARY KEY,
  user_id UUID,
  old_role VARCHAR(10),
  new_role VARCHAR(10),
  admin_id UUID,
  timestamp TIMESTAMP,
  reason TEXT
);
```

---

## âš ï¸ é‡è¦æé†’

1. **é‡æ–°ç™»å½•**ï¼šä¿®æ”¹è§’è‰²åå¿…é¡»é‡æ–°ç™»å½•æ‰èƒ½ç”Ÿæ•ˆ
2. **Tokenåˆ·æ–°**ï¼šå»ºè®®å®ç°tokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶
3. **å®‰å…¨æ€§**ï¼šç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨å¼ºå¯†ç å’ŒHTTPS
4. **å¤‡ä»½ç®¡ç†å‘˜**ï¼šè‡³å°‘ä¿ç•™2ä¸ªç®¡ç†å‘˜è´¦å·ï¼Œé˜²æ­¢å”¯ä¸€ç®¡ç†å‘˜è¢«é”å®š

---

## ğŸ‰ æ€»ç»“

ä½ ç°åœ¨æ‹¥æœ‰çš„ç³»ç»Ÿï¼š

âœ… **å®‰å…¨çš„æƒé™ç³»ç»Ÿ**ï¼šç®¡ç†å‘˜æ‰‹åŠ¨åˆ†é…ï¼Œæ— æ³•è‡ªè¡Œæ³¨å†Œå·¥ä½œäººå‘˜
âœ… **æ¸…æ™°çš„è§’è‰²åˆ’åˆ†**ï¼šuser / staff / admin
âœ… **å®Œæ•´çš„APIæ”¯æŒ**ï¼šç™»å½•ã€æ³¨å†Œã€æƒé™ä¿®æ”¹
âœ… **ç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦å·**ï¼š17701790343

ä¸‹æ¬¡ç™»å½•æ—¶ï¼Œä½ çš„è´¦å·å°†æ‹¥æœ‰adminæƒé™ï¼Œå¯ä»¥ç®¡ç†å…¶ä»–ç”¨æˆ·çš„è§’è‰²äº†ï¼ğŸŠ
