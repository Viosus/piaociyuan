# å®šæ—¶ä»»åŠ¡ç³»ç»Ÿæ–‡æ¡£

> ç¥¨æ¬¡å…ƒåç«¯è‡ªåŠ¨åŒ–ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ - Web å’Œ Mobile é€šç”¨

## ğŸ“‹ æ¦‚è¿°

å®šæ—¶ä»»åŠ¡ç³»ç»Ÿæ˜¯è¿è¡Œåœ¨**åç«¯æœåŠ¡å™¨**ä¸Šçš„è‡ªåŠ¨åŒ–ä»»åŠ¡è°ƒåº¦å™¨ï¼Œè´Ÿè´£å®šæœŸç»´æŠ¤æ•°æ®åº“çŠ¶æ€ï¼Œç¡®ä¿ç³»ç»Ÿæ•°æ®çš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

- âœ… **ç»Ÿä¸€åç«¯ç®¡ç†**ï¼šè¿è¡Œåœ¨ Next.js æœåŠ¡å™¨ä¸Šï¼ŒWeb ç«¯å’Œ Mobile ç«¯å…±äº«åŒä¸€æ•°æ®åº“
- âœ… **ç”Ÿäº§çº§å¯é **ï¼šä½¿ç”¨ node-cronï¼Œæ”¯æŒæ ‡å‡† Cron è¡¨è¾¾å¼
- âœ… **å¤šå®ä¾‹å®‰å…¨**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶ï¼Œæ”¯æŒäº‘æœåŠ¡å™¨å¤šå®ä¾‹éƒ¨ç½²
- âœ… **å®Œæ•´æ—¥å¿—**ï¼šè¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯è¿½è¸ª
- âœ… **ä¼˜é›…å…³é—­**ï¼šæœåŠ¡å™¨å…³é—­æ—¶è‡ªåŠ¨åœæ­¢æ‰€æœ‰ä»»åŠ¡

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     äº‘æœåŠ¡å™¨ / æœ¬åœ°æœåŠ¡å™¨                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚        Next.js åç«¯æœåŠ¡å™¨ (Port 3000)        â”‚          â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚   â”‚                                             â”‚          â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚          â”‚
â”‚   â”‚  â”‚   å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ (Scheduler)         â”‚   â”‚          â”‚
â”‚   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚          â”‚
â”‚   â”‚  â”‚                                     â”‚   â”‚          â”‚
â”‚   â”‚  â”‚  [æ¯å°æ—¶] æ›´æ–°æ´»åŠ¨çŠ¶æ€               â”‚â”€â”€â”€â”¼â”€â”€â”       â”‚
â”‚   â”‚  â”‚  [æ¯5åˆ†é’Ÿ] æ¸…ç†è¿‡æœŸåº§ä½é”å®š          â”‚â”€â”€â”€â”¼â”€â”€â”¤       â”‚
â”‚   â”‚  â”‚  [å¯æ‰©å±•] è‡ªå®šä¹‰ä»»åŠ¡...              â”‚â”€â”€â”€â”¼â”€â”€â”¤       â”‚
â”‚   â”‚  â”‚                                     â”‚   â”‚  â”‚       â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚       â”‚
â”‚   â”‚                                             â”‚  â”‚       â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚       â”‚
â”‚   â”‚  â”‚          API Routes                 â”‚   â”‚  â”‚       â”‚
â”‚   â”‚  â”‚  - /api/events                      â”‚â—„â”€â”€â”¼â”€â”€â”¤       â”‚
â”‚   â”‚  â”‚  - /api/posts                       â”‚   â”‚  â”‚       â”‚
â”‚   â”‚  â”‚  - /api/tickets                     â”‚   â”‚  â”‚       â”‚
â”‚   â”‚  â”‚  - ...                              â”‚   â”‚  â”‚       â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚       â”‚
â”‚   â”‚                                             â”‚  â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚
â”‚                          â”‚                         â”‚       â”‚
â”‚                          â–¼                         â–¼       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚           PostgreSQL æ•°æ®åº“ (å…±äº«)                   â”‚ â”‚
â”‚   â”‚  - events (æ´»åŠ¨è¡¨)                                   â”‚ â”‚
â”‚   â”‚  - posts (å¸–å­è¡¨)                                    â”‚ â”‚
â”‚   â”‚  - tickets (é—¨ç¥¨è¡¨)                                  â”‚ â”‚
â”‚   â”‚  - holds (åº§ä½é”å®šè¡¨)                                â”‚ â”‚
â”‚   â”‚  - ...                                               â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â–²                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                   â”‚
         â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web å‰ç«¯       â”‚              â”‚  Mobile App      â”‚
â”‚  (Next.js)       â”‚              â”‚  (React Native)  â”‚
â”‚                  â”‚              â”‚                  â”‚
â”‚  é€šè¿‡ API è®¿é—®   â”‚              â”‚  é€šè¿‡ API è®¿é—®   â”‚
â”‚  åŒä¸€ä¸ªæ•°æ®åº“    â”‚              â”‚  åŒä¸€ä¸ªæ•°æ®åº“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ ä¸ºä»€ä¹ˆæ˜¯ Web å’Œ Mobile é€šç”¨ï¼Ÿ

### ç»Ÿä¸€æ•°æ®æº

**å®šæ—¶ä»»åŠ¡ä¿®æ”¹æ•°æ®åº“ â†’ Web å’Œ Mobile éƒ½èƒ½çœ‹åˆ°æ›´æ–°**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å·¥ä½œæµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  1. å®šæ—¶ä»»åŠ¡æ£€æµ‹åˆ°æ´»åŠ¨è¿‡æœŸ                                 â”‚
â”‚     â””â”€> æ›´æ–°æ•°æ®åº“: saleStatus = 'ended'                 â”‚
â”‚                                                          â”‚
â”‚  2. Web ç«¯æŸ¥è¯¢æ´»åŠ¨åˆ—è¡¨                                    â”‚
â”‚     â””â”€> GET /api/events                                  â”‚
â”‚     â””â”€> è¿”å›æœ€æ–°çŠ¶æ€ï¼ˆå·²è¿‡æœŸçš„ä¸æ˜¾ç¤ºï¼‰                     â”‚
â”‚                                                          â”‚
â”‚  3. Mobile ç«¯æŸ¥è¯¢æ´»åŠ¨åˆ—è¡¨                                 â”‚
â”‚     â””â”€> GET /api/events                                  â”‚
â”‚     â””â”€> è¿”å›æœ€æ–°çŠ¶æ€ï¼ˆå·²è¿‡æœŸçš„ä¸æ˜¾ç¤ºï¼‰                     â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¤ºä¾‹åœºæ™¯

**åœºæ™¯ï¼šå‘¨æ°ä¼¦æ¼”å”±ä¼šæ´»åŠ¨è¿‡æœŸ**

```
æ—¶é—´çº¿ï¼š
12:00 - æ´»åŠ¨åˆ›å»ºï¼ŒçŠ¶æ€ saleStatus = 'on_sale'
        â”œâ”€ Web ç«¯ï¼šæ˜¾ç¤º"æ­£åœ¨å”®ç¥¨"
        â””â”€ Mobile ç«¯ï¼šæ˜¾ç¤º"æ­£åœ¨å”®ç¥¨"

13:00 - å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼ˆæ¯å°æ—¶ï¼‰
        â””â”€ æ£€æµ‹åˆ°æ´»åŠ¨æ—¥æœŸå·²è¿‡
        â””â”€ æ›´æ–°æ•°æ®åº“ï¼šsaleStatus = 'ended'

13:01 - Web ç«¯åˆ·æ–°é¡µé¢
        â””â”€ API è¿”å›ï¼šè¯¥æ´»åŠ¨çŠ¶æ€ä¸º 'ended'
        â””â”€ å‰ç«¯ä¸æ˜¾ç¤ºåœ¨å”®ç¥¨åˆ—è¡¨ä¸­

13:02 - Mobile ç«¯åˆ·æ–°åˆ—è¡¨
        â””â”€ API è¿”å›ï¼šè¯¥æ´»åŠ¨çŠ¶æ€ä¸º 'ended'
        â””â”€ å‰ç«¯ä¸æ˜¾ç¤ºåœ¨å”®ç¥¨åˆ—è¡¨ä¸­
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
apps/web/
â”œâ”€â”€ server.js                      # æœåŠ¡å™¨å…¥å£ï¼ˆé›†æˆå®šæ—¶ä»»åŠ¡ï¼‰
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ scheduler.js               # å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨
â””â”€â”€ app/
    â””â”€â”€ api/
        â””â”€â”€ events/
            â””â”€â”€ update-status/
                â””â”€â”€ route.ts       # æ´»åŠ¨çŠ¶æ€æ›´æ–° API
```

## ğŸ”§ æ ¸å¿ƒä»£ç 

### 1. å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨ (`lib/scheduler.js`)

```javascript
// ä¸»è¦åŠŸèƒ½
class Scheduler {
  // å¯åŠ¨æ‰€æœ‰å®šæ—¶ä»»åŠ¡
  start() {
    this.registerJobs();
  }

  // æ³¨å†Œä»»åŠ¡
  registerJobs() {
    // ä»»åŠ¡ 1: æ›´æ–°æ´»åŠ¨çŠ¶æ€ï¼ˆæ¯å°æ—¶æ•´ç‚¹ï¼‰
    this.addJob('updateEventStatus', '0 */1 * * *', async () => {
      await this.updateEventStatus();
    });

    // ä»»åŠ¡ 2: æ¸…ç†è¿‡æœŸåº§ä½é”å®šï¼ˆæ¯5åˆ†é’Ÿï¼‰
    this.addJob('cleanupExpiredHolds', '*/5 * * * *', async () => {
      await this.cleanupExpiredHolds();
    });
  }

  // ä¼˜é›…å…³é—­
  stop() {
    for (const [name, job] of this.jobs.entries()) {
      job.stop();
    }
  }
}
```

### 2. æ´»åŠ¨çŠ¶æ€æ›´æ–° API (`app/api/events/update-status/route.ts`)

```typescript
// è‡ªåŠ¨æ›´æ–°è§„åˆ™
export async function POST(_req: Request) {
  // 1. æ´»åŠ¨æ—¥æœŸå·²è¿‡ â†’ ended
  // 2. å”®ç¥¨ç»“æŸæ—¶é—´å·²è¿‡ â†’ ended
  // 3. åœ¨å”®ç¥¨æ—¶é—´å†… â†’ on_sale
  // 4. å”®ç¥¨æœªå¼€å§‹ â†’ not_started
  // 5. æ‰‹åŠ¨æš‚åœï¼ˆpausedï¼‰â†’ ä¸è‡ªåŠ¨æ›´æ–°
}
```

## â° å½“å‰å®šæ—¶ä»»åŠ¡åˆ—è¡¨

| ä»»åŠ¡åç§° | Cron è¡¨è¾¾å¼ | æ‰§è¡Œé¢‘ç‡ | è¯´æ˜ | å½±å“èŒƒå›´ |
|---------|------------|---------|------|---------|
| **updateEventStatus** | `0 */1 * * *` | æ¯å°æ—¶æ•´ç‚¹ | è‡ªåŠ¨æ›´æ–°æ´»åŠ¨çŠ¶æ€ | Web + Mobile |
| **cleanupExpiredHolds** | `*/5 * * * *` | æ¯5åˆ†é’Ÿ | æ¸…ç†è¶…è¿‡15åˆ†é’Ÿçš„åº§ä½é”å®š | Web + Mobile |

### Cron è¡¨è¾¾å¼è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0 - 59)
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0 - 23)
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€ æ—¥æœŸ (1 - 31)
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€ æœˆä»½ (1 - 12)
â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€ æ˜ŸæœŸ (0 - 7)
â”‚ â”‚ â”‚ â”‚ â”‚
* * * * *
```

**å¸¸ç”¨ç¤ºä¾‹ï¼š**
- `0 */1 * * *` - æ¯å°æ—¶æ•´ç‚¹ï¼ˆ0:00, 1:00, 2:00...ï¼‰
- `*/5 * * * *` - æ¯5åˆ†é’Ÿ
- `0 0 * * *` - æ¯å¤©å‡Œæ™¨0ç‚¹
- `0 2 * * *` - æ¯å¤©å‡Œæ™¨2ç‚¹
- `0 0 * * 0` - æ¯å‘¨æ—¥å‡Œæ™¨0ç‚¹

## ğŸš€ éƒ¨ç½²æŒ‡å—

### å¼€å‘ç¯å¢ƒ

```bash
# 1. å®‰è£…ä¾èµ–
npm install

# 2. å¯åŠ¨æœåŠ¡å™¨ï¼ˆå®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¯åŠ¨ï¼‰
npm run dev:web

# æ—¥å¿—è¾“å‡ºç¤ºä¾‹ï¼š
# > Ready on http://0.0.0.0:3000
# > Socket.io server is running
# [SCHEDULER] Starting scheduled jobs...
# [SCHEDULER] Registered job: updateEventStatus (0 */1 * * *)
# [SCHEDULER] Registered job: cleanupExpiredHolds (*/5 * * * *)
# [SCHEDULER] All jobs registered successfully
```

### ç”Ÿäº§ç¯å¢ƒ - äº‘æœåŠ¡å™¨éƒ¨ç½²

#### æ–¹å¼ 1: ç›´æ¥å¯åŠ¨ï¼ˆå•å®ä¾‹ï¼‰

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export NODE_ENV=production
export ENABLE_SCHEDULER=true

# å¯åŠ¨æœåŠ¡å™¨
npm run start
```

#### æ–¹å¼ 2: PM2 éƒ¨ç½²ï¼ˆæ¨èï¼‰

```bash
# å®‰è£… PM2
npm install -g pm2

# å¯åŠ¨ä¸»å®ä¾‹ï¼ˆè¿è¡Œå®šæ—¶ä»»åŠ¡ï¼‰
ENABLE_SCHEDULER=true pm2 start server.js --name "piaociyuan-main"

# ï¼ˆå¯é€‰ï¼‰å¯åŠ¨å·¥ä½œå®ä¾‹ï¼ˆä¸è¿è¡Œå®šæ—¶ä»»åŠ¡ï¼Œä»…å¤„ç†è¯·æ±‚ï¼‰
ENABLE_SCHEDULER=false pm2 start server.js --name "piaociyuan-worker" -i 3

# æŸ¥çœ‹æ—¥å¿—
pm2 logs piaociyuan-main

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

#### æ–¹å¼ 3: Docker éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'

services:
  web-main:
    image: piaociyuan/web:latest
    environment:
      - NODE_ENV=production
      - ENABLE_SCHEDULER=true  # ä¸»å®ä¾‹è¿è¡Œå®šæ—¶ä»»åŠ¡
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "3000:3000"
    restart: unless-stopped

  web-worker:
    image: piaociyuan/web:latest
    environment:
      - NODE_ENV=production
      - ENABLE_SCHEDULER=false  # å·¥ä½œå®ä¾‹ä¸è¿è¡Œå®šæ—¶ä»»åŠ¡
      - DATABASE_URL=${DATABASE_URL}
      - JWT_SECRET=${JWT_SECRET}
    ports:
      - "3001-3003:3000"
    deploy:
      replicas: 3
    restart: unless-stopped
```

```bash
# å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f web-main
```

## ğŸ” ç¯å¢ƒå˜é‡é…ç½®

åœ¨äº‘æœåŠ¡å™¨ä¸Šåˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# ===== å®šæ—¶ä»»åŠ¡é…ç½® =====
ENABLE_SCHEDULER=true          # æ˜¯å¦å¯ç”¨å®šæ—¶ä»»åŠ¡ï¼ˆä¸»å®ä¾‹è®¾ä¸º trueï¼‰

# ===== æœåŠ¡å™¨é…ç½® =====
PORT=3000                      # æœåŠ¡å™¨ç«¯å£
NODE_ENV=production            # ç¯å¢ƒï¼ˆdevelopment/productionï¼‰

# ===== æ•°æ®åº“é…ç½® =====
DATABASE_URL=postgresql://user:password@host:5432/piaociyuan

# ===== JWT å¯†é’¥ =====
JWT_SECRET=your_super_secret_key_change_in_production

# ===== å…¶ä»–é…ç½® =====
NEXT_PUBLIC_APP_URL=https://yourdomain.com
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹å®šæ—¶ä»»åŠ¡æ—¥å¿—

**å¼€å‘ç¯å¢ƒï¼š**
```bash
# æ§åˆ¶å°ä¼šå®æ—¶æ˜¾ç¤ºæ—¥å¿—
[SCHEDULER] Starting job: updateEventStatus
[SCHEDULER] Event status updated: æˆåŠŸæ›´æ–° 3 ä¸ªæ´»åŠ¨çŠ¶æ€
[SCHEDULER] Job "updateEventStatus" completed in 245ms
```

**ç”Ÿäº§ç¯å¢ƒï¼ˆPM2ï¼‰ï¼š**
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs piaociyuan-main

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs piaociyuan-main --err

# æ¸…ç©ºæ—¥å¿—
pm2 flush
```

**ç”Ÿäº§ç¯å¢ƒï¼ˆDockerï¼‰ï¼š**
```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs -f web-main

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œ
docker-compose logs --tail=100 web-main
```

### æ—¥å¿—æ ¼å¼è¯´æ˜

```
[SCHEDULER] å‰ç¼€        - å®šæ—¶ä»»åŠ¡ç³»ç»Ÿ
[CRON] å‰ç¼€            - æ—§ç‰ˆå®šæ—¶ä»»åŠ¡ï¼ˆå·²åºŸå¼ƒï¼‰
[WebSocket] å‰ç¼€       - Socket.io æ¶ˆæ¯
[EVENT_GET_ERROR]      - API é”™è¯¯
```

## ğŸ› ï¸ å¦‚ä½•æ·»åŠ æ–°çš„å®šæ—¶ä»»åŠ¡

### æ­¥éª¤ 1: ç¼–è¾‘ `lib/scheduler.js`

```javascript
registerJobs() {
  // ç°æœ‰ä»»åŠ¡...
  this.addJob('updateEventStatus', '0 */1 * * *', async () => {
    await this.updateEventStatus();
  });

  this.addJob('cleanupExpiredHolds', '*/5 * * * *', async () => {
    await this.cleanupExpiredHolds();
  });

  // æ·»åŠ æ–°ä»»åŠ¡
  this.addJob('yourNewTask', '0 0 * * *', async () => {
    await this.yourNewTask();
  });
}

// å®ç°ä»»åŠ¡é€»è¾‘
async yourNewTask() {
  try {
    console.log('[SCHEDULER] Running yourNewTask...');

    // æ–¹å¼ 1: ç›´æ¥æ“ä½œæ•°æ®åº“
    // const prisma = require('@/lib/prisma');
    // await prisma.yourTable.update(...);

    // æ–¹å¼ 2: è°ƒç”¨ API
    const port = process.env.PORT || 3000;
    const response = await fetch(`http://localhost:${port}/api/your-endpoint`);
    const data = await response.json();

    console.log('[SCHEDULER] yourNewTask completed:', data);
  } catch (error) {
    console.error('[SCHEDULER] yourNewTask failed:', error);
  }
}
```

### æ­¥éª¤ 2: é‡å¯æœåŠ¡å™¨

```bash
# å¼€å‘ç¯å¢ƒ
npm run dev:web

# ç”Ÿäº§ç¯å¢ƒï¼ˆPM2ï¼‰
pm2 restart piaociyuan-main
```

## ğŸ” å¸¸è§é—®é¢˜

### Q1: å®šæ—¶ä»»åŠ¡æ²¡æœ‰è¿è¡Œï¼Ÿ

**æ£€æŸ¥æ¸…å•ï¼š**
1. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼Œç¡®è®¤ä»»åŠ¡å·²æ³¨å†Œ
   ```bash
   # åº”è¯¥çœ‹åˆ°ï¼š
   [SCHEDULER] Registered job: updateEventStatus (0 */1 * * *)
   ```

2. æ£€æŸ¥ç¯å¢ƒå˜é‡
   ```bash
   echo $ENABLE_SCHEDULER  # åº”è¯¥æ˜¯ true
   ```

3. ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
   ```bash
   pm2 status
   # æˆ–
   netstat -ano | findstr :3000
   ```

### Q2: å¤šä¸ªæœåŠ¡å™¨å®ä¾‹æ—¶ï¼Œä»»åŠ¡ä¼šé‡å¤æ‰§è¡Œå—ï¼Ÿ

**ä¸ä¼šï¼Œåªè¦æ­£ç¡®é…ç½®ï¼š**

- **ä¸»å®ä¾‹**ï¼š`ENABLE_SCHEDULER=true`ï¼ˆè¿è¡Œå®šæ—¶ä»»åŠ¡ï¼‰
- **å·¥ä½œå®ä¾‹**ï¼š`ENABLE_SCHEDULER=false`ï¼ˆä¸è¿è¡Œå®šæ—¶ä»»åŠ¡ï¼‰

### Q3: å®šæ—¶ä»»åŠ¡æŠ¥é”™æ€ä¹ˆåŠï¼Ÿ

**æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š**
```bash
# PM2
pm2 logs piaociyuan-main --err

# Docker
docker-compose logs web-main | grep ERROR
```

**å¸¸è§é”™è¯¯ï¼š**
- `fetch failed` - æœåŠ¡å™¨æœªå®Œå…¨å¯åŠ¨ï¼Œå»¶é•¿å¯åŠ¨ç­‰å¾…æ—¶é—´
- `Database connection failed` - æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®
- `Invalid cron expression` - æ£€æŸ¥ Cron è¡¨è¾¾å¼æ ¼å¼

### Q4: å¦‚ä½•ä¸´æ—¶ç¦ç”¨å®šæ—¶ä»»åŠ¡ï¼Ÿ

```bash
# æ–¹å¼ 1: ç¯å¢ƒå˜é‡
export ENABLE_SCHEDULER=false
pm2 restart piaociyuan-main

# æ–¹å¼ 2: æ‰‹åŠ¨åœæ­¢ç‰¹å®šä»»åŠ¡ï¼ˆéœ€è¦ä¿®æ”¹ä»£ç ï¼‰
# åœ¨ scheduler.js ä¸­æ³¨é‡Šæ‰ä¸éœ€è¦çš„ä»»åŠ¡
```

### Q5: å®šæ—¶ä»»åŠ¡å¯ä»¥æ‰‹åŠ¨è§¦å‘å—ï¼Ÿ

**å¯ä»¥ï¼ç›´æ¥è°ƒç”¨ APIï¼š**

```bash
# æ‰‹åŠ¨è§¦å‘æ´»åŠ¨çŠ¶æ€æ›´æ–°
curl http://localhost:3000/api/events/update-status

# æˆ–åœ¨æµè§ˆå™¨ä¸­è®¿é—®
http://yourdomain.com/api/events/update-status
```

## ğŸ“ˆ æ€§èƒ½å’Œèµ„æºæ¶ˆè€—

### èµ„æºå ç”¨

| é¡¹ç›® | å¼€å‘ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|------|---------|---------|
| CPU | < 1% | < 2% |
| å†…å­˜ | ~50MB | ~100MB |
| ç½‘ç»œ | å¿½ç•¥ä¸è®¡ | å¿½ç•¥ä¸è®¡ |

### ä¼˜åŒ–å»ºè®®

1. **åˆç†è®¾ç½®æ‰§è¡Œé¢‘ç‡**
   - ä¸éœ€è¦æ¯åˆ†é’Ÿæ›´æ–°çš„ä»»åŠ¡ï¼Œè®¾ç½®ä¸ºæ¯å°æ—¶æˆ–æ¯å¤©
   - é¿å…åŒæ—¶è¿è¡Œå¤šä¸ªé‡ä»»åŠ¡

2. **æ•°æ®åº“ç´¢å¼•**
   - ç¡®ä¿ä»»åŠ¡æŸ¥è¯¢çš„å­—æ®µæœ‰ç´¢å¼•
   ```sql
   CREATE INDEX idx_events_date ON events(date);
   CREATE INDEX idx_events_saleStatus ON events("saleStatus");
   ```

3. **ä»»åŠ¡è¶…æ—¶ä¿æŠ¤**
   - å¯¹äºè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡ï¼Œæ·»åŠ è¶…æ—¶æ§åˆ¶

## ğŸ”„ å‡çº§å’Œç»´æŠ¤

### æ›´æ–°å®šæ—¶ä»»åŠ¡

```bash
# 1. ä¿®æ”¹ä»£ç 
# 2. æäº¤åˆ° Git
git add apps/web/lib/scheduler.js
git commit -m "feat: æ·»åŠ æ–°çš„å®šæ—¶ä»»åŠ¡"

# 3. æ¨é€åˆ°äº‘æœåŠ¡å™¨
git push origin main

# 4. åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–æ›´æ–°
ssh your-server
cd /path/to/piaociyuan
git pull
npm install

# 5. é‡å¯æœåŠ¡
pm2 restart piaociyuan-main
```

### å¤‡ä»½å’Œæ¢å¤

**å®šæ—¶ä»»åŠ¡é…ç½®å¤‡ä»½ï¼š**
```bash
# å¤‡ä»½è°ƒåº¦å™¨æ–‡ä»¶
cp apps/web/lib/scheduler.js apps/web/lib/scheduler.js.backup

# æ¢å¤
cp apps/web/lib/scheduler.js.backup apps/web/lib/scheduler.js
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é˜¿é‡Œäº‘éƒ¨ç½²æŒ‡å—](./é˜¿é‡Œäº‘éƒ¨ç½²æŒ‡å—.md)
- [æ•°æ®åº“æ¶æ„è¯´æ˜](./æ•°æ®åº“æ¶æ„é‡æ„æ–¹æ¡ˆ.md)
- [API æ¦‚è§ˆ](./APIæ¦‚è§ˆ.md)
- [é«˜å¹¶å‘ä¼˜åŒ–æ€»ç»“](./é«˜å¹¶å‘ä¼˜åŒ–æ€»ç»“.md)

## ğŸ¯ æœªæ¥è®¡åˆ’

- [ ] æ·»åŠ ä»»åŠ¡æ‰§è¡Œå†å²è®°å½•
- [ ] å®ç°ä»»åŠ¡å¤±è´¥é‡è¯•æœºåˆ¶
- [ ] æ·»åŠ ä»»åŠ¡æ‰§è¡Œé€šçŸ¥ï¼ˆé‚®ä»¶/Slackï¼‰
- [ ] åˆ›å»ºä»»åŠ¡ç®¡ç† Web ç•Œé¢
- [ ] æ”¯æŒåŠ¨æ€æ·»åŠ /åˆ é™¤ä»»åŠ¡ï¼ˆä¸éœ€è¦é‡å¯ï¼‰

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. æœåŠ¡å™¨æ—¥å¿—ï¼š`pm2 logs piaociyuan-main`
2. æ•°æ®åº“çŠ¶æ€ï¼šæ£€æŸ¥æ´»åŠ¨è¡¨çš„ `saleStatus` å­—æ®µ
3. API æµ‹è¯•ï¼š`curl http://localhost:3000/api/events/update-status`

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2026-01-04
**ç»´æŠ¤è€…**: Claude Code
**é€‚ç”¨èŒƒå›´**: Web ç«¯ + Mobile ç«¯ï¼ˆå…±äº«åç«¯ï¼‰
