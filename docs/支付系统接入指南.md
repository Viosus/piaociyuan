# 支付系统接入指南

## 概述

本项目支持三种支付方式：
- **微信支付** - APP支付、Native支付（扫码）
- **支付宝** - APP支付、网页支付
- **模拟支付** - 开发测试用

---

## 目录

1. [系统架构](#系统架构)
2. [支付流程](#支付流程)
3. [环境配置](#环境配置)
4. [API接口文档](#api接口文档)
5. [移动端SDK集成](#移动端sdk集成)
6. [上线检查清单](#上线检查清单)
7. [常见问题](#常见问题)

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        移动端 APP                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  微信支付   │  │  支付宝     │  │  模拟支付   │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
└─────────┼────────────────┼────────────────┼─────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────┐
│                      Web 后端 (Next.js)                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   lib/payment.ts                     │   │
│  │  - 微信支付签名/验签                                  │   │
│  │  - 支付宝签名/验签                                    │   │
│  │  - 统一下单接口                                       │   │
│  │  - 统一退款接口                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────┐  │
│  │ /api/pay/wechat│  │ /api/pay/alipay│  │/api/pay/mock │  │
│  │ /api/pay/wechat│  │ /api/pay/alipay│  │              │  │
│  │   /notify      │  │   /notify      │  │              │  │
│  └───────┬────────┘  └───────┬────────┘  └──────┬───────┘  │
└──────────┼───────────────────┼──────────────────┼──────────┘
           │                   │                  │
           ▼                   ▼                  │
    ┌─────────────┐     ┌─────────────┐          │
    │  微信支付   │     │  支付宝     │          │
    │  平台       │     │  平台       │          │
    └──────┬──────┘     └──────┬──────┘          │
           │                   │                  │
           └───────────┬───────┘                  │
                       ▼                          ▼
              ┌─────────────────────────────────────┐
              │           PostgreSQL 数据库          │
              │  - orders (订单表)                   │
              │  - tickets (门票表)                  │
              │  - holds (锁票表)                    │
              └─────────────────────────────────────┘
```

---

## 支付流程

### 完整支付流程

```
1. 用户选择票档和数量
         │
         ▼
2. 创建订单 (POST /api/orders)
   - 创建 Hold 锁票记录
   - 创建 Order 订单记录 (status: PENDING)
   - 创建 Ticket 门票记录 (status: locked)
         │
         ▼
3. 选择支付方式
         │
    ┌────┴────┬────────────┐
    ▼         ▼            ▼
 微信支付   支付宝      模拟支付
    │         │            │
    ▼         ▼            ▼
4. 创建支付订单
   POST /api/pay/wechat   POST /api/pay/alipay   POST /api/pay/mock
   返回 payParams         返回 orderString       直接完成支付
         │                      │                      │
         ▼                      ▼                      │
5. 调用原生SDK唤起支付          │                      │
         │                      │                      │
         ▼                      ▼                      │
6. 用户在支付平台完成支付       │                      │
         │                      │                      │
         ▼                      ▼                      │
7. 支付平台异步回调             │                      │
   POST /api/pay/wechat/notify  │                      │
   POST /api/pay/alipay/notify  │                      │
         │                      │                      │
         └──────────────────────┴──────────────────────┘
                                │
                                ▼
8. 更新数据库状态
   - Order.status = PAID
   - Order.paidAt = 当前时间
   - Order.transactionId = 第三方交易号
   - Ticket.status = sold
   - 删除 Hold 记录
                                │
                                ▼
9. 返回支付成功页面
```

### 退款流程

```
1. 用户申请退款
         │
         ▼
2. POST /api/pay/refund
   - 验证订单状态 (必须是 PAID)
   - 验证门票未使用
   - 调用第三方退款接口
         │
         ▼
3. 更新数据库状态
   - Order.status = REFUNDED
   - Order.refundedAt = 当前时间
   - Order.refundId = 退款单号
   - Ticket.status = refunded
   - Tier.sold 减少
         │
         ▼
4. 退款到账 (1-7个工作日)
```

---

## 环境配置

### 1. 环境变量配置

在 `.env` 文件中添加以下配置：

```bash
# ============================================
# 支付配置
# ============================================

# 支付环境 (sandbox: 沙箱测试, production: 生产环境)
PAYMENT_ENV=sandbox

# ============================================
# 微信支付配置
# ============================================

# 微信开放平台 APP 的 AppID
WECHAT_APP_ID=wx1234567890abcdef

# 微信商户号
WECHAT_MCH_ID=1234567890

# API v2 密钥 (用于部分旧接口)
WECHAT_API_KEY=your_api_key_v2_32_chars_here

# API v3 密钥 (用于新接口，32位)
WECHAT_API_V3_KEY=your_api_key_v3_32_chars_here

# 商户API证书序列号
WECHAT_SERIAL_NO=1234567890ABCDEF1234567890ABCDEF12345678

# 商户API私钥 (PEM格式，注意换行符处理)
WECHAT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQE...
-----END PRIVATE KEY-----"

# 微信支付平台证书 (用于验证回调签名)
WECHAT_PLATFORM_CERT="-----BEGIN CERTIFICATE-----
MIIEoTCCA4mgAwIBAgIUE...
-----END CERTIFICATE-----"

# 支付结果回调地址 (必须是HTTPS，且外网可访问)
WECHAT_NOTIFY_URL=https://your-domain.com/api/pay/wechat/notify

# ============================================
# 支付宝配置
# ============================================

# 支付宝应用 AppID
ALIPAY_APP_ID=2021001234567890

# 应用私钥 (RSA2, 2048位)
ALIPAY_PRIVATE_KEY=MIIEvQIBADANBgkqhkiG9w0BAQE...

# 支付宝公钥 (从支付宝开放平台获取)
ALIPAY_PUBLIC_KEY=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8...

# 支付结果回调地址
ALIPAY_NOTIFY_URL=https://your-domain.com/api/pay/alipay/notify

# 支付完成后的跳转地址 (网页支付用)
ALIPAY_RETURN_URL=https://your-domain.com/payment/success
```

### 2. 获取微信支付配置

1. 登录 [微信商户平台](https://pay.weixin.qq.com)
2. 申请APP支付权限
3. 在「账户中心」>「API安全」中：
   - 设置API密钥（v2和v3）
   - 下载API证书
4. 获取以下信息：
   - 商户号 (mch_id)
   - 证书序列号
   - 私钥文件 (apiclient_key.pem)

### 3. 获取支付宝配置

1. 登录 [支付宝开放平台](https://open.alipay.com)
2. 创建应用并申请「APP支付」能力
3. 在「开发设置」中：
   - 生成RSA2密钥对（使用支付宝密钥工具）
   - 上传应用公钥，获取支付宝公钥
4. 获取以下信息：
   - AppID
   - 应用私钥
   - 支付宝公钥

---

## API接口文档

### 1. 微信支付 - 创建订单

**请求**
```http
POST /api/pay/wechat
Content-Type: application/json

{
  "orderId": "ORD1234567890",
  "payType": "app"  // app: APP支付, native: 扫码支付
}
```

**响应**
```json
{
  "ok": true,
  "code": "SUCCESS",
  "message": "创建支付订单成功",
  "data": {
    "orderId": "ORD1234567890",
    "amount": 9900,
    "payParams": {
      "appid": "wx1234567890",
      "partnerid": "1234567890",
      "prepayid": "wx123456789",
      "package": "Sign=WXPay",
      "noncestr": "ABC123",
      "timestamp": "1234567890",
      "sign": "签名字符串"
    }
  }
}
```

### 2. 支付宝 - 创建订单

**请求**
```http
POST /api/pay/alipay
Content-Type: application/json

{
  "orderId": "ORD1234567890",
  "payType": "app"  // app: APP支付, web: 网页支付
}
```

**响应**
```json
{
  "ok": true,
  "code": "SUCCESS",
  "message": "创建支付订单成功",
  "data": {
    "orderId": "ORD1234567890",
    "amount": 9900,
    "orderString": "app_id=2021001234567890&biz_content=..."
  }
}
```

### 3. 模拟支付

**请求**
```http
POST /api/pay/mock
Content-Type: application/json

{
  "orderId": "ORD1234567890"
}
```

**响应**
```json
{
  "ok": true,
  "code": "PAY_SUCCESS",
  "message": "支付成功",
  "data": {
    "status": "PAID",
    "paidAt": 1234567890000,
    "tickets": [
      { "id": "xxx", "ticketCode": "TICKET001" }
    ]
  }
}
```

### 4. 退款

**请求**
```http
POST /api/pay/refund
Content-Type: application/json

{
  "orderId": "ORD1234567890",
  "reason": "用户申请退款"  // 可选
}
```

**响应**
```json
{
  "ok": true,
  "code": "SUCCESS",
  "message": "退款成功",
  "data": {
    "orderId": "ORD1234567890",
    "refundId": "RF1234567890ABCD",
    "refundAmount": 9900,
    "status": "REFUNDED"
  }
}
```

### 5. 微信支付回调 (微信平台调用)

**请求**
```http
POST /api/pay/wechat/notify
Content-Type: application/json
Wechatpay-Timestamp: 1234567890
Wechatpay-Nonce: ABC123
Wechatpay-Signature: 签名
Wechatpay-Serial: 证书序列号

{
  "resource": {
    "ciphertext": "加密数据",
    "associated_data": "关联数据",
    "nonce": "随机串"
  }
}
```

**响应**
```json
{
  "code": "SUCCESS",
  "message": "OK"
}
```

### 6. 支付宝回调 (支付宝平台调用)

**请求**
```http
POST /api/pay/alipay/notify
Content-Type: application/x-www-form-urlencoded

out_trade_no=ORD1234567890&trade_no=2021123456789&trade_status=TRADE_SUCCESS&...
```

**响应**
```
success
```

---

## 移动端SDK集成

### 1. 安装依赖

```bash
# 微信支付 SDK
npm install react-native-wechat-lib

# 支付宝 SDK (可选，也可用 Linking 打开)
npm install @alipay/ariver-rn
```

### 2. 微信支付集成

```typescript
// 初始化微信SDK (App.tsx)
import * as WeChat from 'react-native-wechat-lib';

WeChat.registerApp('你的微信AppID', '你的Universal Link');

// 调用支付 (PaymentScreen.tsx)
import * as WeChat from 'react-native-wechat-lib';

const handleWechatPay = async (payParams) => {
  try {
    const result = await WeChat.pay({
      partnerId: payParams.partnerid,
      prepayId: payParams.prepayid,
      nonceStr: payParams.noncestr,
      timeStamp: payParams.timestamp,
      package: payParams.package,
      sign: payParams.sign,
    });

    if (result.errCode === 0) {
      // 支付成功，轮询订单状态确认
      await checkOrderStatus(orderId);
    } else if (result.errCode === -2) {
      // 用户取消
      Alert.alert('提示', '您已取消支付');
    } else {
      // 支付失败
      Alert.alert('支付失败', result.errStr);
    }
  } catch (error) {
    Alert.alert('支付失败', error.message);
  }
};
```

### 3. 支付宝集成

```typescript
import { Linking } from 'react-native';

const handleAlipay = async (orderString: string) => {
  // 方法1: 使用 Linking 打开支付宝
  const alipayUrl = `alipay://alipayclient/?${encodeURIComponent(
    JSON.stringify({ requestType: 'SafePay', fromAppUrlScheme: 'piaoyuzhou', dataString: orderString })
  )}`;

  const canOpen = await Linking.canOpenURL(alipayUrl);
  if (canOpen) {
    await Linking.openURL(alipayUrl);
  } else {
    Alert.alert('提示', '请先安装支付宝');
  }

  // 方法2: 使用支付宝SDK
  // import Alipay from '@alipay/ariver-rn';
  // const result = await Alipay.pay(orderString);
};
```

### 4. iOS 配置

**Info.plist**
```xml
<!-- 微信 -->
<key>LSApplicationQueriesSchemes</key>
<array>
  <string>weixin</string>
  <string>weixinULAPI</string>
</array>

<key>CFBundleURLTypes</key>
<array>
  <dict>
    <key>CFBundleURLSchemes</key>
    <array>
      <string>wx你的AppID</string>
    </array>
  </dict>
</array>

<!-- 支付宝 -->
<key>LSApplicationQueriesSchemes</key>
<array>
  <string>alipay</string>
  <string>alipays</string>
</array>
```

### 5. Android 配置

**AndroidManifest.xml**
```xml
<!-- 微信支付 Activity -->
<activity
  android:name=".wxapi.WXPayEntryActivity"
  android:exported="true"
  android:launchMode="singleTop">
</activity>

<!-- 支付宝 -->
<activity
  android:name="com.alipay.sdk.app.PayResultActivity"
  android:exported="true">
</activity>
```

---

## 上线检查清单

### 微信支付

- [ ] 已在微信商户平台完成商户认证
- [ ] 已申请并开通APP支付权限
- [ ] 已设置API v3密钥
- [ ] 已下载并配置API证书
- [ ] 已配置正确的回调地址 (HTTPS)
- [ ] 回调地址已添加到商户平台白名单
- [ ] 已在移动端正确集成微信SDK
- [ ] 已测试沙箱环境支付流程
- [ ] 已测试生产环境小额支付

### 支付宝

- [ ] 已在支付宝开放平台创建应用
- [ ] 已申请并开通APP支付能力
- [ ] 已生成RSA2密钥对并配置
- [ ] 已配置正确的回调地址 (HTTPS)
- [ ] 已在移动端正确集成支付宝SDK
- [ ] 已测试沙箱环境支付流程
- [ ] 已测试生产环境小额支付

### 服务端

- [ ] 已正确配置所有环境变量
- [ ] 已执行数据库迁移
- [ ] 回调接口可被外网访问
- [ ] 已配置HTTPS证书
- [ ] 已设置适当的日志记录
- [ ] 已实现幂等性处理
- [ ] 已处理并发和重复请求

### 安全检查

- [ ] 私钥和密钥未提交到代码仓库
- [ ] 环境变量在服务器安全存储
- [ ] 回调签名验证已启用
- [ ] 金额校验已实现
- [ ] 订单状态校验已实现
- [ ] 防重放攻击机制已实现

---

## 常见问题

### Q1: 微信支付回调收不到

**可能原因：**
1. 回调地址不是HTTPS
2. 回调地址未在商户平台配置
3. 服务器防火墙拦截
4. 回调处理超时（需在5秒内返回）

**解决方案：**
1. 确保使用HTTPS且证书有效
2. 在商户平台配置回调地址
3. 检查服务器防火墙规则
4. 异步处理业务逻辑，先返回成功

### Q2: 支付宝签名验证失败

**可能原因：**
1. 使用了错误的公钥（应使用支付宝公钥，不是应用公钥）
2. 密钥格式不正确
3. 字符编码问题

**解决方案：**
1. 确认使用的是从支付宝获取的「支付宝公钥」
2. 密钥不要包含头尾标记和换行符
3. 使用UTF-8编码

### Q3: 如何处理支付超时

**处理流程：**
1. 订单创建时设置15分钟有效期
2. Hold记录也设置15分钟过期
3. 定时任务清理过期的Hold和订单
4. 用户重新下单时重新锁票

### Q4: 如何处理重复支付

**处理流程：**
1. 回调接口实现幂等性
2. 检查订单状态，已支付则直接返回成功
3. 使用数据库事务确保原子性
4. 记录transactionId防止重复

### Q5: 退款失败怎么办

**处理流程：**
1. 检查退款原因（余额不足、超时等）
2. 记录失败日志
3. 人工介入处理
4. 联系支付平台客服

---

## 相关文件

| 文件路径 | 说明 |
|---------|------|
| `apps/web/lib/payment.ts` | 支付核心工具库 |
| `apps/web/app/api/pay/wechat/route.ts` | 微信支付创建订单 |
| `apps/web/app/api/pay/alipay/route.ts` | 支付宝创建订单 |
| `apps/web/app/api/pay/wechat/notify/route.ts` | 微信回调处理 |
| `apps/web/app/api/pay/alipay/notify/route.ts` | 支付宝回调处理 |
| `apps/web/app/api/pay/mock/route.ts` | 模拟支付 |
| `apps/web/app/api/pay/refund/route.ts` | 退款处理 |
| `apps/mobile/src/screens/PaymentScreen.tsx` | 移动端支付页面 |
| `apps/mobile/src/services/orders.ts` | 移动端支付API |

---

## 技术支持

如有问题，请参考以下资源：

- [微信支付官方文档](https://pay.weixin.qq.com/wiki/doc/apiv3/wxpay/pages/index.shtml)
- [支付宝开放平台文档](https://opendocs.alipay.com/open/204/105051)
- [React Native 微信SDK](https://github.com/little-snow-fox/react-native-wechat-lib)
