# çºªå¿µå“ç³»ç»Ÿ - ç”Ÿäº§ç¯å¢ƒå®æ–½æ–¹æ¡ˆ

## ğŸ“‹ ä¸šåŠ¡æµç¨‹

### å½“å‰æµ‹è¯•ç¯å¢ƒ
```
ç”¨æˆ·è´­ç¥¨ â†’ æ”¯ä»˜æˆåŠŸ â†’ ç”¨æˆ·è‡ªå·±ç‚¹å‡»"æ£€ç¥¨"æŒ‰é’® â†’ è·å¾—çºªå¿µå“
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆæ­£å¼ä¸Šçº¿ï¼‰
```
ç”¨æˆ·è´­ç¥¨ â†’ æ”¯ä»˜æˆåŠŸ â†’ æ¼”å‡ºå½“å¤©åˆ°åœº â†’ å·¥ä½œäººå‘˜æ‰«ç éªŒç¥¨ â†’ è‡ªåŠ¨å‘æ”¾çºªå¿µå“ â†’ ç”¨æˆ·æŸ¥çœ‹æ”¶è—
```

---

## ğŸ¯ ç”Ÿäº§ç¯å¢ƒå®æ–½è¦ç‚¹

### 1. å‰ç«¯ä¿®æ”¹

#### ç§»é™¤ç”¨æˆ·ç«¯æ£€ç¥¨æŒ‰é’®
**æ–‡ä»¶**: `app/order/[id]/ui/OrderClient.tsx`

```tsx
// âŒ ç§»é™¤æ­¤éƒ¨åˆ†ä»£ç ï¼ˆç¬¬369-377è¡Œï¼‰
{ticket.status === 'sold' && (
  <button
    onClick={() => useTicket(ticket.id)}
    disabled={usingTicket === ticket.id}
    className="px-3 py-1.5 bg-gradient-to-r from-green-500 to-emerald-500 text-white text-xs rounded-lg"
  >
    {usingTicket === ticket.id ? 'æ£€ç¥¨ä¸­...' : 'ğŸ« æ£€ç¥¨'}
  </button>
)}
```

#### ä¿ç•™çš„ç”¨æˆ·åŠŸèƒ½
- âœ… æŸ¥çœ‹è®¢å•
- âœ… æŸ¥çœ‹ç¥¨ç å’ŒäºŒç»´ç ï¼ˆç”¨äºå·¥ä½œäººå‘˜æ‰«æï¼‰
- âœ… æŸ¥çœ‹"æˆ‘çš„æ”¶è—"ï¼ˆçºªå¿µå“ï¼‰
- âœ… é€€ç¥¨åŠŸèƒ½

---

### 2. åç«¯APIä¿®æ”¹

#### å¯ç”¨æ¼”å‡ºæ—¥æœŸæ£€æŸ¥
**æ–‡ä»¶**: `app/api/tickets/use/route.ts` (ç¬¬126-135è¡Œ)

```typescript
// âœ… å–æ¶ˆæ³¨é‡Šï¼Œå¯ç”¨æ—¥æœŸæ£€æŸ¥
if (today < eventDate) {
  return NextResponse.json(
    {
      ok: false,
      code: 'EVENT_NOT_STARTED',
      message: `æ´»åŠ¨å°šæœªå¼€å§‹ï¼Œæ¼”å‡ºæ—¥æœŸ: ${event.date}`,
    },
    { status: 400 }
  );
}
```

#### æ·»åŠ å·¥ä½œäººå‘˜æƒé™éªŒè¯

åœ¨ `app/api/tickets/use/route.ts` ä¸­æ·»åŠ ï¼š

```typescript
// éªŒè¯æ˜¯å¦ä¸ºå·¥ä½œäººå‘˜è´¦å·
const payload = verifyToken(token);
if (!payload || payload.role !== 'staff') {
  return NextResponse.json(
    {
      ok: false,
      code: 'PERMISSION_DENIED',
      message: 'ä»…å·¥ä½œäººå‘˜å¯ä»¥éªŒç¥¨',
    },
    { status: 403 }
  );
}
```

**éœ€è¦çš„æ•°æ®åº“æ”¹åŠ¨**ï¼š
1. åœ¨ `users` è¡¨æ·»åŠ  `role` å­—æ®µ (enum: 'user' | 'staff' | 'admin')
2. åˆ›å»ºå·¥ä½œäººå‘˜è´¦å·

---

### 3. å·¥ä½œäººå‘˜ç³»ç»Ÿå¼€å‘

#### 3.1 å·¥ä½œäººå‘˜ç™»å½•é¡µé¢
- ç‹¬ç«‹çš„å·¥ä½œäººå‘˜ç™»å½•å…¥å£
- éªŒè¯å·¥ä½œäººå‘˜æƒé™
- ç”Ÿæˆå¸¦æƒé™æ ‡è¯†çš„ JWT token

#### 3.2 æ‰«ç éªŒç¥¨ç•Œé¢
**è·¯å¾„**: `/staff/scan` (æ–°å»º)

**åŠŸèƒ½**ï¼š
- ğŸ“· è°ƒç”¨è®¾å¤‡æ‘„åƒå¤´æ‰«æäºŒç»´ç 
- ğŸ” è§£æç¥¨ç ï¼Œæ˜¾ç¤ºç¥¨ä¿¡æ¯
- âœ… ç¡®è®¤éªŒç¥¨ï¼Œè°ƒç”¨éªŒç¥¨API
- ğŸ‰ æ˜¾ç¤ºå‘æ”¾çš„çºªå¿µå“åˆ—è¡¨

**æŠ€æœ¯æ ˆ**ï¼š
- äºŒç»´ç æ‰«æï¼š`html5-qrcode` æˆ– `react-qr-scanner`
- æƒé™éªŒè¯ï¼šå·¥ä½œäººå‘˜ JWT token

#### 3.3 éªŒç¥¨å†å²æŸ¥è¯¢
- æŸ¥çœ‹ä»Šæ—¥éªŒç¥¨è®°å½•
- ç»Ÿè®¡å„ç¥¨æ¡£éªŒç¥¨æ•°é‡
- å¯¼å‡ºéªŒç¥¨æŠ¥è¡¨

---

### 4. äºŒç»´ç ç”Ÿæˆ

#### ç¥¨ç äºŒç»´ç å†…å®¹
```json
{
  "ticketId": "uuid",
  "ticketCode": "2025-0001-01-000001",
  "orderId": "O_xxx",
  "eventId": 1,
  "tierId": 101
}
```

#### ç”Ÿæˆä½ç½®
**é€‰é¡¹ 1**: è®¢å•è¯¦æƒ…é¡µç”Ÿæˆï¼ˆå‰ç«¯ï¼‰
```tsx
import QRCode from 'qrcode.react';

<QRCode
  value={JSON.stringify({
    ticketId: ticket.id,
    ticketCode: ticket.ticketCode,
    orderId: order.id,
    eventId: order.eventId,
    tierId: order.tierId
  })}
  size={256}
/>
```

**é€‰é¡¹ 2**: åç«¯ç”Ÿæˆå›¾ç‰‡URLï¼ˆæ¨èï¼‰
- è®¢å•æ”¯ä»˜æˆåŠŸåç”ŸæˆäºŒç»´ç å›¾ç‰‡
- å­˜å‚¨åˆ°äº‘å­˜å‚¨ï¼ˆå¦‚ AWS S3ï¼‰
- ç¥¨è®°å½•ä¸­ä¿å­˜å›¾ç‰‡URL
- é˜²æ­¢ç¯¡æ”¹ï¼Œå®‰å…¨æ€§æ›´é«˜

---

### 5. çºªå¿µå“å‘æ”¾è§„åˆ™

#### å½“å‰è§„åˆ™ï¼ˆå·²å®ç°ï¼‰
```typescript
// 1. ç¥¨æ¡£çºªå¿µå“ï¼šæ ¹æ® eventId + tierId åŒ¹é…
const tierBadges = await tx.badge.findMany({
  where: {
    eventId: ticket.eventId,
    tierId: ticket.tierId,
    isActive: true,
  },
});

// 2. æ´»åŠ¨çºªå¿µå“ï¼šæ‰€æœ‰ç¥¨æ¡£å…±äº«
const eventBadges = await tx.badge.findMany({
  where: {
    eventId: ticket.eventId,
    tierId: null,
    isActive: true,
  },
});
```

#### è§„åˆ™ç¤ºä¾‹
| ç¥¨æ¡£ç±»å‹ | è·å¾—çºªå¿µå“ |
|---------|-----------|
| å†…åœºç¥¨ | ç¥¨æ ¹ + é™é‡æµ·æŠ¥ + å‚ä¸çºªå¿µ |
| çœ‹å°Aç¥¨ | ç¥¨æ ¹ + å‚ä¸çºªå¿µ |
| çœ‹å°Bç¥¨ | ç¥¨æ ¹ + å‚ä¸çºªå¿µ |

#### ç¨€æœ‰åº¦è®¾è®¡
- **Commonï¼ˆæ™®é€šï¼‰**: ç¥¨æ ¹ - æ¯ä¸ªç¥¨æ¡£éƒ½æœ‰
- **Rareï¼ˆç¨€æœ‰ï¼‰**: å‚ä¸çºªå¿µ - æ‰€æœ‰ç¥¨æ¡£å…±äº«
- **Epicï¼ˆå²è¯—ï¼‰**: ç‰¹æ®Šæ´»åŠ¨çºªå¿µ - ç‰¹å®šæ¡ä»¶è§¦å‘
- **Legendaryï¼ˆä¼ è¯´ï¼‰**: é™é‡æµ·æŠ¥ - é«˜çº§ç¥¨æ¡£ä¸“å±

---

### 6. å®‰å…¨è€ƒè™‘

#### é˜²åˆ·ç¥¨
```typescript
// æ£€æŸ¥ç¥¨æ˜¯å¦å·²ä½¿ç”¨
if (ticket.status === 'used') {
  return NextResponse.json({
    ok: false,
    code: 'TICKET_ALREADY_USED',
    message: 'æ­¤ç¥¨å·²ä½¿ç”¨ï¼Œè¯·å‹¿é‡å¤éªŒç¥¨',
  }, { status: 400 });
}
```

#### é˜²ä¼ªé€ äºŒç»´ç 
- åç«¯ç”Ÿæˆç­¾åäºŒç»´ç 
- éªŒç¥¨æ—¶éªŒè¯ç­¾å
- é™åˆ¶éªŒç¥¨æ—¶é—´çª—å£ï¼ˆä»…æ¼”å‡ºå½“å¤©ï¼‰

#### æ“ä½œæ—¥å¿—
è®°å½•æ‰€æœ‰éªŒç¥¨æ“ä½œï¼š
```typescript
await tx.ticketLog.create({
  data: {
    ticketId,
    action: 'USE',
    staffId: payload.id,
    staffName: payload.name,
    timestamp: new Date(),
    metadata: JSON.stringify({
      deviceInfo: req.headers.get('user-agent'),
      location: 'æ¼”å‡ºç°åœºå…¥å£A',
    }),
  },
});
```

---

### 7. æµ‹è¯•è®¡åˆ’

#### åŠŸèƒ½æµ‹è¯•
- [ ] å·¥ä½œäººå‘˜ç™»å½•
- [ ] æ‰«ç è¯†åˆ«ç¥¨ç 
- [ ] éªŒè¯æ¼”å‡ºæ—¥æœŸé™åˆ¶
- [ ] éªŒè¯ç¥¨çŠ¶æ€ï¼ˆæœªä½¿ç”¨/å·²ä½¿ç”¨ï¼‰
- [ ] éªŒè¯æƒé™ï¼ˆæ™®é€šç”¨æˆ·æ— æ³•éªŒç¥¨ï¼‰
- [ ] çºªå¿µå“æ­£ç¡®å‘æ”¾
- [ ] ç”¨æˆ·æ”¶åˆ°çºªå¿µå“é€šçŸ¥

#### æ€§èƒ½æµ‹è¯•
- [ ] æ‰«ç å“åº”é€Ÿåº¦ < 1ç§’
- [ ] å¹¶å‘éªŒç¥¨ï¼ˆå¤šä¸ªå…¥å£åŒæ—¶éªŒç¥¨ï¼‰
- [ ] é«˜å³°æœŸéªŒç¥¨ï¼ˆæ¼”å‡ºå¼€åœºå‰30åˆ†é’Ÿï¼‰

#### å®‰å…¨æµ‹è¯•
- [ ] å°è¯•é‡å¤éªŒç¥¨
- [ ] å°è¯•ä¼ªé€ äºŒç»´ç 
- [ ] å°è¯•ä½¿ç”¨è¿‡æœŸç¥¨
- [ ] å°è¯•ä½¿ç”¨å·²é€€ç¥¨çš„ç¥¨ç 

---

### 8. ä¸Šçº¿æ£€æŸ¥æ¸…å•

#### ä»£ç ä¿®æ”¹
- [ ] ç§»é™¤å‰ç«¯æ£€ç¥¨æŒ‰é’®
- [ ] å¯ç”¨æ¼”å‡ºæ—¥æœŸæ£€æŸ¥
- [ ] æ·»åŠ å·¥ä½œäººå‘˜æƒé™éªŒè¯
- [ ] æ·»åŠ æ“ä½œæ—¥å¿—è®°å½•

#### æ•°æ®å‡†å¤‡
- [ ] åˆ›å»ºå·¥ä½œäººå‘˜è´¦å·
- [ ] é…ç½®çºªå¿µå“è§„åˆ™
- [ ] æµ‹è¯•äºŒç»´ç ç”Ÿæˆ

#### å·¥ä½œäººå‘˜åŸ¹è®­
- [ ] åŸ¹è®­æ‰«ç éªŒç¥¨æµç¨‹
- [ ] åŸ¹è®­å¼‚å¸¸æƒ…å†µå¤„ç†
- [ ] å‡†å¤‡åº”æ€¥é¢„æ¡ˆ

#### æŠ€æœ¯ä¿éšœ
- [ ] å‡†å¤‡å¤‡ç”¨éªŒç¥¨è®¾å¤‡
- [ ] ç¡®ä¿ç°åœºç½‘ç»œç¨³å®š
- [ ] å‡†å¤‡ç¦»çº¿éªŒç¥¨æ–¹æ¡ˆ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚éœ€å®æ–½ç”Ÿäº§ç¯å¢ƒæ–¹æ¡ˆï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºè¿›è¡Œï¼š

1. **é˜¶æ®µ1**ï¼šæ•°æ®åº“æ‰©å±•ï¼ˆæ·»åŠ  role å­—æ®µï¼‰
2. **é˜¶æ®µ2**ï¼šå·¥ä½œäººå‘˜ç³»ç»Ÿå¼€å‘ï¼ˆç™»å½• + æ‰«ç ç•Œé¢ï¼‰
3. **é˜¶æ®µ3**ï¼šäºŒç»´ç ç”Ÿæˆï¼ˆå‰ç«¯æˆ–åç«¯ï¼‰
4. **é˜¶æ®µ4**ï¼šæƒé™éªŒè¯å’Œå®‰å…¨åŠ å›º
5. **é˜¶æ®µ5**ï¼šç°åœºæµ‹è¯•å’Œè°ƒä¼˜

é¢„è®¡å¼€å‘æ—¶é—´ï¼š**2-3å‘¨**

---

## ğŸ‰ å½“å‰æµ‹è¯•åŠŸèƒ½

ç°åœ¨ç³»ç»Ÿå¤„äº**æµ‹è¯•æ¨¡å¼**ï¼Œç”¨æˆ·å¯ä»¥ï¼š
1. è´­ç¥¨å¹¶æ”¯ä»˜
2. åœ¨è®¢å•è¯¦æƒ…é¡µç‚¹å‡»"ğŸ« æ£€ç¥¨"æŒ‰é’®
3. ç«‹å³è·å¾—çºªå¿µå“ï¼ˆæ— éœ€ç­‰åˆ°æ¼”å‡ºå½“å¤©ï¼‰
4. åœ¨"æˆ‘çš„æ”¶è—"ä¸­æŸ¥çœ‹çºªå¿µå“

è¿™ä¸ªæµ‹è¯•åŠŸèƒ½æ–¹ä¾¿å¼€å‘å’Œæ¼”ç¤ºï¼Œ**ä¸Šçº¿å‰éœ€è¦æŒ‰ç…§æœ¬æ–‡æ¡£è¿›è¡Œç”Ÿäº§åŒ–æ”¹é€ **ã€‚
