# 票次元 (Piaociyuan) - 项目文件结构说明

## 项目概述

票次元是一个现代化的票务平台，支持演唱会、音乐节等活动的在线购票，集成了NFT电子潮玩、社交功能等特性。

**技术栈**: Next.js 16 + React 19 + TypeScript + PostgreSQL + Prisma ORM

---

## 目录结构总览

```
piaoyuzhou/
├── app/                    # Next.js App Router 应用目录
├── components/             # React 可复用组件
├── lib/                    # 核心工具库
├── prisma/                 # 数据库相关
├── scripts/                # 工具脚本
├── docs/                   # 项目文档
├── public/                 # 静态资源
└── [配置文件]              # 项目配置
```

---

## 一、根目录配置文件

### TypeScript 配置
| 文件名 | 语言 | 作用 |
|--------|------|------|
| `tsconfig.json` | JSON | TypeScript 编译器配置，定义路径别名 `@/*`，启用严格模式 |
| `next-env.d.ts` | TypeScript | Next.js 自动生成的类型声明文件 |

### Next.js 配置
| 文件名 | 语言 | 作用 |
|--------|------|------|
| `next.config.ts` | TypeScript | Next.js 框架配置文件 |
| `postcss.config.mjs` | JavaScript | PostCSS 配置（Tailwind CSS 依赖） |

### 代码质量
| 文件名 | 语言 | 作用 |
|--------|------|------|
| `eslint.config.mjs` | JavaScript | ESLint 代码规范配置 |

### 包管理
| 文件名 | 语言 | 作用 |
|--------|------|------|
| `package.json` | JSON | 项目依赖管理、脚本定义 |
| `package-lock.json` | JSON | 锁定依赖版本 |

### 文档
| 文件名 | 语言 | 作用 |
|--------|------|------|
| `README.md` | Markdown | 项目说明文档，包含快速开始指南 |

---

## 二、app/ 目录（Next.js App Router）

### 全局文件
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `app/layout.tsx` | TypeScript/React | 全局布局组件，包含导航栏、侧边栏 |
| `app/page.tsx` | TypeScript/React | 首页（活动列表） |
| `app/globals.css` | CSS | 全局样式，Tailwind CSS 配置 |
| `app/favicon.ico` | 图标 | 网站图标 |

### 认证模块 (`app/auth/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `auth/login/page.tsx` | TypeScript/React | 登录页面 |
| `auth/register/page.tsx` | TypeScript/React | 注册页面 |

### 用户账户 (`app/account/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `account/page.tsx` | TypeScript/React | 用户主页 |
| `account/settings/page.tsx` | TypeScript/React | 账户设置页面 |
| `account/orders/page.tsx` | TypeScript/React | 订单管理页面 |
| `account/favorites/page.tsx` | TypeScript/React | 收藏活动页面 |
| `account/favorites/ui/FavoritesClient.tsx` | TypeScript/React | 收藏页面客户端组件 |

#### NFT 管理 (`app/account/nfts/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `nfts/page.tsx` | TypeScript/React | 用户 NFT 收藏页面 |
| `nfts/ui/NFTsClient.tsx` | TypeScript/React | NFT 列表客户端组件 |
| `nfts/[tokenId]/page.tsx` | TypeScript/React | NFT 详情页（动态路由） |
| `nfts/[tokenId]/ui/NFTDetailClient.tsx` | TypeScript/React | NFT 详情客户端组件 |

### 活动模块 (`app/events/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `events/page.tsx` | TypeScript/React | 活动列表页 |
| `events/[id]/page.tsx` | TypeScript/React | 活动详情页（动态路由） |
| `events/[id]/components/FollowButton.tsx` | TypeScript/React | 关注活动按钮组件 |
| `events/[id]/components/SeatSelection.tsx` | TypeScript/React | 座位选择组件 |

### 购票流程
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `checkout/page.tsx` | TypeScript/React | 结算页面（选座、确认） |
| `checkout/ui/CheckoutClient.tsx` | TypeScript/React | 结算页面客户端组件 |
| `order/[id]/page.tsx` | TypeScript/React | 订单详情页 |
| `order/[id]/ui/OrderClient.tsx` | TypeScript/React | 订单详情客户端组件 |
| `order/[id]/readme.md` | Markdown | 订单模块说明文档 |

### 社交功能 (`app/encore/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `encore/page.tsx` | TypeScript/React | 社交动态页面（帖子列表） |
| `encore/ui/EncoreClient.tsx` | TypeScript/React | 动态页面客户端组件 |
| `encore/[id]/page.tsx` | TypeScript/React | 帖子详情页 |
| `encore/[id]/ui/PostDetailClient.tsx` | TypeScript/React | 帖子详情客户端组件 |

### 私信功能 (`app/messages/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `messages/page.tsx` | TypeScript/React | 消息列表页 |
| `messages/[id]/page.tsx` | TypeScript/React | 会话详情页 |
| `messages/new/page.tsx` | TypeScript/React | 新建消息页 |

---

## 三、app/api/ 目录（API 路由）

### 认证 API (`app/api/auth/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `auth/register/route.ts` | TypeScript | 用户注册 |
| `auth/login/route.ts` | TypeScript | 用户登录 |
| `auth/logout/route.ts` | TypeScript | 用户登出 |
| `auth/me/route.ts` | TypeScript | 获取当前用户信息 |
| `auth/refresh/route.ts` | TypeScript | 刷新 JWT Token |
| `auth/send-code/route.ts` | TypeScript | 发送验证码 |

### 活动 API (`app/api/events/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `events/route.ts` | TypeScript | 获取活动列表 |
| `events/[id]/route.ts` | TypeScript | 获取活动详情 |
| `events/[id]/follow/route.ts` | TypeScript | 关注/取消关注活动 |

### 票务 API
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `tiers/route.ts` | TypeScript | 获取票档信息 |
| `holds/route.ts` | TypeScript | 创建锁票（高并发抢票） |
| `tickets/hold-smart/route.ts` | TypeScript | 智能锁票（自动/手动选座切换） |
| `tickets/my-tickets/route.ts` | TypeScript | 获取我的票 |
| `tickets/refund/route.ts` | TypeScript | 退票 |
| `tickets/use/route.ts` | TypeScript | 使用票 |
| `tickets/verify/route.ts` | TypeScript | 验证票码 |

### 订单 API (`app/api/orders/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `orders/route.ts` | TypeScript | 创建订单、获取订单列表 |
| `orders/[id]/route.ts` | TypeScript | 获取订单详情 |

### 支付 API (`app/api/pay/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `pay/mock/route.ts` | TypeScript | 模拟支付接口（开发测试用） |

### NFT API (`app/api/nft/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `nft/assets/[tokenId]/route.ts` | TypeScript | 获取 NFT 详情 |
| `nft/assets/my/route.ts` | TypeScript | 获取我的 NFT 列表 |
| `nft/mint/request/route.ts` | TypeScript | 请求铸造 NFT |
| `nft/mint/status/[orderId]/route.ts` | TypeScript | 查询铸造状态 |
| `nft/wallet/bind/route.ts` | TypeScript | 绑定钱包地址 |
| `nft/wallet/status/route.ts` | TypeScript | 获取钱包绑定状态 |

### 社交 API
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `posts/route.ts` | TypeScript | 获取帖子列表、创建帖子 |
| `posts/[id]/route.ts` | TypeScript | 获取/删除帖子 |
| `posts/[id]/like/route.ts` | TypeScript | 点赞/取消点赞 |
| `posts/[id]/comments/route.ts` | TypeScript | 获取评论、发表评论 |

### 私信 API (`app/api/messages/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `messages/route.ts` | TypeScript | 发送消息 |
| `messages/conversations/route.ts` | TypeScript | 获取会话列表 |
| `messages/conversations/[id]/route.ts` | TypeScript | 获取会话详情 |

### 通知 API (`app/api/notifications/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `notifications/route.ts` | TypeScript | 获取通知列表 |
| `notifications/[id]/read/route.ts` | TypeScript | 标记通知为已读 |
| `notifications/read-all/route.ts` | TypeScript | 标记所有通知为已读 |

### 用户 API (`app/api/user/`, `app/api/users/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `user/update/route.ts` | TypeScript | 更新用户信息 |
| `user/follows/route.ts` | TypeScript | 获取关注列表 |
| `user/nfts/route.ts` | TypeScript | 获取用户 NFT |
| `user/nfts/[id]/route.ts` | TypeScript | 获取用户 NFT 详情 |
| `users/[id]/follow/route.ts` | TypeScript | 关注/取消关注用户 |
| `users/search/route.ts` | TypeScript | 搜索用户 |

### 管理员 API (`app/api/admin/`)
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `admin/users/[id]/role/route.ts` | TypeScript | 修改用户角色 |

### API 文档
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `api/readme.md` | Markdown | API 接口说明文档 |

---

## 四、lib/ 目录（核心工具库）

| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `lib/auth.ts` | TypeScript | JWT 认证逻辑（生成/验证 Token） |
| `lib/session.ts` | TypeScript | 会话管理（Session） |
| `lib/prisma.ts` | TypeScript | Prisma 客户端单例 |
| `lib/database.ts` | TypeScript | 数据库操作封装（向后兼容层） |
| `lib/inventory.ts` | TypeScript | **高并发库存管理**（FOR UPDATE SKIP LOCKED） |
| `lib/ticket-strategy.ts` | TypeScript | **智能选座策略**（自动/手动切换） |
| `lib/verification.ts` | TypeScript | 验证码生成与验证 |
| `lib/encryption.ts` | TypeScript | 数据加密工具（AES-256-GCM） |
| `lib/store.ts` | TypeScript | 内存存储（开发测试用） |
| `lib/mock.ts` | TypeScript | Mock 数据生成 |
| `lib/api.ts` | TypeScript | API 客户端封装（Fetch 封装） |

---

## 五、components/ 目录（React 组件）

| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `components/Sidebar.tsx` | TypeScript/React | 左侧导航栏组件 |
| `components/RightSidebar.tsx` | TypeScript/React | 右侧边栏组件 |
| `components/WalletConnectButton.tsx` | TypeScript/React | 钱包连接按钮（Web3） |
| `components/MintNFTButton.tsx` | TypeScript/React | 铸造 NFT 按钮 |
| `components/NFTComponents.tsx` | TypeScript/React | NFT 相关组件集合 |

---

## 六、prisma/ 目录（数据库）

### 核心文件
| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `prisma/schema.prisma` | Prisma Schema | **数据库模型定义**（28个表） |
| `prisma/seed.ts` | TypeScript | 种子数据脚本（生成测试数据） |

### 数据迁移
| 目录路径 | 说明 |
|----------|------|
| `prisma/migrations/` | 包含所有数据库迁移记录 |
| `prisma/migrations/migration_lock.toml` | 迁移锁文件（PostgreSQL） |

#### 主要迁移文件
| 迁移文件 | 说明 |
|----------|------|
| `20251030132803_init_postgresql/` | 初始化 PostgreSQL 数据库 |
| `20251030143159_add_ticket_table/` | 添加票表 |
| `20251030190350_add_badge_system/` | 添加徽章系统（已废弃） |
| `20251101224606_add_follow_and_notification_system/` | 添加关注和通知系统 |
| `20251102000000_add_nft_fields_to_ticket/` | 票表添加 NFT 字段 |
| `20251103034309_add_user_follows/` | 添加用户关注表 |

### 数据库表结构总览（28张表）

#### 核心业务表
- `events` - 活动表
- `tiers` - 票档表
- `tickets` - 票表（包含 NFT 绑定字段）
- `orders` - 订单表
- `holds` - 锁票表（高并发）

#### 用户系统
- `users` - 用户表（包含钱包、认证信息）
- `user_sessions` - 会话表
- `login_logs` - 登录日志
- `verification_codes` - 验证码表

#### NFT 系统
- `nfts` - NFT 资产表（类型、稀有度、3D/AR）
- `user_nfts` - 用户 NFT 持有记录
- `nft_mint_queue` - NFT 铸造队列
- `nft_transactions` - NFT 交易记录
- `nft_config` - NFT 配置表

#### 社交系统
- `posts` - 帖子表
- `post_images` - 帖子图片
- `post_likes` - 点赞表
- `post_views` - 浏览记录
- `comments` - 评论表

#### 私信系统
- `conversations` - 会话表
- `conversation_participants` - 会话参与者
- `messages` - 消息表

#### 关注系统
- `event_follows` - 活动关注
- `user_follows` - 用户关注
- `notifications` - 通知表

---

## 七、scripts/ 目录（工具脚本）

| 文件路径 | 语言 | 作用 |
|----------|------|------|
| `scripts/create-tickets.ts` | TypeScript | 批量生成票务数据 |
| `scripts/fill-test-users.ts` | TypeScript | 填充测试用户 |
| `scripts/seed-posts.ts` | TypeScript | 填充测试帖子 |
| `scripts/test-concurrency.ts` | TypeScript | **高并发抢票压力测试** |
| `scripts/view-postgres-users.js` | JavaScript | 查看 PostgreSQL 用户数据 |

---

## 八、docs/ 目录（项目文档）

| 文件名 | 语言 | 作用 |
|--------|------|------|
| `API概览.md` | Markdown | API 接口总览 |
| `database-queries.md` | Markdown | 数据库查询示例 |
| `NFT-API文档.md` | Markdown | NFT API 详细文档 |
| `NFT功能实现说明.md` | Markdown | NFT 功能实现细节 |
| `NFT功能待完成事项.md` | Markdown | NFT 待开发功能清单 |
| `NFT前端集成完成报告.md` | Markdown | NFT 前端集成报告 |
| `票次元加入NFT电子潮玩功能指南.md` | Markdown | NFT 集成指南 |
| `third-party-auth.md` | Markdown | 第三方登录文档 |
| `user-data-storage-best-practices.md` | Markdown | 数据存储最佳实践 |
| `团队协作数据库配置.md` | Markdown | 团队数据库配置指南 |
| `大麦网式智能购票机制.md` | Markdown | **智能抢票机制说明** |
| `数据库架构重构方案.md` | Markdown | 数据库架构设计 |
| `票务数据库构造.md` | Markdown | 票务数据库设计 |
| `管理员方案.md` | Markdown | 管理员权限设计 |
| `购票系统功能对比与规划.md` | Markdown | 功能规划文档 |
| `配色与字体设计文档.md` | Markdown | UI 设计规范 |
| `验证码+安全文档1号.md` | Markdown | 安全机制文档 |
| `高并发优化总结.md` | Markdown | **高并发优化总结** |

---

## 九、public/ 目录（静态资源）

| 文件路径 | 格式 | 作用 |
|----------|------|------|
| `public/file.svg` | SVG | 文件图标 |
| `public/globe.svg` | SVG | 地球图标 |
| `public/next.svg` | SVG | Next.js Logo |
| `public/vercel.svg` | SVG | Vercel Logo |
| `public/window.svg` | SVG | 窗口图标 |

---

## 十、核心技术架构

### 1. 高并发抢票机制
- **文件**: `lib/inventory.ts`, `lib/ticket-strategy.ts`
- **技术**: PostgreSQL `FOR UPDATE SKIP LOCKED` 悲观锁
- **特性**:
  - 开售初期：强制自动分配（防止超卖）
  - 开售后期：支持手动选座
  - 自动切换策略

### 2. JWT 认证系统
- **文件**: `lib/auth.ts`, `lib/session.ts`
- **特性**:
  - Access Token + Refresh Token 双 Token 机制
  - Session 管理
  - 多设备登录支持

### 3. NFT 系统
- **文件**: `app/api/nft/*`, `components/NFTComponents.tsx`
- **特性**:
  - 3D/AR 模型支持
  - 区块链集成（以太坊）
  - 铸造队列管理

### 4. 社交系统
- **文件**: `app/encore/*`, `app/api/posts/*`
- **特性**:
  - 帖子、评论、点赞
  - 私信功能
  - 关注系统

---

## 十一、npm 脚本说明

| 命令 | 作用 |
|------|------|
| `npm run dev` | 启动开发服务器（Turbopack） |
| `npm run build` | 构建生产版本 |
| `npm run start` | 启动生产服务器 |
| `npm run lint` | 运行 ESLint 检查 |
| `npm run db:seed` | 填充种子数据 |
| `npm run db:create-tickets` | 生成票务数据 |
| `npm run studio` | 启动 Prisma Studio |
| `npm run db:studio` | 启动 Prisma Studio（带环境变量） |

---

## 十二、环境要求

- **Node.js**: 20+
- **数据库**: PostgreSQL 12+ (或 SQLite)
- **包管理器**: npm / yarn / pnpm

---

## 附录：技术选型依赖

### 核心框架
- `next` 16.0.0 - React 全栈框架
- `react` 19.2.0 - UI 库
- `typescript` 5+ - 类型系统

### 数据库
- `@prisma/client` 6.18.0 - ORM
- `pg` 8.16.3 - PostgreSQL 驱动

### 认证加密
- `jsonwebtoken` - JWT 认证
- `bcryptjs` - 密码哈希
- `argon2` - 密码哈希（高级）
- `jose` - JWT 处理库

### 区块链
- `ethers` 5.7.2 - 以太坊 JavaScript 库

### 样式
- `tailwindcss` 4 - CSS 框架
- `lucide-react` - 图标库

---

**文档生成日期**: 2025-11-03
**项目维护**: 票次元开发团队
