# å¤§éº¦ç½‘å¼æ™ºèƒ½è´­ç¥¨æœºåˆ¶

## ğŸ¯ è®¾è®¡ç†å¿µ

**å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œç”¨æˆ·æ— éœ€é€‰æ‹©æ¨¡å¼**ï¼Œç³»ç»Ÿæ ¹æ®åœºæ™¯è‡ªåŠ¨åˆ‡æ¢ï¼š

```
å¼€å”®åˆæœŸï¼ˆé«˜å¹¶å‘ï¼‰ â†’ å¼ºåˆ¶è‡ªåŠ¨åˆ†é…ï¼ˆSKIP LOCKEDï¼‰
å¼€å”®åæœŸï¼ˆä½å¹¶å‘ï¼‰ â†’ å…è®¸æ‰‹åŠ¨é€‰åº§ï¼ˆä¹è§‚é”ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç”¨æˆ·ä½“éªŒç®€å•ï¼Œæ— éœ€ç†è§£ä¸¤ç§æ¨¡å¼
- âœ… é«˜å¹¶å‘æ—¶æ€§èƒ½æœ€ä¼˜ï¼ˆè‡ªåŠ¨åˆ†é…ï¼‰
- âœ… ä½å¹¶å‘æ—¶ä½“éªŒæœ€å¥½ï¼ˆå¯ä»¥é€‰åº§ï¼‰
- âœ… é¿å…ç”¨æˆ·é€‰é”™æ¨¡å¼åçš„æŠ±æ€¨
- âœ… å‡å°‘å‰ç«¯å¤æ‚åº¦å’Œæµ‹è¯•æˆæœ¬

## ğŸ“‹ ç­–ç•¥è§„åˆ™

### è§„åˆ™ 1ï¼šåŸºäºå¼€å”®æ—¶é—´

```
å¼€å”®å 0-10 åˆ†é’Ÿ â†’ AUTOï¼ˆè‡ªåŠ¨åˆ†é…ï¼‰
å¼€å”®å 10 åˆ†é’Ÿ+ â†’ MANUALï¼ˆå¯é€‰åº§ï¼‰
```

**åŸå› **ï¼š
- å¼€å”®åˆæœŸæµé‡æœ€å¤§ï¼ˆä¸‡äººæŠ¢ç¥¨ï¼‰
- 10 åˆ†é’Ÿåæµé‡ä¸‹é™ï¼Œå¯ä»¥å…è®¸é€‰åº§

### è§„åˆ™ 2ï¼šåŸºäºå¹¶å‘åº¦

```
æœ€è¿‘ 1 åˆ†é’Ÿè¯·æ±‚æ•° > 100 â†’ AUTOï¼ˆè‡ªåŠ¨åˆ†é…ï¼‰
æœ€è¿‘ 1 åˆ†é’Ÿè¯·æ±‚æ•° â‰¤ 100 â†’ MANUALï¼ˆå¯é€‰åº§ï¼‰
```

**åŸå› **ï¼š
- å³ä½¿å¼€å”®åæœŸï¼Œä¹Ÿå¯èƒ½å‡ºç°çªå‘æµé‡
- åŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼Œä¿è¯ç³»ç»Ÿç¨³å®š

## ğŸ”§ æ ¸å¿ƒä»£ç 

### ç­–ç•¥åˆ¤æ–­é€»è¾‘

```typescript
// lib/ticket-strategy.ts

export async function determineTicketMode(
  eventId: string,
  tierId: string
): Promise<'AUTO' | 'MANUAL'> {
  // 1. æ£€æŸ¥è·ç¦»å¼€å”®çš„æ—¶é—´
  const minutesSinceSaleStart = calculateMinutes();

  // å¼€å”®å 10 åˆ†é’Ÿå†…å¼ºåˆ¶è‡ªåŠ¨åˆ†é…
  if (minutesSinceSaleStart < 10) {
    return 'AUTO';
  }

  // 2. æ£€æŸ¥å½“å‰å¹¶å‘åº¦
  const recentRequests = await countRecentHolds();

  // é«˜å¹¶å‘æ—¶å¼ºåˆ¶è‡ªåŠ¨åˆ†é…
  if (recentRequests > 100) {
    return 'AUTO';
  }

  // 3. ä½å¹¶å‘æ—¶å…è®¸æ‰‹åŠ¨é€‰åº§
  return 'MANUAL';
}
```

### ç»Ÿä¸€è´­ç¥¨å…¥å£

```typescript
export async function holdTickets(params: {
  eventId: string;
  tierId: string;
  qty?: number;              // è‡ªåŠ¨åˆ†é…æ—¶éœ€è¦
  specificSeatIds?: string[]; // æ‰‹åŠ¨é€‰åº§æ—¶å¯é€‰
}) {
  // è‡ªåŠ¨åˆ¤æ–­æ¨¡å¼
  const mode = await determineTicketMode(eventId, tierId);

  if (mode === 'AUTO' || !params.specificSeatIds) {
    // è‡ªåŠ¨åˆ†é…ï¼ˆSKIP LOCKEDï¼‰
    return autoAssignSeats(params);
  } else {
    // æ‰‹åŠ¨é€‰åº§ï¼ˆä¹è§‚é”ï¼‰
    return manualSelectSeats(params);
  }
}
```

## ğŸ’» å‰ç«¯ä½¿ç”¨

### æ–¹å¼ 1ï¼šåªè´­ä¹°æ•°é‡ï¼ˆå¼€å”®åˆæœŸï¼‰

```typescript
// å‰ç«¯ï¼šç”¨æˆ·åªé€‰æ‹©æ•°é‡ï¼Œä¸é€‰åº§ä½
const response = await fetch('/api/tickets/hold-smart', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    eventId: '1',
    tierId: '1',
    qty: 2, // è´­ä¹° 2 å¼ 
  }),
});

const result = await response.json();
// {
//   ok: true,
//   mode: 'AUTO',
//   message: 'ç³»ç»Ÿå·²ä¸ºæ‚¨è‡ªåŠ¨åˆ†é…åº§ä½',
//   data: {
//     holdId: 'H_xxx',
//     expireAt: 1234567890,
//     ticketIds: ['TICKET_1', 'TICKET_2']
//   }
// }
```

### æ–¹å¼ 2ï¼šæ‰‹åŠ¨é€‰åº§ï¼ˆä½å¹¶å‘æ—¶ï¼‰

```typescript
// 1. å…ˆè·å–åº§ä½çŠ¶æ€
const seats = await fetch(
  '/api/tickets/hold-smart?eventId=1&tierId=1'
).then(r => r.json());

// seats.data = [
//   { id: 'A1', seatNumber: 'A-01', status: 'available', remainingSeconds: null },
//   { id: 'A2', seatNumber: 'A-02', status: 'locked', remainingSeconds: 180 },
//   { id: 'A3', seatNumber: 'A-03', status: 'sold', remainingSeconds: null },
// ]

// 2. ç”¨æˆ·é€‰æ‹©åº§ä½åï¼Œå°è¯•é”å®š
const response = await fetch('/api/tickets/hold-smart', {
  method: 'POST',
  body: JSON.stringify({
    eventId: '1',
    tierId: '1',
    specificSeatIds: ['A1', 'A4'], // ç”¨æˆ·é€‰æ‹©çš„åº§ä½
  }),
});

const result = await response.json();
// å¦‚æœå½“å‰æ˜¯ AUTO æ¨¡å¼ï¼Œä¼šå¿½ç•¥ specificSeatIdsï¼Œè‡ªåŠ¨åˆ†é…
// å¦‚æœå½“å‰æ˜¯ MANUAL æ¨¡å¼ï¼Œä¼šå°è¯•é”å®šæŒ‡å®šåº§ä½
```

### å‰ç«¯ç»„ä»¶ç¤ºä¾‹

```tsx
// components/TicketPurchase.tsx
'use client';

import { useState, useEffect } from 'react';

export default function TicketPurchase({ eventId, tierId }) {
  const [seats, setSeats] = useState([]);
  const [selectedSeats, setSelectedSeats] = useState<string[]>([]);
  const [mode, setMode] = useState<'AUTO' | 'MANUAL' | null>(null);

  // æ¯ 3 ç§’åˆ·æ–°åº§ä½çŠ¶æ€
  useEffect(() => {
    const fetchSeats = async () => {
      const res = await fetch(`/api/tickets/hold-smart?eventId=${eventId}&tierId=${tierId}`);
      const data = await res.json();
      setSeats(data.data);
    };

    fetchSeats();
    const timer = setInterval(fetchSeats, 3000);
    return () => clearInterval(timer);
  }, [eventId, tierId]);

  const handlePurchase = async () => {
    const body = selectedSeats.length > 0
      ? { eventId, tierId, specificSeatIds: selectedSeats }
      : { eventId, tierId, qty: 1 };

    const res = await fetch('/api/tickets/hold-smart', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(body),
    });

    const result = await res.json();

    if (result.ok) {
      setMode(result.mode);
      if (result.mode === 'AUTO') {
        alert(`ç³»ç»Ÿä¸ºæ‚¨è‡ªåŠ¨åˆ†é…äº†åº§ä½ï¼š${result.data.ticketIds.join(', ')}`);
      } else {
        alert(`å·²æˆåŠŸé”å®šæ‚¨é€‰æ‹©çš„åº§ä½`);
      }
      // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
      window.location.href = `/order/${result.data.holdId}`;
    } else {
      alert(result.error);
    }
  };

  return (
    <div>
      <h2>é€‰æ‹©åº§ä½</h2>

      {/* åº§ä½å›¾ */}
      <div className="seat-map">
        {seats.map((seat) => (
          <button
            key={seat.id}
            disabled={seat.status !== 'available'}
            onClick={() => {
              if (selectedSeats.includes(seat.id)) {
                setSelectedSeats(selectedSeats.filter(id => id !== seat.id));
              } else {
                setSelectedSeats([...selectedSeats, seat.id]);
              }
            }}
            className={`
              ${seat.status === 'sold' ? 'bg-gray-300' : ''}
              ${seat.status === 'locked' ? 'bg-yellow-200' : ''}
              ${seat.status === 'available' ? 'bg-green-200' : ''}
              ${selectedSeats.includes(seat.id) ? 'ring-2 ring-blue-500' : ''}
            `}
          >
            {seat.seatNumber}
            {seat.status === 'locked' && (
              <span className="text-xs">
                ğŸ”’ {Math.floor(seat.remainingSeconds / 60)}:{seat.remainingSeconds % 60}
              </span>
            )}
          </button>
        ))}
      </div>

      {/* è´­ç¥¨æŒ‰é’® */}
      <button onClick={handlePurchase}>
        {selectedSeats.length > 0
          ? `é”å®šæ‰€é€‰åº§ä½ (${selectedSeats.length} å¼ )`
          : 'å¿«é€ŸæŠ¢ç¥¨ï¼ˆç³»ç»Ÿè‡ªåŠ¨åˆ†é…ï¼‰'}
      </button>

      {/* æç¤ºä¿¡æ¯ */}
      <p className="text-sm text-gray-500">
        ğŸ’¡ æç¤ºï¼š
        {selectedSeats.length > 0
          ? 'æ‚¨å¯ä»¥é€‰æ‹©åº§ä½ï¼Œä½†åœ¨é«˜å¹¶å‘æ—¶ç³»ç»Ÿå¯èƒ½è‡ªåŠ¨åˆ†é…'
          : 'ç‚¹å‡»åº§ä½å¯ä»¥æ‰‹åŠ¨é€‰åº§ï¼Œæˆ–ç›´æ¥å¿«é€ŸæŠ¢ç¥¨'}
      </p>
    </div>
  );
}
```

## ğŸ¬ ç”¨æˆ·ä½“éªŒæµç¨‹

### åœºæ™¯ 1ï¼šå¼€å”®åˆæœŸï¼ˆé«˜å¹¶å‘ï¼‰

```
ç”¨æˆ·è®¿é—®è´­ç¥¨é¡µé¢
  â†“
ç³»ç»Ÿæ˜¾ç¤ºåº§ä½å›¾ï¼ˆä½†æ‰€æœ‰åº§ä½éƒ½æ˜¯å¯ç‚¹å‡»çš„ï¼‰
  â†“
ç”¨æˆ·é€‰æ‹© A1, A2 ä¸¤ä¸ªåº§ä½
  â†“
ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤è´­ä¹°"
  â†“
åç«¯åˆ¤æ–­ï¼šå½“å‰æ˜¯ AUTO æ¨¡å¼
  â†“
å¿½ç•¥ç”¨æˆ·é€‰æ‹©ï¼Œè‡ªåŠ¨åˆ†é… B3, B4ï¼ˆå› ä¸º A æ’å·²è¢«æŠ¢ï¼‰
  â†“
å‰ç«¯æç¤ºï¼š"å½“å‰ä¸ºå¼€å”®é«˜å³°æœŸï¼Œç³»ç»Ÿå·²ä¸ºæ‚¨è‡ªåŠ¨åˆ†é…åº§ä½ B3, B4"
  â†“
è·³è½¬åˆ°è®¢å•é¡µé¢
```

**ç”¨æˆ·æ„Ÿå—**ï¼š
- è™½ç„¶æ²¡é€‰åˆ° A æ’ï¼Œä½†æŠ¢åˆ°ç¥¨äº†ï¼ˆæ€»æ¯”æ²¡ç¥¨å¥½ï¼‰
- ç†è§£æ˜¯é«˜å³°æœŸçš„æ­£å¸¸ç°è±¡

### åœºæ™¯ 2ï¼šå¼€å”®åæœŸï¼ˆä½å¹¶å‘ï¼‰

```
ç”¨æˆ·è®¿é—®è´­ç¥¨é¡µé¢ï¼ˆå¼€å”® 15 åˆ†é’Ÿåï¼‰
  â†“
ç³»ç»Ÿæ˜¾ç¤ºåº§ä½å›¾ï¼Œå®æ—¶åˆ·æ–°çŠ¶æ€
  â†“
ç”¨æˆ·é€‰æ‹© A1, A2
  â†“
ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤è´­ä¹°"
  â†“
åç«¯åˆ¤æ–­ï¼šå½“å‰æ˜¯ MANUAL æ¨¡å¼
  â†“
å°è¯•é”å®š A1, A2
  â†“
  â”œâ”€ æˆåŠŸ â†’ è·³è½¬è®¢å•é¡µé¢
  â””â”€ A1 è¢«æŠ¢ â†’ æç¤º"A1 å·²è¢«æŠ¢ï¼Œè¯·é‡æ–°é€‰æ‹©"
      â†“
      ç”¨æˆ·é‡æ–°é€‰æ‹© A3, A4
      â†“
      å†æ¬¡å°è¯• â†’ æˆåŠŸ
```

**ç”¨æˆ·æ„Ÿå—**ï¼š
- å¯ä»¥ç²¾ç¡®é€‰åº§ï¼ˆä½“éªŒå¥½ï¼‰
- å³ä½¿è¢«æŠ¢ä¹Ÿèƒ½å¿«é€Ÿé‡é€‰ï¼ˆå€’è®¡æ—¶æç¤ºï¼‰

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | æ¨¡å¼ | æ€§èƒ½ | ç”¨æˆ·ä½“éªŒ |
|------|------|------|---------|
| å¼€å”®åˆæœŸï¼ˆ1000+ å¹¶å‘ï¼‰ | AUTO | â­â­â­â­â­ (2ms) | â­â­â­ (è‡ªåŠ¨åˆ†é…) |
| å¼€å”®åæœŸï¼ˆ< 100 å¹¶å‘ï¼‰ | MANUAL | â­â­â­â­ (10ms) | â­â­â­â­â­ (å¯é€‰åº§) |

## ğŸ¯ é…ç½®å‚æ•°

å¯ä»¥åœ¨ `lib/ticket-strategy.ts` ä¸­è°ƒæ•´ç­–ç•¥ï¼š

```typescript
const STRATEGY_CONFIG = {
  // å¼€å”®åå¤šå°‘åˆ†é’Ÿå†…å¼ºåˆ¶è‡ªåŠ¨åˆ†é…
  AUTO_ASSIGN_MINUTES: 10,  // å¯è°ƒæ•´ä¸º 5, 15, 30 ç­‰

  // é«˜å¹¶å‘é˜ˆå€¼ï¼ˆæ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼‰
  HIGH_CONCURRENCY_THRESHOLD: 100,  // å¯è°ƒæ•´ä¸º 50, 200 ç­‰

  // åº§ä½é”å®šæ—¶é•¿
  HOLD_DURATION_MS: 10 * 60 * 1000,  // å¯è°ƒæ•´ä¸º 5 åˆ†é’Ÿã€15 åˆ†é’Ÿç­‰
};
```

## âœ… ä¼˜åŠ¿æ€»ç»“

ç›¸æ¯”"è®©ç”¨æˆ·é€‰æ‹©æ¨¡å¼"çš„æ–¹æ¡ˆï¼š

| ç»´åº¦ | ç”¨æˆ·é€‰æ‹©æ¨¡å¼ | è‡ªåŠ¨åˆ‡æ¢æ¨¡å¼ï¼ˆå¤§éº¦ç½‘ï¼‰ |
|------|-------------|---------------------|
| **ç”¨æˆ·ä½“éªŒ** | âš ï¸ éœ€è¦ç†è§£ä¸¤ç§æ¨¡å¼ | âœ… æ— éœ€ç†è§£ï¼Œé€æ˜åˆ‡æ¢ |
| **å¼€å‘å¤æ‚åº¦** | âš ï¸ å‰ç«¯éœ€è¦ä¸¤å¥— UI | âœ… ç»Ÿä¸€ UIï¼Œåç«¯è‡ªåŠ¨åˆ¤æ–­ |
| **æµ‹è¯•æˆæœ¬** | âš ï¸ éœ€è¦æµ‹è¯•ä¸¤ç§è·¯å¾„ | âœ… åªéœ€æµ‹è¯•è‡ªåŠ¨åˆ‡æ¢é€»è¾‘ |
| **æ€§èƒ½** | âœ… å¯æ§ | âœ… è‡ªåŠ¨ä¼˜åŒ– |
| **ç”¨æˆ·æŠ•è¯‰** | âŒ "ä¸ºä»€ä¹ˆæˆ‘é€‰äº†å¿«é€Ÿæ¨¡å¼è¿˜æ˜¯æŠ¢ä¸åˆ°" | âœ… "ç³»ç»Ÿè‡ªåŠ¨åˆ†é…æ˜¯åˆç†çš„" |
| **Bug é£é™©** | âš ï¸ ç”¨æˆ·å¯èƒ½é€‰é”™æ¨¡å¼ | âœ… ç³»ç»Ÿè‡ªåŠ¨å†³ç­–ï¼Œæ— æ­§ä¹‰ |

## ğŸš€ ä¸‹ä¸€æ­¥

1. âœ… å·²å®Œæˆï¼šæ ¸å¿ƒç­–ç•¥é€»è¾‘ï¼ˆ`lib/ticket-strategy.ts`ï¼‰
2. âœ… å·²å®Œæˆï¼šAPI æ¥å£ï¼ˆ`app/api/tickets/hold-smart/route.ts`ï¼‰
3. ğŸ“ å¾…å®ç°ï¼šå‰ç«¯åº§ä½å›¾ç»„ä»¶
4. ğŸ“ å¾…å®ç°ï¼šå®æ—¶åˆ·æ–°åº§ä½çŠ¶æ€
5. ğŸ“ å¾…å®ç°ï¼šå€’è®¡æ—¶æ˜¾ç¤º

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2025-11-01
**å‚è€ƒ**ï¼šå¤§éº¦ç½‘ã€çŒ«çœ¼ç”µå½±é€‰åº§é€»è¾‘
