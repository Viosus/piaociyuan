# 聊天功能使用指南

## 功能概览

票次元平台的聊天功能提供了完整的私信系统，支持用户之间进行一对一实时交流。

### 核心特性

✅ **侧边栏快捷入口** - 右侧边栏可展开/收起，快速查看对话
✅ **独立聊天页面** - 完整的聊天界面，支持长时间交流
✅ **实时通知** - 未读消息提醒，红点标记
✅ **用户搜索** - 快速查找并发起对话
✅ **消息已读状态** - 自动标记已读消息
✅ **历史记录** - 保存完整聊天记录

---

## 界面布局

### 1. 右侧边栏 (RightSidebar)

**位置**: 固定在页面右侧
**宽度**:
- 收起状态: 64px
- 展开状态: 320px

**功能标签页**:
- 🔔 **通知** - 系统通知、活动提醒
- 💬 **私信** - 对话列表、未读消息

**快捷操作**:
- 点击图标展开侧边栏
- 新建私信按钮
- 查看全部按钮（跳转到完整页面）

### 2. 对话列表页面 (`/messages`)

**功能**:
- 显示所有对话，按最新消息时间排序
- 搜索对话（按昵称）
- 查看未读消息数量
- 快速进入聊天详情

**交互**:
- 点击对话卡片 → 进入聊天详情
- 点击"新建对话" → 搜索用户

### 3. 搜索用户页面 (`/messages/new`)

**功能**:
- 搜索用户（支持手机号、昵称）
- 查看用户头像和基本信息
- 发起新对话

**搜索条件**:
- 至少输入 2 个字符
- 自动排除当前用户

### 4. 聊天详情页面 (`/messages/[id]`)

**功能**:
- 实时聊天界面
- 消息气泡显示
- 自动滚动到最新消息
- 已读状态标记

**消息显示**:
- 左侧：对方消息（白色气泡）
- 右侧：自己消息（黄色气泡）
- 显示发送时间
- 头像展示

---

## 使用流程

### 方式一：从侧边栏发起对话

1. **展开右侧边栏**
   - 点击右上角展开按钮
   - 或点击 💬 图标

2. **切换到私信标签**
   - 点击"💬 私信"

3. **发起新对话**
   - 点击"新建私信"按钮
   - 或点击现有对话进入聊天

4. **搜索用户**
   - 在搜索框输入手机号或昵称
   - 例如: `138`、`音乐`、`演唱会`

5. **开始聊天**
   - 点击用户卡片的"发起对话"
   - 自动跳转到聊天页面

### 方式二：从完整页面发起对话

1. **进入消息页面**
   - 访问 `/messages`
   - 或从侧边栏点击"查看全部"

2. **新建对话**
   - 点击右上角"新建对话"按钮
   - 搜索目标用户

3. **发送消息**
   - 在输入框输入文字
   - 点击"发送"或按 Enter

---

## 功能细节

### 消息管理

**发送消息**:
- 支持文本消息（多行支持）
- 实时发送，无需等待
- 发送失败自动提示

**消息已读**:
- 打开对话自动标记已读
- 清空未读计数
- 更新最后阅读时间

**消息排序**:
- 按时间正序显示（最早在上）
- 新消息自动追加到底部
- 自动滚动到最新消息

### 时间显示

**格式化规则**:
- 今天: 显示时间 (例: `14:30`)
- 昨天: `昨天 14:30`
- 更早: `MM-DD HH:mm` (例: `11-01 14:30`)

**侧边栏时间**:
- 刚刚: < 1 分钟
- X 分钟前: < 60 分钟
- X 小时前: < 24 小时
- 日期: ≥ 24 小时

### 未读提醒

**显示位置**:
- ✅ 侧边栏展开/收起按钮（总未读数）
- ✅ 私信标签页（私信未读数）
- ✅ 对话卡片（单个对话未读数）
- ✅ 用户头像（对话列表）

**更新时机**:
- 收到新消息时增加
- 打开对话时清零
- 每 30 秒自动刷新

---

## API 接口

### 1. 获取对话列表

```typescript
GET /api/messages/conversations

Response:
[
  {
    id: string,
    otherUser: {
      id: string,
      nickname: string,
      avatar: string | null
    },
    lastMessage: {
      content: string,
      createdAt: string,
      senderId: string,
      isRead: boolean
    },
    unreadCount: number,
    lastMessageAt: string
  }
]
```

### 2. 创建对话

```typescript
POST /api/messages/conversations
Body: { otherUserId: string }

Response:
{
  id: string,
  otherUser: { id, nickname, avatar },
  isNew: boolean  // true 表示新创建
}
```

### 3. 获取对话详情

```typescript
GET /api/messages/conversations/[id]

Response:
{
  id: string,
  otherUser: { id, nickname, avatar },
  messages: [
    {
      id: string,
      content: string,
      createdAt: string,
      senderId: string,
      sender: { id, nickname, avatar }
    }
  ]
}
```

### 4. 发送消息

```typescript
POST /api/messages
Body: {
  conversationId: string,
  content: string,
  receiverId: string
}

Response: { 新消息对象 }
```

### 5. 搜索用户

```typescript
GET /api/users/search?q={keyword}

Response:
[
  {
    id: string,
    nickname: string,
    avatar: string | null,
    phone: string
  }
]
```

---

## 数据库结构

### Conversation (对话表)

```prisma
model Conversation {
  id             String   @id @default(uuid())
  lastMessageAt  DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  participants   ConversationParticipant[]
  messages       Message[]
}
```

### ConversationParticipant (参与者表)

```prisma
model ConversationParticipant {
  id             String   @id @default(uuid())
  conversationId String
  userId         String
  unreadCount    Int      @default(0)
  lastReadAt     DateTime @default(now())
  joinedAt       DateTime @default(now())

  conversation   Conversation @relation(...)
  user           User         @relation(...)

  @@unique([conversationId, userId])
}
```

### Message (消息表)

```prisma
model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderId       String
  receiverId     String
  content        String   @db.Text
  messageType    String   @default("text")
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())

  conversation   Conversation @relation(...)
  sender         User         @relation("SentMessages", ...)
  receiver       User         @relation("ReceivedMessages", ...)
}
```

---

## 文件结构

### 前端页面

```
app/messages/
├── page.tsx                    # 对话列表页
├── new/
│   └── page.tsx               # 搜索用户页
└── [id]/
    └── page.tsx               # 聊天详情页
```

### 后端API

```
app/api/messages/
├── route.ts                        # 发送消息
├── conversations/
│   ├── route.ts                   # 对话列表、创建对话
│   └── [id]/
│       └── route.ts               # 对话详情
```

### 组件

```
components/
└── RightSidebar.tsx               # 右侧边栏（包含私信列表）
```

### 工具库

```
lib/
└── api.ts                         # API请求封装（自动携带token）
```

---

## 常见问题

### Q1: 搜索不到用户？

**解决方案**:
1. 确认已登录（查看浏览器 localStorage 是否有 token）
2. 输入至少 2 个字符
3. 尝试使用手机号搜索（如 `138`）
4. 检查浏览器控制台是否有错误

### Q2: 发送消息失败？

**可能原因**:
1. Token 过期 → 重新登录
2. 网络问题 → 检查网络连接
3. 对话不存在 → 重新发起对话

### Q3: 未读消息不更新？

**刷新策略**:
- 侧边栏每 30 秒自动刷新
- 手动刷新页面
- 打开对话会立即清零未读数

### Q4: 聊天记录显示不全？

**检查项**:
1. 滚动到顶部查看历史消息
2. 检查数据库中的消息是否存在
3. 查看浏览器控制台错误日志

### Q5: 图片头像加载失败？

**已配置域名**:
- `api.dicebear.com` - 头像生成服务
- `images.unsplash.com` - 测试图片

如需添加其他图片域名，修改 `next.config.ts`:

```typescript
images: {
  remotePatterns: [
    {
      protocol: 'https',
      hostname: 'your-domain.com',
    },
  ],
}
```

---

## 性能优化

### 1. 消息加载

- ✅ 按需加载历史消息（目前加载全部）
- 🔄 TODO: 分页加载（每次 50 条）
- 🔄 TODO: 虚拟滚动（超过 100 条消息）

### 2. 实时更新

- ✅ 定时轮询（30 秒）
- 🔄 TODO: WebSocket 实时推送
- 🔄 TODO: Server-Sent Events (SSE)

### 3. 缓存策略

- ✅ localStorage 存储 token
- 🔄 TODO: 对话列表缓存
- 🔄 TODO: 消息本地缓存

---

## 未来扩展

### 计划中的功能

- [ ] **消息类型扩展**
  - 图片消息
  - 文件分享
  - 语音消息
  - 位置分享

- [ ] **高级功能**
  - 消息撤回
  - 消息引用/回复
  - @提醒功能
  - 表情包支持

- [ ] **群聊功能**
  - 创建群组
  - 群成员管理
  - 群公告
  - 群文件

- [ ] **安全增强**
  - 消息加密
  - 举报功能
  - 黑名单管理
  - 消息审核

---

## 测试账户

| 手机号 | 昵称 | 密码 |
|--------|------|------|
| 17701790343 | Admin | password123 |
| 13800138001 | 音乐狂热者 | password123 |
| 13800138002 | 演唱会达人 | password123 |
| 13800138003 | 追星少女 | password123 |
| 13800138004 | 现场控 | password123 |

---

## 开发指南

### 添加新的消息类型

1. 修改 Prisma Schema:
```prisma
model Message {
  messageType String @default("text")
  // "text" | "image" | "file" | "voice"

  imageUrl    String? // 图片消息
  fileUrl     String? // 文件消息
  fileName    String? // 文件名
}
```

2. 运行迁移:
```bash
npx prisma migrate dev --name add_message_types
```

3. 更新 API 路由处理逻辑

4. 更新前端渲染逻辑

### 集成 WebSocket

参考实现（使用 Socket.IO）:

```typescript
// server.ts
import { Server } from 'socket.io';

const io = new Server(server);

io.on('connection', (socket) => {
  socket.on('join', (conversationId) => {
    socket.join(conversationId);
  });

  socket.on('message', (data) => {
    io.to(data.conversationId).emit('new-message', data);
  });
});
```

```typescript
// client.tsx
import { io } from 'socket.io-client';

const socket = io();

socket.on('new-message', (message) => {
  setMessages(prev => [...prev, message]);
});
```

---

**最后更新**: 2025-11-03
**作者**: 票次元开发团队
