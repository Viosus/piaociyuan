# 主页活动参数错误修复总结

## 问题描述

用户报告从主页点击活动进入详情页时显示"请求参数错误"。

## 问题根源

**参数名不匹配**：前端组件在导航时传递的参数名与目标页面期望接收的参数名不一致。

### 错误示例：

**SectionBlock.tsx（主页活动卡片）**：
```typescript
// ❌ 错误：传递 { id: eventId }
navigation.navigate('EventDetail' as never, { id: eventId } as never);
```

**EventDetailScreen.tsx**：
```typescript
// ✅ 期望接收 { eventId: number }
const { eventId } = route.params as { eventId: number };
```

结果：`eventId` 为 `undefined`，导致API调用失败，显示"请求参数错误"。

## 问题范围

通过全局搜索发现多个文件存在同样的问题：

### 导航到 EventDetail 的地方：

1. ✅ **EventsScreen.tsx:67** - 正确使用 `eventId`
2. ❌ **SectionBlock.tsx:26** - 错误使用 `id`
3. ❌ **EncoreScreen.tsx:256** - 错误使用 `id`
4. ❌ **FavoritesScreen.tsx:119** - 错误使用 `id`
5. ❌ **NotificationsScreen.tsx:106** - 错误使用 `id`

### 其他导航问题：

在 NotificationsScreen 中还发现：
- **OrderDetail** - 错误使用 `id`，应该是 `orderId`
- **TicketDetail** - 错误使用 `id`，应该是 `ticketId`

## 修复内容

### 1. 修复 SectionBlock.tsx（主页活动卡片）

**文件**：`apps/mobile/src/components/SectionBlock.tsx`

**修改前**：
```typescript
const handleEventPress = (eventId: number) => {
  navigation.navigate('EventDetail' as never, { id: eventId } as never);
};
```

**修改后**：
```typescript
const handleEventPress = (eventId: number) => {
  navigation.navigate('EventDetail' as never, { eventId: eventId } as never);
};
```

### 2. 修复 EncoreScreen.tsx（安可区活动链接）

**文件**：`apps/mobile/src/screens/EncoreScreen.tsx`

**修改前**：
```typescript
const handleEventPress = (eventId: number) => {
  navigation.navigate('EventDetail' as never, { id: eventId } as never);
};
```

**修改后**：
```typescript
const handleEventPress = (eventId: number) => {
  navigation.navigate('EventDetail' as never, { eventId: eventId } as never);
};
```

### 3. 修复 FavoritesScreen.tsx（收藏活动链接）

**文件**：`apps/mobile/src/screens/FavoritesScreen.tsx`

**修改前**：
```typescript
const handleEventPress = (eventId: number) => {
  navigation.navigate('EventDetail' as never, { id: eventId } as never);
};
```

**修改后**：
```typescript
const handleEventPress = (eventId: number) => {
  navigation.navigate('EventDetail' as never, { eventId: eventId } as never);
};
```

### 4. 修复 NotificationsScreen.tsx（通知活动链接）

**文件**：`apps/mobile/src/screens/NotificationsScreen.tsx`

**修改前**：
```typescript
switch (type) {
  case 'event_reminder':
    if (data?.eventId) {
      navigation.navigate('EventDetail' as never, { id: data.eventId } as never);
    }
    break;
  case 'order_status':
    if (data?.orderId) {
      navigation.navigate('OrderDetail' as never, { id: data.orderId } as never);
    }
    break;
  case 'ticket_status':
    if (data?.ticketId) {
      navigation.navigate('TicketDetail' as never, { id: data.ticketId } as never);
    }
    break;
}
```

**修改后**：
```typescript
switch (type) {
  case 'event_reminder':
    if (data?.eventId) {
      navigation.navigate('EventDetail' as never, { eventId: data.eventId } as never);
    }
    break;
  case 'order_status':
    if (data?.orderId) {
      navigation.navigate('OrderDetail' as never, { orderId: data.orderId } as never);
    }
    break;
  case 'ticket_status':
    if (data?.ticketId) {
      navigation.navigate('TicketDetail' as never, { ticketId: data.ticketId } as never);
    }
    break;
}
```

## 参数名规范

为了避免将来出现类似问题，建立以下参数命名规范：

### 目标页面及其期望的参数名：

| 目标页面 | 参数名 | 类型 | 示例 |
|---------|--------|------|------|
| EventDetail | `eventId` | number | `{ eventId: 1 }` |
| TicketDetail | `ticketId` | string | `{ ticketId: "uuid" }` |
| OrderDetail | `orderId` | string | `{ orderId: "uuid" }` |
| PostDetail | `postId` | number/string | `{ postId: 1 }` |
| UserProfile | `userId` | number/string | `{ userId: 1 }` |

### 规范建议：

1. **使用具体的参数名**，而不是通用的 `id`
   - ✅ 好：`eventId`, `ticketId`, `orderId`
   - ❌ 坏：`id`

2. **保持前后端一致**
   - 前端传递的参数名 = 目标页面期望的参数名

3. **TypeScript 类型检查**
   - 使用强类型定义 route params
   - 例如：`route.params as { eventId: number }`

## 修复效果

修复后，所有导航到活动详情的入口应该都能正常工作：

### ✅ 主页
- 点击首页推荐的活动 → 正常跳转到活动详情

### ✅ 活动列表
- 点击活动列表中的活动 → 正常跳转到活动详情

### ✅ 安可区
- 点击帖子中的活动标签 → 正常跳转到活动详情

### ✅ 收藏
- 点击收藏的活动 → 正常跳转到活动详情

### ✅ 通知
- 点击活动提醒通知 → 正常跳转到活动详情
- 点击订单通知 → 正常跳转到订单详情
- 点击门票通知 → 正常跳转到门票详情

## 测试建议

### 1. 主页活动测试
- [ ] 从主页点击推荐活动
- [ ] 从主页点击热门活动
- [ ] 从主页点击分类活动
- [ ] 确认能正常显示活动详情

### 2. 安可区活动测试
- [ ] 找到带活动标签的帖子
- [ ] 点击活动标签
- [ ] 确认能正常跳转到活动详情

### 3. 收藏活动测试
- [ ] 进入收藏页面
- [ ] 点击收藏的活动
- [ ] 确认能正常显示活动详情

### 4. 通知测试
- [ ] 查看活动提醒通知
- [ ] 点击通知跳转
- [ ] 确认能正常显示相关详情

### 5. 活动列表测试
- [ ] 进入活动列表页
- [ ] 点击任意活动
- [ ] 确认能正常显示活动详情

## 相关文件

### 修改的文件：
1. `apps/mobile/src/components/SectionBlock.tsx`
2. `apps/mobile/src/screens/EncoreScreen.tsx`
3. `apps/mobile/src/screens/FavoritesScreen.tsx`
4. `apps/mobile/src/screens/NotificationsScreen.tsx`

### 未修改（已正确）：
1. `apps/mobile/src/screens/EventsScreen.tsx`

### 相关目标页面：
1. `apps/mobile/src/screens/EventDetailScreen.tsx`
2. `apps/mobile/src/screens/TicketDetailScreen.tsx`
3. `apps/mobile/src/screens/OrderDetailScreen.tsx` (如果存在)

## 预防措施

为了避免将来出现类似问题，建议：

### 1. 创建导航类型定义

创建统一的导航参数类型定义文件：

```typescript
// types/navigation.ts
export type RootStackParamList = {
  EventDetail: { eventId: number };
  TicketDetail: { ticketId: string };
  OrderDetail: { orderId: string };
  PostDetail: { postId: number | string };
  UserProfile: { userId: number | string };
  // ... 其他页面
};
```

### 2. 使用类型化导航

```typescript
import { NavigationProp } from '@react-navigation/native';
import { RootStackParamList } from '../types/navigation';

type Navigation = NavigationProp<RootStackParamList>;

// 在组件中使用
const navigation = useNavigation<Navigation>();

// 导航时会有类型检查
navigation.navigate('EventDetail', { eventId: 1 }); // ✅ 正确
navigation.navigate('EventDetail', { id: 1 });      // ❌ TypeScript 报错
```

### 3. 代码审查清单

在提交代码前检查：
- [ ] 导航参数名是否与目标页面一致
- [ ] 是否使用了具体的参数名而非通用的 `id`
- [ ] TypeScript 类型是否正确定义

## 总结

主页活动参数错误的问题已经完全修复。问题的根本原因是参数名不匹配（传递 `id` 但期望 `eventId`）。

修复范围：
- ✅ 主页活动卡片
- ✅ 安可区活动链接
- ✅ 收藏活动链接
- ✅ 通知活动链接
- ✅ 同时修复了订单和门票的参数问题

现在从任何入口点击活动都应该能够正常跳转并显示详情！
