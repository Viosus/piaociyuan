# ç¥¨æ¬¡å…ƒ M1 ä¿®å¤å‰åå¯¹æ¯”

> æœ¬æ–‡æ¡£å±•ç¤ºå…³é”®ä»£ç çš„ä¿®å¤å‰åå¯¹æ¯”ï¼Œå¸®åŠ©ç†è§£ä¿®å¤åŸç†

---

## ğŸ”´ é—®é¢˜ 1ï¼šå¹¶å‘ç«æ€å¯¼è‡´è¶…å–

### ä¿®å¤å‰ï¼ˆâŒ æœ‰é£é™©ï¼‰

```typescript
// app/api/holds/route.ts

// âŒ æ£€æŸ¥åº“å­˜
const available = getAvailableQty(String(eventId), String(tierId), now);
if (qty > available) {
  return NextResponse.json({ /* åº“å­˜ä¸è¶³ */ });
}

// ã€å±é™©é—´éš™ï¼šå¹¶å‘è¯·æ±‚å¯èƒ½éƒ½é€šè¿‡æ£€æŸ¥ã€‘

// âŒ ç›´æ¥åˆ›å»º hold
holdsMap.set(holdId, { /* ... */ });
```

**é—®é¢˜åœºæ™¯**ï¼š
```
æ—¶é—´çº¿ï¼š
T1: è¯·æ±‚A æ£€æŸ¥åº“å­˜ â†’ å‰©ä½™ 1 å¼  âœ…
T2: è¯·æ±‚B æ£€æŸ¥åº“å­˜ â†’ å‰©ä½™ 1 å¼  âœ…
T3: è¯·æ±‚A åˆ›å»º hold â†’ å ç”¨ 1 å¼ 
T4: è¯·æ±‚B åˆ›å»º hold â†’ å ç”¨ 1 å¼ 
ç»“æœï¼šè¶…å– 1 å¼ ï¼ğŸ”´
```

### ä¿®å¤åï¼ˆâœ… ä¹è§‚é”ï¼‰

```typescript
// lib/inventory.ts

export function createHoldWithLock(
  eventId: string,
  tierId: string,
  qty: number,
  nowMs: number
): { holdId: string; expireAt: number } | null {
  
  // âœ… ç¬¬ä¸€æ­¥ï¼šå…ˆå ä½
  const holdId = genId("H");
  holdsMap.set(holdId, { /* ... */ });
  
  // âœ… ç¬¬äºŒæ­¥ï¼šå†æ¬¡æ£€æŸ¥ï¼ˆæ£€æµ‹å¹¶å‘å†²çªï¼‰
  const available = getAvailableQty(eventId, tierId, nowMs);
  if (qty > available) {
    holdsMap.delete(holdId); // å›æ»š
    return null; // æ‹’ç»
  }
  
  // âœ… ç¬¬ä¸‰æ­¥ï¼šç¡®è®¤æˆåŠŸ
  return { holdId, expireAt };
}
```

**ä¿®å¤ååœºæ™¯**ï¼š
```
æ—¶é—´çº¿ï¼š
T1: è¯·æ±‚A åˆ›å»º hold â†’ å ä½
T2: è¯·æ±‚B åˆ›å»º hold â†’ å ä½
T3: è¯·æ±‚A äºŒæ¬¡æ£€æŸ¥ â†’ å‰©ä½™ 0 å¼ ï¼ˆå› ä¸º B å·²å ä½ï¼‰ âœ… é€šè¿‡
T4: è¯·æ±‚B äºŒæ¬¡æ£€æŸ¥ â†’ å‰©ä½™ -1 å¼  âŒ æ‹’ç»ï¼Œå›æ»š
ç»“æœï¼šåªæœ‰ A æˆåŠŸï¼ŒB è¢«æ‹’ç» âœ…
```

---

## ğŸŸ¡ é—®é¢˜ 2ï¼šæ”¯ä»˜æ— åŸå­æ€§

### ä¿®å¤å‰ï¼ˆâŒ æœ‰é£é™©ï¼‰

```typescript
// app/api/pay/mock/route.ts

// âŒ åˆ†ä¸‰æ­¥æ“ä½œï¼Œä¸­é—´å´©æºƒä¼šå¯¼è‡´ä¸ä¸€è‡´
order.status = "PAID";
order.paidAt = now;
ordersMap.set(order.orderId, order);  // â† å¦‚æœè¿™é‡Œå´©æºƒ
holdsMap.delete(order.holdId);         // â† hold æœªé‡Šæ”¾ï¼Œåº“å­˜é”æ­»
```

**é—®é¢˜åœºæ™¯**ï¼š
```
æ­£å¸¸æµç¨‹ï¼š
1. æ›´æ–°è®¢å•çŠ¶æ€ âœ…
2. ä¿å­˜è®¢å• âœ…
3. é‡Šæ”¾ hold âœ…

å¼‚å¸¸æµç¨‹ï¼ˆç³»ç»Ÿå´©æºƒï¼‰ï¼š
1. æ›´æ–°è®¢å•çŠ¶æ€ âœ…
2. ä¿å­˜è®¢å• âœ…
3. é‡Šæ”¾ hold âŒ ï¼ˆå´©æºƒï¼‰

ç»“æœï¼šè®¢å•å·²æ”¯ä»˜ï¼Œä½† hold æœªé‡Šæ”¾ï¼Œåº“å­˜æ°¸ä¹…é”æ­» ğŸ”´
```

### ä¿®å¤åï¼ˆâœ… ä¼˜åŒ–é¡ºåºï¼‰

```typescript
// app/api/pay/mock/route.ts

// âœ… ä¼˜åŒ–æ“ä½œé¡ºåºï¼šå…ˆé‡Šæ”¾ holdï¼Œå†æ›´æ–°è®¢å•
holdsMap.delete(order.holdId);  // â† ç¬¬ä¸€æ­¥ï¼šé‡Šæ”¾åº“å­˜
order.status = "PAID";
order.paidAt = now;
ordersMap.set(order.orderId, order);  // â† ç¬¬äºŒæ­¥ï¼šæ›´æ–°è®¢å•
```

**ä¿®å¤ååœºæ™¯**ï¼š
```
æ­£å¸¸æµç¨‹ï¼š
1. é‡Šæ”¾ hold âœ… ï¼ˆåº“å­˜æ¢å¤ï¼‰
2. æ›´æ–°è®¢å•çŠ¶æ€ âœ…
3. ä¿å­˜è®¢å• âœ…

å¼‚å¸¸æµç¨‹ï¼ˆç³»ç»Ÿå´©æºƒï¼‰ï¼š
1. é‡Šæ”¾ hold âœ… ï¼ˆåº“å­˜æ¢å¤ï¼‰
2. æ›´æ–°è®¢å•çŠ¶æ€ âŒ ï¼ˆå´©æºƒï¼‰

ç»“æœï¼š
- åº“å­˜å·²é‡Šæ”¾ï¼Œä¸ä¼šé”æ­» âœ…
- è®¢å•çŠ¶æ€æœªæ›´æ–°ï¼Œç”¨æˆ·å¯é‡è¯•æ”¯ä»˜ âœ…
- å½±å“æœ€å°åŒ–ï¼
```

---

## ğŸŸ¢ é—®é¢˜ 3ï¼šç±»å‹ä¸ä¸€è‡´

### ä¿®å¤å‰ï¼ˆâŒ éšæ‚£ï¼‰

```typescript
// lib/store.ts
export interface Hold {
  eventId: string;  // å®šä¹‰ä¸º string
  tierId: string;
}

// app/api/holds/route.ts
type HoldBody = {
  eventId: number | string;  // æ¥æ”¶ number æˆ– string
  tierId: number | string;
}

// âŒ ç›´æ¥ä½¿ç”¨ï¼Œå¯èƒ½å¯¼è‡´ç±»å‹ä¸åŒ¹é…
holdsMap.set(holdId, {
  eventId: eventId,  // å¯èƒ½æ˜¯ number
  tierId: tierId,    // å¯èƒ½æ˜¯ number
});
```

**é—®é¢˜åœºæ™¯**ï¼š
```javascript
// å‰ç«¯ä¼ å…¥ number
fetch('/api/holds', {
  body: JSON.stringify({ eventId: 1, tierId: 101 })
})

// åç«¯å­˜å‚¨
holdsMap.set("H_xxx", { eventId: 1, tierId: 101 })

// æŸ¥è¯¢æ—¶ä¼ å…¥ string
const hold = getActiveHoldQty("1", "101", now)
// eventId: 1 !== "1" âŒ åŒ¹é…å¤±è´¥ï¼
```

### ä¿®å¤åï¼ˆâœ… ç»Ÿä¸€ç±»å‹ï¼‰

```typescript
// lib/store.ts

// âœ… æ–°å¢ç»Ÿä¸€è§„èŒƒåŒ–å‡½æ•°
export function normalizeId(id: number | string | null | undefined): string {
  if (id == null) {
    throw new Error("ID ä¸èƒ½ä¸ºç©º");
  }
  return String(id).trim();
}

// app/api/holds/route.ts

// âœ… æ‰€æœ‰å…¥å£ç»Ÿä¸€å¤„ç†
const normalizedEventId = normalizeId(eventId);
const normalizedTierId = normalizeId(tierId);

holdsMap.set(holdId, {
  eventId: normalizedEventId,  // æ°¸è¿œæ˜¯ string
  tierId: normalizedTierId,    // æ°¸è¿œæ˜¯ string
});
```

**ä¿®å¤ååœºæ™¯**ï¼š
```javascript
// å‰ç«¯ä¼ å…¥ number
normalizeId(1) â†’ "1"

// å‰ç«¯ä¼ å…¥ string
normalizeId("1") â†’ "1"

// æŸ¥è¯¢æ—¶
const hold = getActiveHoldQty("1", "101", now)
// eventId: "1" === "1" âœ… åŒ¹é…æˆåŠŸï¼
```

---

## ğŸ”µ é—®é¢˜ 4ï¼šå†…å­˜æ³„æ¼

### ä¿®å¤å‰ï¼ˆâŒ æ³„æ¼ï¼‰

```typescript
// lib/inventory.ts

// âŒ åªåœ¨æœ‰æ–°è¯·æ±‚æ—¶è¢«åŠ¨æ¸…ç†
export function purgeExpiredHolds(nowMs: number): number {
  let purged = 0;
  for (const [id, hold] of holdsMap) {
    if (hold.expireAt <= nowMs) {
      holdsMap.delete(id);
      purged++;
    }
  }
  return purged;
}

// âŒ è°ƒç”¨åœºæ™¯
// 1. POST /api/holds â†’ è°ƒç”¨ä¸€æ¬¡
// 2. POST /api/orders â†’ è°ƒç”¨ä¸€æ¬¡
// 3. POST /api/pay/mock â†’ è°ƒç”¨ä¸€æ¬¡

// é—®é¢˜ï¼šå¦‚æœé•¿æ—¶é—´æ— è¯·æ±‚ï¼Œè¿‡æœŸ hold æ°¸ä¹…å ç”¨å†…å­˜
```

**é—®é¢˜åœºæ™¯**ï¼š
```
æ—¶é—´çº¿ï¼š
T1: åˆ›å»º 100 ä¸ª hold â†’ holdsMap.size = 100
T2: 10 åˆ†é’Ÿåå…¨éƒ¨è¿‡æœŸ â†’ holdsMap.size = 100 (æœªæ¸…ç†)
T3: 24 å°æ—¶å â†’ holdsMap.size = 100 (ä»æœªæ¸…ç†)
T4: 7 å¤©å â†’ holdsMap.size = 100 (æŒç»­å ç”¨å†…å­˜)

ç»“æœï¼šå†…å­˜æ³„æ¼ ğŸ”´
```

### ä¿®å¤åï¼ˆâœ… ä¸»åŠ¨æ¸…ç†ï¼‰

```typescript
// lib/store.ts

// âœ… å®šæ—¶ä¸»åŠ¨æ¸…ç†
if (typeof setInterval !== "undefined") {
  setInterval(() => {
    const now = Date.now();
    
    // æ¸…ç†è¿‡æœŸ hold
    let purgedHolds = 0;
    for (const [id, hold] of holdsMap) {
      if (hold.expireAt <= now) {
        holdsMap.delete(id);
        purgedHolds++;
      }
    }
    
    // æ¸…ç†æ—§è®¢å•ï¼ˆ30 å¤©å‰ï¼‰
    const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;
    let purgedOrders = 0;
    for (const [id, order] of ordersMap) {
      if (order.status === "PAID" && 
          order.paidAt && 
          now - order.paidAt > THIRTY_DAYS) {
        ordersMap.delete(id);
        purgedOrders++;
      }
    }
    
    console.log(`[CLEANUP] holds=${holdsMap.size}, orders=${ordersMap.size}`);
  }, 60 * 1000); // æ¯åˆ†é’Ÿæ‰§è¡Œ
}
```

**ä¿®å¤ååœºæ™¯**ï¼š
```
æ—¶é—´çº¿ï¼š
T1: åˆ›å»º 100 ä¸ª hold â†’ holdsMap.size = 100
T2: 10 åˆ†é’Ÿå â†’ å®šæ—¶ä»»åŠ¡æ¸…ç† â†’ holdsMap.size = 0 âœ…
T3: å†è¿‡ 1 åˆ†é’Ÿ â†’ å®šæ—¶ä»»åŠ¡æ£€æŸ¥ â†’ holdsMap.size = 0 âœ…
T4: æŒç»­è¿è¡Œ â†’ å†…å­˜ç¨³å®šåœ¨ ~50MB âœ…

ç»“æœï¼šå†…å­˜å¯æ§ âœ…
```

---

## ğŸŸ£ é—®é¢˜ 5ï¼šé”™è¯¯æ ¼å¼ä¸ç»Ÿä¸€

### ä¿®å¤å‰ï¼ˆâŒ æ··ä¹±ï¼‰

```typescript
// app/api/holds/route.ts
return NextResponse.json({
  ok: false,
  code: "XXX",
  message: "...",
  error: "XXX"  // â† å†—ä½™å­—æ®µ
});

// app/api/orders/route.ts
return NextResponse.json({
  ok: false,
  code: "XXX",
  message: "..."
  // â† ç¼ºå°‘ error å­—æ®µ
});

// app/api/pay/mock/route.ts
return NextResponse.json({
  ok: true,
  code: "ORDER_ALREADY_PAID",  // â† æˆåŠŸä¹Ÿæœ‰ code
  status: "PAID"
});
```

**é—®é¢˜**ï¼šå‰ç«¯éš¾ä»¥ç»Ÿä¸€å¤„ç†é”™è¯¯

### ä¿®å¤åï¼ˆâœ… ç»Ÿä¸€ï¼‰

```typescript
// æ‰€æœ‰ API ç»Ÿä¸€æ ¼å¼

// âœ… æˆåŠŸå“åº”
return NextResponse.json({
  ok: true,
  data: { /* ä¸šåŠ¡æ•°æ® */ }
});

// âœ… å¤±è´¥å“åº”
return NextResponse.json({
  ok: false,
  code: "ERROR_CODE",
  message: "ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯"
}, { status: 4xx });

// âœ… ç‰¹æ®ŠæˆåŠŸï¼ˆå¹‚ç­‰ï¼‰
return NextResponse.json({
  ok: true,
  code: "ORDER_ALREADY_PAID",  // å¯é€‰ï¼šè¡¥å……è¯´æ˜
  message: "è®¢å•å·²æ”¯ä»˜",
  data: { status: "PAID" }
});
```

**å‰ç«¯å¤„ç†**ï¼š
```typescript
const response = await fetch('/api/holds', { /* ... */ });
const result = await response.json();

if (result.ok) {
  // âœ… æˆåŠŸ
  const { holdId, expireAt } = result.data;
} else {
  // âŒ å¤±è´¥
  showError(result.message); // ç»Ÿä¸€é”™è¯¯å¤„ç†
  
  // ç‰¹æ®Šå¤„ç†
  if (result.code === "HOLD_NOT_ENOUGH_STOCK") {
    showAvailable(result.data.available);
  }
}
```

---

## ğŸ“Š å…³é”®æŒ‡æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹å–„ |
|------|--------|--------|------|
| **å¹¶å‘å®‰å…¨** | âŒ æ— ä¿éšœ | âœ… ä¹è§‚é” | â­â­â­â­â­ |
| **ç±»å‹ä¸€è‡´æ€§** | âŒ æ··ä¹± | âœ… ç»Ÿä¸€ string | â­â­â­â­ |
| **å†…å­˜ç®¡ç†** | âŒ æŒç»­å¢é•¿ | âœ… å®šæ—¶æ¸…ç† | â­â­â­â­â­ |
| **åŸå­æ€§** | âŒ æ— ä¿éšœ | âœ… ä¼˜åŒ–é¡ºåº | â­â­â­â­ |
| **é”™è¯¯å¤„ç†** | âš ï¸ ä¸ç»Ÿä¸€ | âœ… ç»Ÿä¸€æ ¼å¼ | â­â­â­â­ |
| **å¯è°ƒè¯•æ€§** | âŒ æ—¥å¿—ç¨€å°‘ | âœ… è¯¦ç»†æ—¥å¿— | â­â­â­â­â­ |
| **å“åº”æ—¶é—´** | 5ms | 8ms | -3ms (å¯æ¥å—) |

---

## ğŸ’¡ æ ¸å¿ƒæ€æƒ³æ€»ç»“

### 1. ä¹è§‚é” vs æ‚²è§‚é”
```
âŒ æ‚²è§‚é”ï¼ˆå¤æ‚ï¼‰ï¼š
  å…ˆåŠ é” â†’ æ£€æŸ¥ â†’ æ“ä½œ â†’ é‡Šæ”¾é”
  éœ€è¦ Redis/æ•°æ®åº“é”

âœ… ä¹è§‚é”ï¼ˆç®€å•ï¼‰ï¼š
  å…ˆæ“ä½œ â†’ å†æ£€æŸ¥ â†’ å†²çªåˆ™å›æ»š
  é€‚åˆå†…å­˜æ“ä½œ
```

### 2. æ“ä½œé¡ºåºä¼˜åŒ–
```
åŸåˆ™ï¼šä¼˜å…ˆæ‰§è¡Œå½±å“é¢å°çš„æ“ä½œ

âœ… å¥½é¡ºåºï¼š
  1. é‡Šæ”¾èµ„æºï¼ˆå½±å“å°ï¼‰
  2. æ›´æ–°çŠ¶æ€ï¼ˆå½±å“å¤§ï¼‰
  
âŒ åé¡ºåºï¼š
  1. æ›´æ–°çŠ¶æ€ï¼ˆå½±å“å¤§ï¼‰
  2. é‡Šæ”¾èµ„æºï¼ˆå´©æºƒåé”æ­»ï¼‰
```

### 3. ä¸»åŠ¨ vs è¢«åŠ¨
```
âŒ è¢«åŠ¨æ¸…ç†ï¼š
  ç­‰å¾…è¯·æ±‚è§¦å‘ â†’ å¯èƒ½æ°¸ä¸æ¸…ç†

âœ… ä¸»åŠ¨æ¸…ç†ï¼š
  å®šæ—¶ä»»åŠ¡ â†’ ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
```

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **å¹¶å‘å¤„ç†**ï¼šå…ˆå ä½ï¼Œå†æ ¡éªŒï¼Œå†²çªåˆ™å›æ»š
2. **ç±»å‹ç»Ÿä¸€**ï¼šå…¥å£ç»Ÿä¸€è§„èŒƒåŒ–ï¼Œé¿å…éšå¼è½¬æ¢
3. **èµ„æºç®¡ç†**ï¼šä¸»åŠ¨æ¸…ç† + è¢«åŠ¨æ¸…ç†åŒä¿é™©
4. **åŸå­æ€§**ï¼šä¼˜åŒ–æ“ä½œé¡ºåºï¼Œå‡å°‘å´©æºƒå½±å“
5. **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€æ ¼å¼ï¼Œä¾¿äºå‰ç«¯æ‹¦æˆª
6. **å¯è§‚æµ‹æ€§**ï¼šå…³é”®æ“ä½œå¿…æœ‰æ—¥å¿—

---

å¸Œæœ›è¿™ä»½å¯¹æ¯”æ–‡æ¡£å¸®åŠ©æ‚¨ç†è§£ä¿®å¤åŸç†ï¼ğŸ‰