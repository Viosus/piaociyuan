// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"  // ä» sqlite åˆ‡æ¢åˆ° postgresql
  url      = env("DATABASE_URL")
}

// âœ… æ´»åŠ¨è¡¨
model Event {
  id        Int      @id @default(autoincrement())
  name      String
  city      String
  venue     String
  date      String
  time      String
  cover     String
  artist    String
  desc      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tiers     Tier[]
  badges    Badge[] // æ´»åŠ¨çš„æ•°å­—çºªå¿µå“
  posts     Post[]  // å…³è”çš„å¸–å­

  @@map("events")
}

// âœ… ç¥¨æ¡£è¡¨
model Tier {
  id        Int      @id @default(autoincrement())
  eventId   Int
  name      String
  price     Int
  capacity  Int
  remaining Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  @@map("tiers")
  @@index([eventId])
}

// âœ… é”ç¥¨è¡¨
model Hold {
  id        String   @id
  eventId   String
  tierId    String
  qty       Int
  expireAt  BigInt
  createdAt BigInt
  
  @@map("holds")
  @@index([eventId, tierId])
  @@index([expireAt])
}

// âœ… è®¢å•è¡¨
model Order {
  id        String   @id
  userId    String   // è®¢å•æ‰€å±ç”¨æˆ·
  eventId   String
  tierId    String
  qty       Int
  holdId    String
  status    String   // pending, paid, cancelled, refunded
  createdAt BigInt
  paidAt    BigInt?

  user       User        @relation(fields: [userId], references: [id], onDelete: Restrict) // æ”¹ä¸º Restrictï¼Œä¸èƒ½ç›´æ¥åˆ é™¤æœ‰è®¢å•çš„ç”¨æˆ·
  tickets    Ticket[]    // è®¢å•åŒ…å«çš„ç¥¨
  userBadges UserBadge[] // è®¢å•ç”Ÿæˆçš„çºªå¿µå“

  @@map("orders")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// âœ… ç¥¨è¡¨ï¼ˆæ¯å¼ ç¥¨éƒ½æ˜¯ç‹¬ç«‹å®ä½“ï¼‰
model Ticket {
  id          String   @id @default(uuid())
  ticketCode  String   @unique  // ç¥¨å·ï¼ˆäºŒç»´ç /æ¡å½¢ç ï¼‰
  eventId     Int
  tierId      Int
  holdId      String?  // é”ç¥¨IDï¼ˆä¸´æ—¶æŒæœ‰ï¼Œå¯ä¸ºç©ºï¼‰
  orderId     String?  // æ‰€å±è®¢å•ï¼ˆå¯ä¸ºç©ºï¼Œåº“å­˜ä¸­çš„ç¥¨æ²¡æœ‰è®¢å•ï¼‰
  userId      String?  // æ‰€å±ç”¨æˆ·ï¼ˆå¯ä¸ºç©ºï¼Œåº“å­˜ä¸­çš„ç¥¨æ²¡æœ‰ç”¨æˆ·ï¼‰
  status      String   // available, locked, sold, used, refunded
  price       Int      // è´­ä¹°æ—¶çš„ä»·æ ¼

  purchasedAt DateTime? // è´­ä¹°æ—¶é—´
  usedAt      DateTime? // ä½¿ç”¨æ—¶é—´
  refundedAt  DateTime? // é€€æ¬¾æ—¶é—´
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // å…³è”
  order       Order?      @relation(fields: [orderId], references: [id], onDelete: SetNull)
  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull) // SetNullï¼šåˆ é™¤ç”¨æˆ·æ—¶ç¥¨å›åˆ°åº“å­˜
  userBadges  UserBadge[] // è¿™å¼ ç¥¨ç”Ÿæˆçš„çºªå¿µå“

  @@map("tickets")
  @@index([eventId])
  @@index([tierId])
  @@index([holdId])
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([ticketCode])
}

// âœ… ç”¨æˆ·è¡¨
model User {
  id            String   @id @default(uuid())
  email         String?  @unique
  phone         String?  @unique
  password      String?  // æœ¬åœ°ç™»å½•å¯†ç ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
  nickname      String?
  avatar        String?

  // ç¬¬ä¸‰æ–¹ç™»å½•å­—æ®µ
  wechatOpenId  String?  @unique
  qqOpenId      String?  @unique

  // ç™»å½•æ–¹å¼æ ‡è¯†
  authProvider  String   @default("local") // local, wechat, qq

  // ç”¨æˆ·è§’è‰²æƒé™
  role          String   @default("user") // user(æ™®é€šç”¨æˆ·), staff(å·¥ä½œäººå‘˜), admin(ç®¡ç†å‘˜)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // å…³è”
  orders        Order[]        // ç”¨æˆ·çš„è®¢å•
  tickets       Ticket[]       // ç”¨æˆ·çš„ç¥¨
  userBadges    UserBadge[]    // ç”¨æˆ·çš„æ•°å­—çºªå¿µå“
  loginLogs     LoginLog[]
  sessions      UserSession[]

  // ç¤¾äº¤ç³»ç»Ÿå…³è”
  posts         Post[]         // ç”¨æˆ·å‘å¸ƒçš„å¸–å­
  likes         PostLike[]     // ç”¨æˆ·ç‚¹èµçš„å¸–å­
  comments      Comment[]      // ç”¨æˆ·çš„è¯„è®º
  sentMessages  Message[]      @relation("SentMessages")  // å‘é€çš„æ¶ˆæ¯
  receivedMessages Message[]   @relation("ReceivedMessages") // æ¥æ”¶çš„æ¶ˆæ¯
  conversations ConversationParticipant[] // å‚ä¸çš„ä¼šè¯

  @@map("users")
  @@index([email])
  @@index([phone])
  @@index([wechatOpenId])
  @@index([qqOpenId])
}

// âœ… ç™»å½•æ—¥å¿—è¡¨
model LoginLog {
  id         String   @id @default(uuid())
  userId     String
  ipAddress  String?
  userAgent  String?
  location   String?  // IPåœ°å€å¯¹åº”çš„åœ°ç†ä½ç½®
  success    Boolean  @default(true)
  failReason String?  // å¤±è´¥åŸå› 
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_logs")
  @@index([userId])
  @@index([createdAt])
  @@index([success])
}

// âœ… ç”¨æˆ·ä¼šè¯è¡¨ï¼ˆç”¨äº Refresh Token ç®¡ç†ï¼‰
model UserSession {
  id            String   @id @default(uuid())
  userId        String
  refreshToken  String   @unique
  deviceInfo    String?  // è®¾å¤‡ä¿¡æ¯ JSON
  ipAddress     String?
  expiresAt     DateTime
  revoked       Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
  @@index([userId])
  @@index([expiresAt])
  @@index([refreshToken])
}

// âœ… éªŒè¯ç è¡¨
model VerificationCode {
  id        String   @id @default(uuid())
  email     String
  code      String
  type      String   @default("register") // register, login, reset_password
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("verification_codes")
  @@index([email, type])
  @@index([expiresAt])
}

// âœ… æ•°å­—çºªå¿µå“è¡¨ï¼ˆå¾½ç« ã€ç¥¨æ ¹ç­‰ï¼‰
model Badge {
  id          String   @id @default(uuid())
  eventId     Int      // æ‰€å±æ´»åŠ¨
  tierId      Int?     // æ‰€å±ç¥¨æ¡£ï¼ˆå¯é€‰ï¼Œæœ‰äº›çºªå¿µå“æ˜¯æ´»åŠ¨çº§åˆ«çš„ï¼‰
  name        String   // çºªå¿µå“åç§°
  description String   @db.Text // æè¿°
  imageUrl    String   // 2Då›¾ç‰‡URL
  rarity      String   @default("common") // ç¨€æœ‰åº¦: common, rare, epic, legendary
  type        String   @default("badge") // ç±»å‹: badge(å¾½ç« ), ticket_stub(ç¥¨æ ¹), certificate(è¯ä¹¦), poster(æµ·æŠ¥)
  isActive    Boolean  @default(true) // æ˜¯å¦å¯ç”¨

  // ğŸ¨ 3D/AR ç›¸å…³å­—æ®µ
  has3DModel  Boolean  @default(false) // æ˜¯å¦æœ‰3Dæ¨¡å‹
  model3DUrl  String?  // 3Dæ¨¡å‹æ–‡ä»¶URL (glb/gltfæ ¼å¼)
  modelFormat String?  // æ¨¡å‹æ ¼å¼: glb, gltf, usdzç­‰
  hasAR       Boolean  @default(false) // æ˜¯å¦æ”¯æŒAR
  arUrl       String?  // ARå¿«é€ŸæŸ¥çœ‹URL (iOS Quick Look / Android Scene Viewer)

  // ğŸ¬ åŠ¨ç”»ç›¸å…³
  hasAnimation Boolean @default(false) // æ˜¯å¦æœ‰åŠ¨ç”»
  animationUrl String? // åŠ¨ç”»æ–‡ä»¶URL

  // ğŸ“ 3Dæ¨¡å‹é…ç½® (JSONæ ¼å¼)
  modelConfig  String? @db.Text // æ¨¡å‹é…ç½®: åˆå§‹ä½ç½®ã€ç¼©æ”¾ã€æ—‹è½¬ã€ç¯å…‰ç­‰

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // å…³è”
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userBadges  UserBadge[] // è¢«å“ªäº›ç”¨æˆ·æ‹¥æœ‰

  @@map("badges")
  @@index([eventId])
  @@index([tierId])
  @@index([type])
  @@index([rarity])
  @@index([has3DModel])
  @@index([hasAR])
}

// âœ… ç”¨æˆ·æ‹¥æœ‰çš„çºªå¿µå“ï¼ˆä¸­é—´è¡¨ï¼Œè®°å½•ç”¨æˆ·è·å¾—çºªå¿µå“çš„è¯¦æƒ…ï¼‰
model UserBadge {
  id          String   @id @default(uuid())
  userId      String   // ç”¨æˆ·ID
  badgeId     String   // çºªå¿µå“ID
  ticketId    String?  // é€šè¿‡å“ªå¼ ç¥¨è·å¾—ï¼ˆå¯é€‰ï¼‰
  orderId     String?  // é€šè¿‡å“ªä¸ªè®¢å•è·å¾—ï¼ˆå¯é€‰ï¼‰
  obtainedAt  DateTime @default(now()) // è·å¾—æ—¶é—´
  metadata    String?  @db.Text // JSONæ ¼å¼çš„é¢å¤–æ•°æ®ï¼ˆå¦‚åº§ä½å·ã€åºåˆ—å·ç­‰ï¼‰

  // å…³è”
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge       Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  ticket      Ticket?  @relation(fields: [ticketId], references: [id], onDelete: SetNull)
  order       Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@map("user_badges")
  @@unique([userId, badgeId, ticketId]) // åŒä¸€ä¸ªç”¨æˆ·+çºªå¿µå“+ç¥¨çš„ç»„åˆå”¯ä¸€
  @@index([userId])
  @@index([badgeId])
  @@index([ticketId])
  @@index([orderId])
  @@index([obtainedAt])
}

// ==================== ç¤¾äº¤ç³»ç»Ÿ ====================

// âœ… å¸–å­è¡¨ï¼ˆå®‰å¯åŒºå†…å®¹ï¼‰
model Post {
  id          String   @id @default(uuid())
  userId      String   // å‘å¸ƒè€…ID
  content     String   @db.Text  // å¸–å­å†…å®¹
  eventId     Int?     // å…³è”çš„æ´»åŠ¨ï¼ˆå¯é€‰ï¼‰
  location    String?  // åœ°ç‚¹æ ‡ç­¾
  viewCount   Int      @default(0) // æµè§ˆæ¬¡æ•°
  likeCount   Int      @default(0) // ç‚¹èµæ•°
  commentCount Int     @default(0) // è¯„è®ºæ•°
  isVisible   Boolean  @default(true) // æ˜¯å¦å¯è§ï¼ˆè½¯åˆ é™¤ï¼‰
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // å…³è”
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  event       Event?     @relation(fields: [eventId], references: [id], onDelete: SetNull)
  images      PostImage[] // å¸–å­å›¾ç‰‡
  likes       PostLike[]  // ç‚¹èµ
  comments    Comment[]   // è¯„è®º

  @@map("posts")
  @@index([userId])
  @@index([eventId])
  @@index([createdAt])
  @@index([likeCount])
  @@index([isVisible])
}

// âœ… å¸–å­å›¾ç‰‡è¡¨
model PostImage {
  id        String   @id @default(uuid())
  postId    String   // æ‰€å±å¸–å­
  imageUrl  String   // å›¾ç‰‡URL
  width     Int?     // å›¾ç‰‡å®½åº¦ï¼ˆç”¨äºç€‘å¸ƒæµå¸ƒå±€ï¼‰
  height    Int?     // å›¾ç‰‡é«˜åº¦
  order     Int      @default(0) // æ˜¾ç¤ºé¡ºåº
  createdAt DateTime @default(now())

  // å…³è”
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("post_images")
  @@index([postId])
  @@index([order])
}

// âœ… ç‚¹èµè¡¨
model PostLike {
  id        String   @id @default(uuid())
  postId    String   // å¸–å­ID
  userId    String   // ç”¨æˆ·ID
  createdAt DateTime @default(now())

  // å…³è”
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("post_likes")
  @@unique([postId, userId]) // æ¯ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡
  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}

// âœ… è¯„è®ºè¡¨
model Comment {
  id        String   @id @default(uuid())
  postId    String   // å¸–å­ID
  userId    String   // è¯„è®ºè€…ID
  content   String   @db.Text  // è¯„è®ºå†…å®¹
  parentId  String?  // çˆ¶è¯„è®ºIDï¼ˆç”¨äºå›å¤åŠŸèƒ½ï¼‰
  likeCount Int      @default(0) // ç‚¹èµæ•°
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³è”
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies") // å­è¯„è®º

  @@map("comments")
  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
}

// ==================== ç§èŠç³»ç»Ÿ ====================

// âœ… ä¼šè¯è¡¨
model Conversation {
  id          String   @id @default(uuid())
  lastMessageAt DateTime @default(now()) // æœ€åæ¶ˆæ¯æ—¶é—´ï¼ˆç”¨äºæ’åºï¼‰
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // å…³è”
  participants ConversationParticipant[] // ä¼šè¯å‚ä¸è€…
  messages     Message[] // ä¼šè¯æ¶ˆæ¯

  @@map("conversations")
  @@index([lastMessageAt])
}

// âœ… ä¼šè¯å‚ä¸è€…è¡¨ï¼ˆæ”¯æŒç¾¤èŠæ‰©å±•ï¼‰
model ConversationParticipant {
  id             String   @id @default(uuid())
  conversationId String   // ä¼šè¯ID
  userId         String   // ç”¨æˆ·ID
  unreadCount    Int      @default(0) // æœªè¯»æ¶ˆæ¯æ•°
  lastReadAt     DateTime @default(now()) // æœ€åé˜…è¯»æ—¶é—´
  joinedAt       DateTime @default(now())

  // å…³è”
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("conversation_participants")
  @@unique([conversationId, userId]) // æ¯ä¸ªç”¨æˆ·åœ¨ä¸€ä¸ªä¼šè¯ä¸­åªèƒ½æœ‰ä¸€æ¡è®°å½•
  @@index([conversationId])
  @@index([userId])
}

// âœ… æ¶ˆæ¯è¡¨
model Message {
  id             String   @id @default(uuid())
  conversationId String   // æ‰€å±ä¼šè¯
  senderId       String   // å‘é€è€…ID
  receiverId     String   // æ¥æ”¶è€…ID
  content        String   @db.Text // æ¶ˆæ¯å†…å®¹
  messageType    String   @default("text") // æ¶ˆæ¯ç±»å‹ï¼štext, image, link
  isRead         Boolean  @default(false) // æ˜¯å¦å·²è¯»
  createdAt      DateTime @default(now())

  // å…³è”
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver       User         @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
  @@index([conversationId])
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@index([isRead])
}