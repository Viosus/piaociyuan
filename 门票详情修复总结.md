# 门票详情修复总结

## 问题描述

用户报告门票详情页面无法正常显示，可能是因为活动比较老旧，数据格式不对。

## 问题根源

经过检查发现以下问题：

### 1. **门票详情API不存在** ❌

前端调用 `GET /api/tickets/[id]`，但后端没有实现这个API！

**前端代码**：
```typescript
// apps/mobile/src/services/tickets.ts
export async function getTicketDetail(ticketId: string | number) {
  return apiClient.get<Ticket>(`/api/tickets/${ticketId}`, {
    cache: false,
  });
}
```

**后端缺失**：
- 没有 `apps/web/app/api/tickets/[id]/route.ts` 文件
- API调用返回 404

### 2. **类型定义不匹配** ❌

前端的 Ticket 类型定义与数据库不一致：

**前端类型**（错误）：
```typescript
export interface Ticket {
  id: number;        // ❌ 数据库是 text (UUID)
  userId: number;    // ❌ 数据库是 text
  orderId: number;   // ❌ 数据库是 text
  // ...
}
```

**数据库实际**：
```sql
id         | text
userId     | text
orderId    | text
createdAt  | timestamp(3)
usedAt     | timestamp(3)
```

### 3. **日期处理错误** ❌

前端代码假设时间戳是数字，但实际是ISO字符串：

**错误代码**：
```typescript
formatDateTime(new Date(Number(ticket.createdAt)))
```

这会导致：
- `Number("2025-12-16T10:00:00.000Z")` = `NaN`
- `new Date(NaN)` = `Invalid Date`
- 页面显示异常

## 修复内容

### 1. 创建门票详情API ✅

**文件**：`apps/web/app/api/tickets/[id]/route.ts`

**功能**：
- 根据票ID查询门票信息
- 验证门票所有权（只能查看自己的票）
- 关联查询活动和票档信息
- 返回完整的门票详情

**代码实现**：
```typescript
export async function GET(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  // 1. 认证
  const payload = verifyToken(token);
  const userId = payload.id;
  const { id: ticketId } = await params;

  // 2. 查询门票
  const ticket = await prisma.ticket.findUnique({
    where: { id: ticketId },
    include: { order: { select: { /* ... */ } } },
  });

  // 3. 验证所有权
  if (ticket.userId !== userId) {
    return NextResponse.json({ ok: false, code: 'FORBIDDEN' }, { status: 403 });
  }

  // 4. 查询关联信息
  const [event, tier] = await Promise.all([
    prisma.event.findUnique({ where: { id: ticket.eventId } }),
    prisma.tier.findUnique({ where: { id: ticket.tierId } }),
  ]);

  // 5. 返回格式化数据
  return NextResponse.json({
    ok: true,
    data: {
      id: ticket.id,
      ticketCode: ticket.ticketCode,
      // 时间字段转为ISO字符串
      createdAt: ticket.createdAt.toISOString(),
      usedAt: ticket.usedAt?.toISOString(),
      refundedAt: ticket.refundedAt?.toISOString(),
      event: { /* ... */ },
      tier: { /* ... */ },
    },
  });
}
```

### 2. 修复类型定义 ✅

**文件**：`apps/mobile/src/services/tickets.ts`

**修改**：
```typescript
export interface Ticket {
  id: string;              // ✅ 改为 string
  ticketCode: string;
  eventId: number;
  tierId: number;
  userId?: string;         // ✅ 改为 string | undefined
  orderId?: string;        // ✅ 改为 string | undefined
  seatNumber?: string;
  price: number;
  status: 'available' | 'sold' | 'used' | 'refunded';
  purchasedAt?: string;    // ✅ 新增
  usedAt?: string;
  refundedAt?: string;
  createdAt: string;       // ✅ ISO 字符串
  updatedAt: string;
  event?: {
    id: number;
    name: string;
    city?: string;         // ✅ 新增
    venue: string;
    date?: string;         // ✅ 新增
    time?: string;         // ✅ 新增
    startTime?: string;
    cover?: string;        // ✅ 新增
    coverImage?: string;
  };
  tier?: {
    id: number;
    name: string;
    price: number;
  };
}
```

### 3. 修复日期处理 ✅

**文件**：`apps/mobile/src/screens/TicketDetailScreen.tsx`

**修改前**：
```typescript
formatDateTime(new Date(Number(ticket.createdAt)))  // ❌ 错误
formatDateTime(new Date(Number(ticket.usedAt)))     // ❌ 错误
```

**修改后**：
```typescript
// 购买时间：优先使用 purchasedAt，否则使用 createdAt
{ticket.purchasedAt
  ? formatDateTime(new Date(ticket.purchasedAt))
  : formatDateTime(new Date(ticket.createdAt))}

// 使用时间
{ticket.usedAt && formatDateTime(new Date(ticket.usedAt))}

// 退票时间
{ticket.refundedAt && formatDateTime(new Date(ticket.refundedAt))}
```

### 4. 改进票列表API ✅

**文件**：`apps/web/app/api/tickets/my-tickets/route.ts`

**改进**：
- 返回完整的字段（eventId, tierId, userId, orderId, seatNumber）
- 时间字段统一转为ISO字符串格式
- 添加 tier.price 字段

**修改**：
```typescript
return {
  id: ticket.id,
  ticketCode: ticket.ticketCode,
  eventId: ticket.eventId,          // ✅ 新增
  tierId: ticket.tierId,            // ✅ 新增
  userId: ticket.userId,            // ✅ 新增
  orderId: ticket.orderId,          // ✅ 新增
  seatNumber: ticket.seatNumber,    // ✅ 新增
  status: ticket.status,
  price: ticket.price,
  purchasedAt: ticket.purchasedAt?.toISOString(),  // ✅ ISO格式
  usedAt: ticket.usedAt?.toISOString(),            // ✅ ISO格式
  refundedAt: ticket.refundedAt?.toISOString(),    // ✅ ISO格式
  createdAt: ticket.createdAt.toISOString(),       // ✅ ISO格式
  updatedAt: ticket.updatedAt.toISOString(),       // ✅ ISO格式
  event: event ? { /* ... */ } : null,
  tier: tier ? {
    id: tier.id,
    name: tier.name,
    price: tier.price,  // ✅ 新增
  } : null,
};
```

## 修复效果

修复后，门票详情功能应该能够：

### ✅ 正常加载门票详情
- API正常返回数据
- 不再出现404错误

### ✅ 正确显示时间信息
- 购买时间正确显示
- 使用时间正确显示（如果已使用）
- 退票时间正确显示（如果已退票）

### ✅ 完整的门票信息
- 二维码正确显示
- 票码、价格、状态正确
- 活动和票档信息完整

### ✅ 类型安全
- TypeScript类型检查通过
- 前后端数据格式一致

## 测试建议

### 1. 基本功能测试
- [ ] 打开票夹
- [ ] 点击任意门票
- [ ] 查看门票详情是否正确显示
- [ ] 检查二维码是否能正常生成

### 2. 时间显示测试
- [ ] 检查购买时间是否正确
- [ ] 检查未使用的票是否只显示购买时间
- [ ] 使用一张票，检查使用时间是否显示
- [ ] 退一张票，检查退票时间是否显示

### 3. 功能测试
- [ ] 点击二维码能否放大查看
- [ ] 分享功能是否正常
- [ ] 转让/赠送按钮是否正常
- [ ] 退票功能是否正常

### 4. 边界情况测试
- [ ] 查看很久以前的门票（老数据）
- [ ] 查看不同状态的门票（未使用、已使用、已退票）
- [ ] 查看不同活动的门票

## 相关文件

### 新建文件：
1. `apps/web/app/api/tickets/[id]/route.ts` - 门票详情API（新建）

### 修改的文件：
1. `apps/mobile/src/services/tickets.ts` - Ticket类型定义
2. `apps/mobile/src/screens/TicketDetailScreen.tsx` - 日期处理
3. `apps/web/app/api/tickets/my-tickets/route.ts` - 票列表API

## 数据格式说明

### 后端返回格式（统一）：

```json
{
  "ok": true,
  "data": {
    "id": "uuid-string",
    "ticketCode": "TKT-20251216-XXXX",
    "eventId": 1,
    "tierId": 1,
    "userId": "uuid-string",
    "price": 380,
    "status": "sold",
    "createdAt": "2025-12-16T10:00:00.000Z",
    "purchasedAt": "2025-12-16T10:05:00.000Z",
    "usedAt": null,
    "refundedAt": null,
    "event": {
      "id": 1,
      "name": "周杰伦演唱会",
      "city": "北京",
      "venue": "鸟巢",
      "date": "2025-11-12",
      "time": "19:30",
      "cover": "https://..."
    },
    "tier": {
      "id": 1,
      "name": "VIP区",
      "price": 1280
    }
  }
}
```

### 时间字段格式：
- **后端**：ISO 8601 字符串格式 `"2025-12-16T10:00:00.000Z"`
- **前端**：使用 `new Date(isoString)` 解析
- **显示**：使用 `formatDateTime()` 格式化

## 总结

门票详情功能的问题已经完全修复：

1. ✅ **创建了缺失的API** - `/api/tickets/[id]`
2. ✅ **修复了类型定义** - ID字段从 number 改为 string
3. ✅ **修复了日期处理** - 使用ISO字符串而不是数字时间戳
4. ✅ **统一了数据格式** - 前后端数据格式完全一致

现在用户应该能够：
- 正常查看门票详情
- 看到正确的时间信息
- 使用所有门票功能（查看、分享、转让、退票）

不论门票是新的还是旧的，都应该能够正常显示！
