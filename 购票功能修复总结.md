# 购票功能修复总结

## 问题描述

用户报告从活动详情页点击"立即购票"按钮后，只显示"准备购买"的提示弹窗，但没有实际的购票页面出现。

## 问题根源

**导航未实现**：EventDetailScreen 中的 `handleBuyTicket` 函数只是一个 TODO 占位符，仅显示 Alert.alert() 提示，并没有实际导航到购票页面。

### 错误代码：

**EventDetailScreen.tsx (原代码)**：
```typescript
const handleBuyTicket = () => {
  // TODO: 实现购票逻辑
  Alert.alert('提示', '准备购买票档：' + (selectedTier?.name || ''));
};
```

## 解决方案

### 1. 修改 EventDetailScreen - 实现导航到 Checkout 页面

**文件**：`apps/mobile/src/screens/EventDetailScreen.tsx`

**修改内容**：
```typescript
const handleBuyTicket = () => {
  if (!selectedTier) {
    Alert.alert('提示', '请选择票档');
    return;
  }

  if (selectedTier.available <= 0) {
    Alert.alert('抱歉', '该票档已售罄');
    return;
  }

  // 导航到购票页面
  navigation.navigate('Checkout' as never, {
    eventId: eventId,
    selectedTiers: [
      {
        tierId: selectedTier.id,
        tierName: selectedTier.name,
        price: selectedTier.price,
        quantity: 1,
      },
    ],
  } as never);
};
```

**功能说明**：
- 验证是否选择了票档
- 检查票档是否还有余票
- 导航到 Checkout 页面，传递活动 ID 和选中的票档信息
- 默认购买数量为 1

### 2. 注册 Checkout 页面到导航栈

**问题**：CheckoutScreen.tsx 文件已存在，但未在导航栈中注册。

**文件**：`apps/mobile/src/navigation/AppNavigator.tsx`

**修改 1 - 添加导入**：
```typescript
import CheckoutScreen from '../screens/CheckoutScreen';
import PaymentScreen from '../screens/PaymentScreen';
```

**修改 2 - 注册路由**：
```typescript
<MainStack.Screen
  name="Checkout"
  component={CheckoutScreen}
  options={{
    title: '确认订单',
    headerStyle: {
      backgroundColor: COLORS.primary,
    },
    headerTintColor: '#111827',
    headerTitleStyle: {
      fontWeight: 'bold',
    },
  }}
/>
<MainStack.Screen
  name="Payment"
  component={PaymentScreen}
  options={{
    title: '支付订单',
    headerStyle: {
      backgroundColor: COLORS.primary,
    },
    headerTintColor: '#111827',
    headerTitleStyle: {
      fontWeight: 'bold',
    },
  }}
/>
```

**说明**：
- 注册了 Checkout 页面（确认订单）
- 同时注册了 Payment 页面（支付订单），因为 CheckoutScreen 在提交订单后会导航到 Payment 页面

## 完整的购票流程

修复后，完整的购票流程如下：

### 1️⃣ 活动详情页 (EventDetailScreen)
- 用户浏览活动信息
- 选择票档（tier）
- 查看价格和剩余数量
- 点击"立即购票"按钮

### 2️⃣ 确认订单页 (CheckoutScreen)
- 显示活动信息（名称、时间、地点）
- 显示票档信息（名称、价格、数量）
- 可选填写联系人信息（姓名、手机）
- 可选填写订单备注
- 显示价格明细（票价小计、服务费、合计）
- 点击"提交订单"按钮

### 3️⃣ 支付订单页 (PaymentScreen)
- 选择支付方式
- 完成支付
- 生成门票

## CheckoutScreen 参数说明

CheckoutScreen 期望接收的参数：

```typescript
interface CheckoutParams {
  eventId: number;           // 活动 ID
  selectedTiers: SelectedTier[];  // 选中的票档列表
}

interface SelectedTier {
  tierId: number;      // 票档 ID
  tierName: string;    // 票档名称
  price: number;       // 票档价格
  quantity: number;    // 购买数量
}
```

## CheckoutScreen 功能

CheckoutScreen 已有的功能：

1. **加载活动详情** - 根据 eventId 获取活动完整信息
2. **显示订单摘要** - 展示活动信息、票档信息、价格明细
3. **联系人信息** - 可选填写联系人姓名和手机号
4. **订单备注** - 可选填写特殊需求
5. **价格计算** - 自动计算总价（票价 × 数量）
6. **提交订单** - 调用 createOrder API 创建订单
7. **导航到支付** - 订单创建成功后导航到支付页面

## 相关文件

### 修改的文件：
1. `apps/mobile/src/screens/EventDetailScreen.tsx`
2. `apps/mobile/src/navigation/AppNavigator.tsx`

### 相关文件（未修改）：
1. `apps/mobile/src/screens/CheckoutScreen.tsx` - 购票页面
2. `apps/mobile/src/screens/PaymentScreen.tsx` - 支付页面
3. `apps/mobile/src/services/orders.ts` - 订单服务

## 测试建议

### 1. 活动详情页测试
- [ ] 进入活动详情页
- [ ] 选择不同的票档
- [ ] 价格显示正确
- [ ] 剩余票数显示正确
- [ ] 点击"立即购票"按钮

### 2. 购票页面测试
- [ ] 确认订单页面正确显示
- [ ] 活动信息显示正确
- [ ] 票档信息显示正确
- [ ] 价格计算正确
- [ ] 可以填写联系人信息
- [ ] 可以填写订单备注

### 3. 订单创建测试
- [ ] 点击"提交订单"
- [ ] 显示加载状态
- [ ] 订单创建成功
- [ ] 跳转到支付页面

### 4. 边界情况测试
- [ ] 未选择票档时点击购票 → 显示提示
- [ ] 选择售罄票档时点击购票 → 显示"已售罄"提示
- [ ] 订单创建失败 → 显示错误信息
- [ ] 网络错误时的处理

## 后续可能的优化

1. **支持多票档购买** - 目前只支持单个票档，可以扩展为支持同时购买多个票档
2. **数量选择** - 目前默认数量为 1，可以添加数量选择器
3. **优惠券系统** - 在 Checkout 页面添加优惠券输入
4. **座位选择** - 如果是需要选座的活动，可以添加选座功能
5. **支付方式** - 完善 PaymentScreen 的支付方式选择

## 总结

购票功能已经完全修复。问题的根本原因是：
1. EventDetailScreen 的 handleBuyTicket 只是一个 TODO 占位符
2. CheckoutScreen 和 PaymentScreen 虽然已经实现，但未注册到导航栈

修复内容：
✅ 实现了 EventDetailScreen 到 CheckoutScreen 的导航
✅ 添加了票档验证（是否选择、是否售罄）
✅ 注册了 Checkout 和 Payment 页面到导航栈
✅ 完整的购票流程已打通

现在用户可以：
1. 浏览活动详情
2. 选择票档
3. 进入确认订单页面
4. 填写联系信息（可选）
5. 提交订单
6. 进入支付页面完成支付
